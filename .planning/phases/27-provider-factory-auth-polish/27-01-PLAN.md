---
phase: 27-provider-factory-auth-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/provider/providerFactory.ts
  - server/src/orchestrator/index.ts
  - server/src/app.ts
  - server/src/index.ts
autonomous: true
requirements: [PROV-04, PROV-05, CONF-04, CONF-05, COMPAT-02]

must_haves:
  truths:
    - "Setting LLM_PROVIDER=openai + OPENAI_API_KEY + AUTH_REQUIRED=false starts the server with no other env vars"
    - "Setting LLM_PROVIDER=copilot produces behavior identical to v1.6 baseline"
    - "GET /health response includes provider and model fields showing the active backend"
    - "shared/ and client/ directories have zero modified files"
    - "The factory imports only the selected provider's SDK at runtime"
  artifacts:
    - path: "server/src/provider/providerFactory.ts"
      provides: "Config-driven provider factory with dynamic imports"
      exports: ["createProvider", "getProviderInfo"]
    - path: "server/src/orchestrator/index.ts"
      provides: "Async orchestrator initialization using factory"
      exports: ["initOrchestrator", "getOrchestrator"]
    - path: "server/src/app.ts"
      provides: "Health endpoint with provider and model fields"
      contains: "provider"
  key_links:
    - from: "server/src/provider/providerFactory.ts"
      to: "server/src/config.ts"
      via: "config.LLM_PROVIDER switch"
      pattern: "config\\.LLM_PROVIDER"
    - from: "server/src/provider/providerFactory.ts"
      to: "server/src/provider/OpenAiProvider.ts"
      via: "dynamic import"
      pattern: "import\\("
    - from: "server/src/provider/providerFactory.ts"
      to: "server/src/provider/CopilotProvider.ts"
      via: "dynamic import"
      pattern: "import\\("
    - from: "server/src/orchestrator/index.ts"
      to: "server/src/provider/providerFactory.ts"
      via: "createProvider() call"
      pattern: "createProvider"
    - from: "server/src/app.ts"
      to: "server/src/provider/providerFactory.ts"
      via: "getProviderInfo() for health endpoint"
      pattern: "getProviderInfo"
---

<objective>
Wire config-driven backend selection so LLM_PROVIDER determines which provider runs at startup, with lazy-loading of only the selected provider's SDK and health endpoint reporting.

Purpose: Config alone determines which backend runs — switching providers requires no code changes, and the health endpoint surfaces the active provider for operator observability.
Output: providerFactory.ts, updated orchestrator/index.ts, enhanced health endpoint, updated startup logging
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-openai-provider-implementation/26-01-SUMMARY.md
@server/src/provider/LlmProvider.ts
@server/src/provider/OpenAiProvider.ts
@server/src/provider/CopilotProvider.ts
@server/src/orchestrator/index.ts
@server/src/orchestrator/WorkflowOrchestrator.ts
@server/src/app.ts
@server/src/config.ts
@server/src/copilot.ts
@server/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider factory with dynamic imports</name>
  <files>server/src/provider/providerFactory.ts</files>
  <action>
Create `server/src/provider/providerFactory.ts` that exports:

1. `createProvider(): Promise<LlmProvider>` — reads `config.LLM_PROVIDER` and uses dynamic `import()` to lazy-load only the selected provider:
   - When `config.LLM_PROVIDER === 'openai'`:
     - `const { OpenAiProvider } = await import('./OpenAiProvider.js');`
     - `return new OpenAiProvider({ apiKey: config.OPENAI_API_KEY!, model: config.OPENAI_MODEL });`
   - When `config.LLM_PROVIDER === 'copilot'`:
     - `const { copilotClient } = await import('../copilot.js');`
     - `const { CopilotProvider } = await import('./CopilotProvider.js');`
     - `return new CopilotProvider(copilotClient);`
   - This ensures the Copilot SDK (`@microsoft/agents-copilotstudio-client`) is never imported when `LLM_PROVIDER=openai`, and the OpenAI SDK is never imported when `LLM_PROVIDER=copilot`.

2. `getProviderInfo(): { provider: string; model: string }` — returns the active provider name and model:
   - When `config.LLM_PROVIDER === 'openai'`: `{ provider: 'openai', model: config.OPENAI_MODEL }`
   - When `config.LLM_PROVIDER === 'copilot'`: `{ provider: 'copilot', model: 'copilot-studio' }`
   - This is a synchronous function that reads config values — no async needed since it doesn't load SDKs.

Import only `config` from `../config.js` and `LlmProvider` type from `./LlmProvider.js` at the top level — no provider-specific imports at module scope.

Log provider selection at factory call time: `console.log(\`[provider] Creating ${config.LLM_PROVIDER} provider\`);`

PROV-04, PROV-05
  </action>
  <verify>
    <automated>cd /Users/zycroft/Documents/PA/aaae && npx tsc --noEmit --project server/tsconfig.json 2>&1 | head -30</automated>
    <manual>Verify providerFactory.ts has no top-level imports from CopilotProvider, OpenAiProvider, copilot.ts, or openai SDK</manual>
  </verify>
  <done>providerFactory.ts exists with createProvider() using dynamic imports and getProviderInfo() returning active provider metadata. No provider-specific imports at module scope.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor orchestrator index to use factory + enhance health endpoint</name>
  <files>server/src/orchestrator/index.ts, server/src/app.ts, server/src/index.ts</files>
  <action>
**A) Refactor `server/src/orchestrator/index.ts`:**

Replace the current synchronous singleton pattern with an async factory pattern:

- Remove the top-level imports of `copilotClient` from `../copilot.js` and `CopilotProvider` from `../provider/CopilotProvider.js`
- Import `createProvider` from `../provider/providerFactory.js` instead
- Keep the store and lock imports (they are provider-agnostic)
- Create a module-level `let orchestrator: WorkflowOrchestrator | null = null;`
- Export an `async function initOrchestrator(): Promise<void>` that:
  1. Calls `const provider = await createProvider();`
  2. Creates the WorkflowOrchestrator with the provider
  3. Assigns to the module-level variable
  4. Logs: `console.log('[orchestrator] Initialized with provider');`
- Export a `function getOrchestrator(): WorkflowOrchestrator` that:
  1. Throws if orchestrator is null: `throw new Error('Orchestrator not initialized — call initOrchestrator() first');`
  2. Returns the orchestrator
- Keep the existing type exports unchanged

**B) Update route imports:**

In `server/src/routes/chat.ts`, change `import { orchestrator } from '../orchestrator/index.js';` to `import { getOrchestrator } from '../orchestrator/index.js';`. In each route handler, call `const orchestrator = getOrchestrator();` at the start of the handler function (not at module scope). This ensures the orchestrator is accessed after initialization.

Do the same for `server/src/routes/orchestrate.ts` if it imports from orchestrator/index.ts (check first — it currently imports `copilotClient` directly from copilot.ts, leave that as-is since it's a legacy Copilot-only endpoint that will be addressed in Phase 28).

**C) Update `server/src/app.ts` health endpoint:**

Add `provider` and `model` fields to the GET /health response by importing `getProviderInfo` from `./provider/providerFactory.js`:

```typescript
import { getProviderInfo } from './provider/providerFactory.js';

// In the health handler:
const providerInfo = getProviderInfo();
res.json({
  status: 'ok',
  provider: providerInfo.provider,
  model: providerInfo.model,
  authRequired: config.AUTH_REQUIRED,
  redis: redisStatus,
});
```

CONF-05

**D) Update `server/src/index.ts` startup:**

Add async initialization before `app.listen()`:

```typescript
import { initOrchestrator } from './orchestrator/index.js';

// ... existing imports ...

async function main() {
  await initOrchestrator();
  const app = createApp();
  app.listen(config.PORT, () => {
    console.log(`[server] Running on http://localhost:${config.PORT}`);
    console.log(`[server] Auth required: ${config.AUTH_REQUIRED}`);
    console.log(`[server] CORS origin: ${config.CORS_ORIGIN}`);
    console.log(`[server] Provider: ${config.LLM_PROVIDER}`);
  });
}

main().catch((err) => {
  console.error('[server] Failed to start:', err);
  process.exit(1);
});
```

CONF-04

**Important constraints:**
- Do NOT modify any files in `shared/` or `client/` — COMPAT-02
- Do NOT modify `server/src/copilot.ts` — it stays as-is, only loaded via dynamic import when needed
- Do NOT modify `server/src/provider/CopilotProvider.ts` or `OpenAiProvider.ts`
- The `routes/orchestrate.ts` file imports `copilotClient` directly — leave it as-is for now (it's a legacy Copilot-only endpoint, Phase 28 will address test coverage)
  </action>
  <verify>
    <automated>cd /Users/zycroft/Documents/PA/aaae && npx tsc --noEmit --project server/tsconfig.json 2>&1 | head -30 && npm test --workspace=server 2>&1 | tail -20</automated>
    <manual>Verify GET /health now includes provider and model fields, and shared/ + client/ have zero changes (git diff --name-only shared/ client/)</manual>
  </verify>
  <done>Orchestrator uses factory-created provider via async init. Health endpoint returns provider and model fields. Server starts via async main(). Routes use getOrchestrator(). All existing tests pass. shared/ and client/ unchanged.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles cleanly: `cd server && npx tsc --noEmit`
2. All server tests pass: `npm test --workspace=server`
3. No changes to shared/ or client/: `git diff --name-only shared/ client/` returns empty
4. providerFactory.ts has no top-level imports from CopilotProvider, OpenAiProvider, copilot.ts, or openai
5. orchestrator/index.ts has no import from copilot.ts or CopilotProvider
6. Health endpoint includes provider + model fields (inspect app.ts code)
</verification>

<success_criteria>
- [ ] providerFactory.ts exists with createProvider() and getProviderInfo()
- [ ] Dynamic imports used for both provider paths (no top-level SDK imports)
- [ ] orchestrator/index.ts uses factory instead of hardcoded CopilotProvider
- [ ] Routes use getOrchestrator() instead of module-level orchestrator
- [ ] Health endpoint returns { status, provider, model, authRequired, redis }
- [ ] Server startup is async with initOrchestrator() before listen()
- [ ] TypeScript compiles cleanly
- [ ] All server tests pass
- [ ] shared/ and client/ have zero changes
</success_criteria>

<output>
After completion, create `.planning/phases/27-provider-factory-auth-polish/27-01-SUMMARY.md`
</output>
