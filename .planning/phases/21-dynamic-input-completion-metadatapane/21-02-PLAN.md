---
phase: 21-dynamic-input-completion-metadatapane
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - client/src/components/WorkflowComplete.tsx
  - client/src/components/WorkflowComplete.test.tsx
  - client/src/components/chat.css
autonomous: true
requirements: [COMPL-01, COMPL-02, COMPL-03, TEST-03]

must_haves:
  truths:
    - "WorkflowComplete renders a summary card with heading 'Workflow Complete' and collected data as key-value list when workflowState.status is 'completed'"
    - "'Start new conversation' button calls resetConversation to clear state"
    - "'Download summary' button exports collected data as a JSON file download"
    - "collectedData keys are displayed as labels (capitalized, underscores replaced with spaces), values as text"
    - "All WorkflowComplete states pass unit tests: summary rendering, reset button, download button"
  artifacts:
    - path: "client/src/components/WorkflowComplete.tsx"
      provides: "WorkflowComplete component for workflow completion view"
      exports: ["WorkflowComplete"]
    - path: "client/src/components/WorkflowComplete.test.tsx"
      provides: "Unit tests for WorkflowComplete component"
      contains: "renders collected data summary"
    - path: "client/src/components/chat.css"
      provides: "CSS for .workflowComplete, .workflowCompleteCard, .workflowCompleteActions"
      contains: ".workflowComplete"
  key_links:
    - from: "client/src/components/WorkflowComplete.tsx"
      to: "shared/src/schemas/workflowState.ts"
      via: "import type { WorkflowState } from '@copilot-chat/shared'"
      pattern: "WorkflowState"
    - from: "client/src/components/WorkflowComplete.tsx"
      to: "client/src/components/chat.css"
      via: "CSS class names: workflowComplete, workflowCompleteCard, workflowCompleteData, workflowCompleteActions"
      pattern: "className.*workflowComplete"
---

<objective>
Build the WorkflowComplete component using TDD — tests first, then implementation. This component renders a completion summary when the workflow finishes, showing collected data and providing reset/download actions.

Purpose: When a workflow completes, users see a clean "receipt" summarizing what was collected, with the ability to start a new conversation or download the data as JSON.
Output: WorkflowComplete.tsx, WorkflowComplete.test.tsx, CSS classes in chat.css.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-dynamic-input-completion-metadatapane/21-CONTEXT.md

@client/src/components/ChatShell.tsx
@client/src/components/chat.css
@client/src/hooks/useChatApi.ts
@shared/src/schemas/workflowState.ts
@client/jest.config.cjs
@client/src/components/WorkflowProgress.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — write failing tests for WorkflowComplete</name>
  <files>client/src/components/WorkflowComplete.test.tsx</files>
  <action>
    Create `client/src/components/WorkflowComplete.test.tsx` with Jest tests using `renderToStaticMarkup` from `react-dom/server` (same pattern as WorkflowProgress.test.tsx).

    Add `/* global describe, test, expect */` at top for ESLint v9 flat config compatibility.

    The WorkflowComplete component will accept:
    - `workflowState: WorkflowState` (with status === 'completed')
    - `onReset: () => void`

    Test cases (ALL must FAIL before implementation exists):

    1. `renders heading "Workflow Complete"` — verify HTML output contains "Workflow Complete" text.

    2. `renders collected data as key-value pairs` — with collectedData = { first_name: 'Alice', email_address: 'alice@example.com' }, verify HTML contains "First name" (capitalized, underscore replaced), "Alice", "Email address", "alice@example.com".

    3. `renders "Start new conversation" button` — verify HTML contains a button with text "Start new conversation".

    4. `renders "Download summary" button` — verify HTML contains a button with text "Download summary".

    5. `handles empty collectedData gracefully` — with collectedData = {}, verify component renders without crashing and still shows heading and buttons. No data rows displayed.

    6. `handles undefined collectedData` — with no collectedData field in workflowState, verify component renders heading and buttons without crashing.

    For each test, create a mock WorkflowState with `status: 'completed'`, `step: 'done'`, `turnCount: 3`, and appropriate `collectedData`. Use `renderToStaticMarkup(<WorkflowComplete workflowState={state} onReset={onReset} />)` and assert on the HTML string.

    IMPORTANT: The component file does NOT exist yet — all imports from `./WorkflowComplete` will cause test failures. Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=WorkflowComplete 2>&1`, confirm ALL tests fail (module not found).

    Commit: `test(21-02): add failing tests for WorkflowComplete`.
  </action>
  <verify>Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=WorkflowComplete 2>&1`. All tests should FAIL — "Cannot find module './WorkflowComplete'" or similar. No passing tests at this stage.</verify>
  <done>WorkflowComplete.test.tsx exists with 6 test cases, all failing. Committed with message `test(21-02): add failing tests for WorkflowComplete`.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — implement WorkflowComplete component and CSS</name>
  <files>client/src/components/WorkflowComplete.tsx, client/src/components/chat.css</files>
  <action>
    Implement `client/src/components/WorkflowComplete.tsx`:

    ```tsx
    import type { WorkflowState } from '@copilot-chat/shared';

    interface WorkflowCompleteProps {
      workflowState: WorkflowState;
      onReset: () => void;
    }

    /**
     * Formats a collectedData key into a human-readable label.
     * - Replaces underscores with spaces
     * - Capitalizes the first letter
     * e.g., "first_name" -> "First name", "email_address" -> "Email address"
     */
    function formatLabel(key: string): string {
      const spaced = key.replace(/_/g, ' ');
      return spaced.charAt(0).toUpperCase() + spaced.slice(1);
    }

    /**
     * WorkflowComplete — Completion summary view.
     *
     * Renders when workflowState.status === 'completed'.
     * Shows collected data summary, reset button, and download button.
     *
     * COMPL-01, COMPL-02, COMPL-03
     */
    export function WorkflowComplete({ workflowState, onReset }: WorkflowCompleteProps) {
      const data = workflowState.collectedData ?? {};
      const entries = Object.entries(data);

      function downloadSummary() {
        const exportData = {
          exportedAt: new Date().toISOString(),
          status: workflowState.status,
          step: workflowState.step,
          collectedData: data,
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.download = `workflow-summary-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(url);
      }

      return (
        <div className="workflowComplete">
          <div className="workflowCompleteCard">
            <h2 className="workflowCompleteHeading">Workflow Complete</h2>

            {entries.length > 0 && (
              <dl className="workflowCompleteData">
                {entries.map(([key, value]) => (
                  <div key={key} className="workflowCompleteDataRow">
                    <dt className="workflowCompleteKey">{formatLabel(key)}</dt>
                    <dd className="workflowCompleteValue">{String(value)}</dd>
                  </div>
                ))}
              </dl>
            )}

            <div className="workflowCompleteActions">
              <button
                type="button"
                className="workflowCompleteReset"
                onClick={onReset}
              >
                Start new conversation
              </button>
              <button
                type="button"
                className="workflowCompleteDownload"
                onClick={downloadSummary}
              >
                Download summary
              </button>
            </div>
          </div>
        </div>
      );
    }
    ```

    **CSS additions in `client/src/components/chat.css`:**

    Add a new section after the Workflow Error State section (before the Theme Toggle section):

    ```css
    /* ─────────────────────────────────────────────────────────────────────────
       Workflow Complete (COMPL-01, COMPL-02, COMPL-03)
       Summary card shown when workflow status is 'completed'.
       Replaces transcript + input area in the chat shell layout.
       ───────────────────────────────────────────────────────────────────────── */

    .workflowComplete {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      overflow-y: auto;
    }

    .workflowCompleteCard {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: var(--space-5) var(--space-4);
      max-width: 480px;
      width: 100%;
    }

    .workflowCompleteHeading {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--color-text);
      margin: 0 0 var(--space-4) 0;
      text-align: center;
    }

    .workflowCompleteData {
      margin: 0 0 var(--space-4) 0;
      padding: 0;
    }

    .workflowCompleteDataRow {
      display: flex;
      justify-content: space-between;
      gap: var(--space-2);
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--color-border);
    }

    .workflowCompleteDataRow:last-child {
      border-bottom: none;
    }

    .workflowCompleteKey {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      font-weight: 500;
    }

    .workflowCompleteValue {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      text-align: right;
      margin: 0;
      word-break: break-word;
    }

    .workflowCompleteActions {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .workflowCompleteReset {
      padding: 10px var(--space-4);
      background: var(--color-primary);
      color: var(--color-text-inverse);
      border: none;
      border-radius: 4px;
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: background var(--transition-base);
    }

    .workflowCompleteReset:hover {
      background: var(--color-primary-hover);
    }

    .workflowCompleteReset:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px var(--color-focus-ring);
    }

    .workflowCompleteDownload {
      padding: 10px var(--space-4);
      background: none;
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      transition: border-color var(--transition-base), color var(--transition-base);
    }

    .workflowCompleteDownload:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .workflowCompleteDownload:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px var(--color-focus-ring);
    }
    ```

    After implementing, run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=WorkflowComplete`. All 6 tests must pass. Then run `cd /Users/zycroft/Documents/PA/aaae && npm run build` to confirm no TypeScript errors.

    Commit: `feat(21-02): implement WorkflowComplete component with summary, reset, download`.
  </action>
  <verify>Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=WorkflowComplete 2>&1`. All 6 tests pass. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1` to confirm no TypeScript errors.</verify>
  <done>All 6 WorkflowComplete tests pass. TypeScript build clean. Committed `feat(21-02): implement WorkflowComplete component with summary, reset, download`.</done>
</task>

</tasks>

<verification>
1. Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=WorkflowComplete` — all 6 tests pass
2. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build` — no TypeScript errors
3. WorkflowComplete.tsx exports `WorkflowComplete` function — grep for `export function WorkflowComplete`
4. collectedData keys formatted with underscores replaced by spaces and first letter capitalized — grep for `formatLabel` in WorkflowComplete.tsx
5. "Start new conversation" button calls onReset — grep for `workflowCompleteReset` and `onReset` in WorkflowComplete.tsx
6. "Download summary" exports JSON via Blob/URL download — grep for `downloadSummary` in WorkflowComplete.tsx
7. CSS contains `.workflowComplete`, `.workflowCompleteCard`, `.workflowCompleteReset`, `.workflowCompleteDownload` in chat.css
</verification>

<success_criteria>
- WorkflowComplete.tsx and WorkflowComplete.test.tsx exist in client/src/components/
- 6 unit tests pass covering: heading, collected data summary, reset button, download button, empty data, undefined data
- WorkflowComplete renders heading "Workflow Complete" with collected data as formatted key-value pairs
- "Start new conversation" button uses var(--color-primary) background (primary CTA)
- "Download summary" button uses outlined/secondary style (border, no fill)
- Component handles empty or undefined collectedData without crashing
- TypeScript build clean
</success_criteria>

<output>
After completion, create `.planning/phases/21-dynamic-input-completion-metadatapane/21-02-SUMMARY.md`
</output>
