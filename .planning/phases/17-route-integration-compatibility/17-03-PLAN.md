---
phase: 17-route-integration-compatibility
plan: 03
type: tdd
wave: 2
depends_on: [17-01]
files_modified:
  - server/src/orchestrator/WorkflowOrchestrator.integration.test.ts
autonomous: true
requirements: [TEST-01, TEST-02, TEST-03]

must_haves:
  truths:
    - "A multi-turn test runs processTurn 3+ times and shows collectedData growing each turn"
    - "After turn 3, the Copilot query preamble for turn 3 contains data collected in turns 1 and 2"
    - "All 3 ParsedTurn kinds (passthrough, structured, parse_error) are exercised without the test throwing"
    - "The existing structuredOutputParser.test.ts and contextBuilder.test.ts still pass (no regressions)"
    - "TEST-01 and TEST-02 requirement coverage is confirmed: existing tests cover JSON code block extraction, text-only passthrough, hybrid, truncation"
  artifacts:
    - path: "server/src/orchestrator/WorkflowOrchestrator.integration.test.ts"
      provides: "Multi-turn orchestrator integration test with mocked dependencies"
      min_lines: 60
  key_links:
    - from: "server/src/orchestrator/WorkflowOrchestrator.integration.test.ts"
      to: "server/src/orchestrator/WorkflowOrchestrator.ts"
      via: "WorkflowOrchestrator instantiated with mock DI"
      pattern: "new WorkflowOrchestrator"
    - from: "server/src/orchestrator/WorkflowOrchestrator.integration.test.ts"
      to: "server/src/workflow/contextBuilder.ts"
      via: "query preamble assertion on successive turn calls"
      pattern: "CONTEXT.*Phase.*Collected data"
---

<objective>
Write a multi-turn integration test for WorkflowOrchestrator that demonstrates data accumulation across 3+ turns (TEST-03), and confirm TEST-01/TEST-02 coverage is complete in the existing parser and context builder test files.

Purpose: Phase 17 success criterion 5 requires "a multi-turn integration test demonstrates that collectedData accumulates across three or more turns and appears in successive Copilot query preambles." This plan creates that test using the DI-injectable orchestrator with mocked dependencies (no real Redis, no real Copilot calls). TEST-01 and TEST-02 are confirmed already covered by existing test suites from Phase 15.

Output: server/src/orchestrator/WorkflowOrchestrator.integration.test.ts containing a 3-turn data-accumulation test. All 142+ existing tests continue to pass.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/orchestrator/WorkflowOrchestrator.ts
@server/src/orchestrator/WorkflowOrchestrator.test.ts
@server/src/parser/structuredOutputParser.test.ts
@server/src/workflow/contextBuilder.test.ts
</context>

<feature>
  <name>Multi-turn workflow integration test (TEST-03)</name>
  <files>
    server/src/orchestrator/WorkflowOrchestrator.integration.test.ts
  </files>
  <behavior>
    Goal: Prove that collectedData accumulates across 3 sequential processTurn calls and appears in the Copilot query context preamble on successive turns.

    Test setup:
    - Instantiate WorkflowOrchestrator with fully mocked dependencies (same pattern as WorkflowOrchestrator.test.ts)
    - mockWorkflowStore: in-memory Map (get/set are real Map ops, no vi.fn() persistence issues)
    - mockConversationStore: in-memory Map
    - mockLock: acquire() returns async release fn (no actual locking)
    - mockCopilotClient: sendActivityStreaming returns a structured response with data field

    Turn 1: processTurn with text "My name is Alice"
      - Mock Copilot returns activity with value: { action: 'ask', data: { name: 'Alice' }, prompt: 'What is your age?' }
      - After turn 1: workflowResponse.workflowState.collectedData should have { name: 'Alice' }

    Turn 2: processTurn with text "I am 30"
      - Before Copilot call, capture the query argument passed to sendActivityStreaming
      - Mock Copilot returns activity with value: { action: 'ask', data: { age: 30 }, prompt: 'What is your location?' }
      - After turn 2: collectedData should have { name: 'Alice', age: 30 }
      - The query arg from turn 2 should contain '[CONTEXT]' preamble with 'name' in it (data from turn 1)

    Turn 3: processTurn with text "I am in Seattle"
      - Before Copilot call, capture the query argument passed to sendActivityStreaming
      - Mock Copilot returns activity with value: { action: 'complete', data: { location: 'Seattle' } }
      - After turn 3: collectedData should have { name: 'Alice', age: 30, location: 'Seattle' }
      - The query arg from turn 3 should contain '[CONTEXT]' preamble with both 'name' and 'age' in it (data from turns 1+2)

    Assertions:
    - turn1Result.workflowState.collectedData equals { name: 'Alice' }
    - turn2Result.workflowState.collectedData equals { name: 'Alice', age: 30 }
    - turn3Result.workflowState.collectedData equals { name: 'Alice', age: 30, location: 'Seattle' }
    - turn2Query includes '[CONTEXT]' and 'name'
    - turn3Query includes '[CONTEXT]', 'name', and 'age'
    - All three processTurn calls resolve without throwing

    Also add a passthrough mode test:
    - Mock Copilot returns plain text activity (no value field, no structured data)
    - parseTurn returns kind='passthrough'
    - workflowState.collectedData remains empty {}
    - response.messages contains the plain text message

    TDD flow:
    RED: Write the test file → run tests → confirm new tests fail (file imports work but behavior not yet wired in Plan 02 route, though orchestrator itself is already wired from Phase 16 — tests may already pass green if WorkflowOrchestrator implementation is complete)
    GREEN: Tests pass using the existing WorkflowOrchestrator implementation
    REFACTOR: Clean up mock helpers if needed
  </behavior>
  <implementation>
    Use the exact same mock pattern as WorkflowOrchestrator.test.ts:
    - vi.fn() for store methods, but override get/set to use a real Map for persistence across calls
    - mockLock.acquire = vi.fn().mockResolvedValue(vi.fn()) (release fn)
    - mockCopilotClient.sendActivityStreaming = vi.fn().mockImplementation(returning different activities per call using mockResolvedValueOnce on an async generator)

    Key: To capture the query passed to sendActivityStreaming on turn 2 and 3, use vi.fn() and check mockCopilotClient.sendActivityStreaming.mock.calls[1][0].text (the Activity.text passed for the second call).

    The orchestrator normalizes activities using normalizeActivities (from activityNormalizer). Mocked activities with { value: { action: 'ask', data: { name: 'Alice' } } } will be normalized; the normalizer extracts extractedPayload from activity.value — verify this by checking the test pattern in WorkflowOrchestrator.test.ts botActivity() helper.

    File location: server/src/orchestrator/WorkflowOrchestrator.integration.test.ts
    Test framework: Vitest (same as all other server tests)
    Import from: './WorkflowOrchestrator.js' and '../workflow/workflowDefinition.js'
  </implementation>
</feature>

<verification>
1. RED phase: Create test file, run cd /Users/zycroft/Documents/PA/aaae/server && npm test -- WorkflowOrchestrator.integration
   Document whether tests fail (expected) or pass immediately (Phase 16 orchestrator already complete).

2. GREEN phase: Tests pass with existing WorkflowOrchestrator implementation (Phase 16 built the full loop).

3. Run full test suite: cd /Users/zycroft/Documents/PA/aaae && npm test
   Expected: 142+ tests pass, integration tests add to the total.

4. Confirm TEST-01 coverage (parser tests exist):
   grep -c "it(" server/src/parser/structuredOutputParser.test.ts
   Expected: 13+ test cases covering passthrough, structured, parse_error, non-throwing

5. Confirm TEST-02 coverage (context builder tests exist):
   grep -c "it(" server/src/workflow/contextBuilder.test.ts
   Expected: 9+ test cases covering default format, custom template, truncation
</verification>

<success_criteria>
WorkflowOrchestrator.integration.test.ts exists and passes, demonstrating:
- Turn 1 data (name) appears in Turn 2 query preamble
- Turn 1+2 data (name, age) appears in Turn 3 query preamble
- collectedData accumulates correctly across 3 turns
- Passthrough mode (plain text) leaves collectedData empty
All existing tests continue to pass (no regressions).
TEST-01 and TEST-02 confirmed covered by existing test suites.
</success_criteria>

<output>
After completion, create `.planning/phases/17-route-integration-compatibility/17-03-SUMMARY.md`
</output>
