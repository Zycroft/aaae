---
phase: 17-route-integration-compatibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/schemas/api.ts
autonomous: true
requirements: [ROUTE-04]

must_haves:
  truths:
    - "StartConversationResponseSchema has an optional workflowState field"
    - "SendMessageResponseSchema has an optional workflowState field"
    - "CardActionResponseSchema has an optional workflowState field"
    - "A v1.4 client that parses { conversationId, messages } still works (field is optional)"
    - "TypeScript types (StartConversationResponse, SendMessageResponse, CardActionResponse) include workflowState?: WorkflowState"
  artifacts:
    - path: "shared/src/schemas/api.ts"
      provides: "Extended response schemas with optional workflowState"
      contains: "WorkflowStateSchema.optional()"
  key_links:
    - from: "shared/src/schemas/api.ts"
      to: "shared/src/schemas/workflowState.ts"
      via: "import WorkflowStateSchema"
      pattern: "WorkflowStateSchema\\.optional\\(\\)"
---

<objective>
Extend the three chat API response schemas in shared/src/schemas/api.ts to include an optional workflowState field. This is a pure schema change — no route or implementation code changes in this plan.

Purpose: Route handlers in Plan 02 will need TypeScript types that include workflowState in response objects. The shared schema update is the prerequisite. Making workflowState optional preserves backward compatibility — v1.4 clients that parse without this field continue to work.

Output: Updated shared/src/schemas/api.ts with WorkflowStateSchema.optional() on all three response schemas. Rebuilt shared package so server and client can import new types.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/src/schemas/api.ts
@shared/src/schemas/workflowState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend API response schemas with optional workflowState</name>
  <files>shared/src/schemas/api.ts</files>
  <action>
    In shared/src/schemas/api.ts, add `workflowState: WorkflowStateSchema.optional()` to three response schemas:
    - StartConversationResponseSchema — add workflowState optional after conversationId
    - SendMessageResponseSchema — add workflowState optional after messages
    - CardActionResponseSchema — add workflowState optional after messages

    WorkflowStateSchema is already imported at line 5 (import { WorkflowStateSchema } from './workflowState.js'). No new import needed.

    The field MUST be .optional() — NOT required. This preserves backward compatibility: existing v1.4 clients parse { conversationId, messages } successfully without the field present.

    Do NOT add workflowState to OrchestrateResponseSchema — it already has a required workflowState field (from Phase 16) which is intentional.

    After editing, also update the exported TypeScript types (StartConversationResponse, SendMessageResponse, CardActionResponse) via z.infer — these update automatically since they're derived from the schemas.

    Then rebuild the shared package so the updated types are available to server and client:
    ```
    cd shared && npm run build
    ```

    Verify the build succeeds with no TypeScript errors.
  </action>
  <verify>
    Run: cd /Users/zycroft/Documents/PA/aaae/shared && npm run build
    Expected: exits 0, no TypeScript errors.

    Also confirm the output type includes workflowState as optional by checking the .d.ts output:
    grep -n "workflowState" /Users/zycroft/Documents/PA/aaae/shared/dist/schemas/api.d.ts
    Expected: Three lines each showing `workflowState?: WorkflowState | undefined`
  </verify>
  <done>
    shared/src/schemas/api.ts has workflowState?: WorkflowState as an optional field in StartConversationResponseSchema, SendMessageResponseSchema, and CardActionResponseSchema.
    shared package builds successfully.
    OrchestrateResponseSchema is unchanged (still has required workflowState).
  </done>
</task>

</tasks>

<verification>
- shared/src/schemas/api.ts diff shows WorkflowStateSchema.optional() added to 3 schemas
- `cd shared && npm run build` exits 0
- grep on shared/dist/schemas/api.d.ts finds workflowState? optional in StartConversationResponse, SendMessageResponse, CardActionResponse
- OrchestrateResponseSchema still has required workflowState (no regression)
</verification>

<success_criteria>
Shared schema updated with optional workflowState in all three chat response schemas. TypeScript types updated automatically via z.infer. Shared package rebuilt and available to server.
</success_criteria>

<output>
After completion, create `.planning/phases/17-route-integration-compatibility/17-01-SUMMARY.md`
</output>
