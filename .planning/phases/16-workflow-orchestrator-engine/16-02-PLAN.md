---
phase: 16-workflow-orchestrator-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/orchestrator/types.ts
  - server/src/workflow/workflowDefinition.ts
  - shared/src/schemas/workflowState.ts
  - shared/src/index.ts
autonomous: true
requirements: [ORCH-04]

must_haves:
  truths:
    - "WorkflowResponse contains messages, workflowState, progress, turnMeta, and latencyMs"
    - "Progress indicator includes currentStep, totalSteps, and percentComplete"
    - "Turn metadata shows turnNumber, stateChanged flag, and data collected this specific turn"
    - "Workflow step definitions load from a config file, not from WorkflowState"
    - "WorkflowState schema supports the fields needed by the orchestrator"
  artifacts:
    - path: "server/src/orchestrator/types.ts"
      provides: "WorkflowResponse, ProcessTurnParams, OrchestratorConfig types"
      exports: ["WorkflowResponse", "ProcessTurnParams", "ProcessCardActionParams", "OrchestratorConfig", "WorkflowProgress", "TurnMeta"]
    - path: "server/src/workflow/workflowDefinition.ts"
      provides: "WorkflowDefinition type and default definition loader"
      exports: ["WorkflowDefinition", "WorkflowStep", "loadWorkflowDefinition", "DEFAULT_WORKFLOW_DEFINITION"]
  key_links:
    - from: "server/src/orchestrator/types.ts"
      to: "@copilot-chat/shared"
      via: "imports NormalizedMessage, WorkflowState, ParsedTurn types"
      pattern: "import.*@copilot-chat/shared"
    - from: "server/src/workflow/workflowDefinition.ts"
      to: "server/src/orchestrator/types.ts"
      via: "WorkflowDefinition used by OrchestratorConfig"
      pattern: "WorkflowDefinition"
---

<objective>
Define WorkflowResponse types, orchestrator config, and workflow step definition loader

Purpose: Establish the type contracts and configuration structures the WorkflowOrchestrator service (Plan 16-03) needs. The expanded WorkflowResponse shape includes progress indicators and turn metadata per user decision (ORCH-04).

Output: TypeScript types for orchestrator I/O, workflow step definition config format and default loader.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-workflow-orchestrator-engine/16-CONTEXT.md
@.planning/phases/16-workflow-orchestrator-engine/16-RESEARCH.md
@shared/src/schemas/workflowState.ts
@shared/src/schemas/workflow.ts
@shared/src/index.ts
@server/src/routes/orchestrate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkflowResponse and orchestrator types</name>
  <files>server/src/orchestrator/types.ts</files>
  <action>
Create `server/src/orchestrator/types.ts` with the following types:

```typescript
import type { NormalizedMessage, WorkflowState, ParsedTurn } from '@copilot-chat/shared';
import type { WorkflowDefinition } from '../workflow/workflowDefinition.js';
import type { WorkflowStateStore } from '../store/WorkflowStateStore.js';
import type { ConversationStore } from '../store/ConversationStore.js';
import type { ConversationLock } from '../lock/ConversationLock.js';
import type { CopilotStudioClient } from '@microsoft/agents-copilotstudio-client';
import type { ContextBuilderConfig } from '../workflow/contextBuilder.js';
```

**WorkflowProgress** — progress indicator for clients:
- `currentStep: string` — current step identifier from workflow definition
- `stepIndex: number` — 0-based index in definition steps
- `totalSteps: number` — total steps in workflow definition
- `percentComplete: number` — stepIndex / totalSteps * 100, rounded to integer

**TurnMeta** — metadata about this specific turn:
- `turnNumber: number` — which turn this is (1-based)
- `stateChanged: boolean` — whether collectedData was modified this turn
- `collectedThisTurn: Record<string, unknown>` — the new data collected THIS turn only (delta, not full state)

**WorkflowResponse** — full orchestrator response:
- `conversationId: string`
- `messages: NormalizedMessage[]`
- `parsedTurn: ParsedTurn`
- `workflowState: WorkflowState`
- `progress: WorkflowProgress`
- `turnMeta: TurnMeta`
- `latencyMs: number`

**ProcessTurnParams** — input for processTurn():
- `conversationId: string`
- `text: string`
- `userId: string`
- `tenantId: string`

**ProcessCardActionParams** — input for processCardAction():
- `conversationId: string`
- `cardId: string`
- `userSummary: string`
- `submitData: Record<string, unknown>`
- `userId: string`
- `tenantId: string`

**OrchestratorConfig** — configuration for the orchestrator:
- `workflowDefinition?: WorkflowDefinition` — step definitions (optional, defaults to DEFAULT)
- `contextBuilderConfig?: ContextBuilderConfig` — preamble template and maxLength
- `lockTtlMs?: number` — lock timeout override (default from ConversationLock)

Export all types.

Commit: `feat(16-02): create WorkflowResponse and orchestrator types`
  </action>
  <verify>cd server && npx tsc --noEmit</verify>
  <done>All orchestrator types defined with progress indicators, turn metadata, and full response shape per ORCH-04</done>
</task>

<task type="auto">
  <name>Task 2: Create workflow step definition config and default loader</name>
  <files>server/src/workflow/workflowDefinition.ts</files>
  <action>
Create `server/src/workflow/workflowDefinition.ts`:

**WorkflowStep** type:
- `id: string` — unique step identifier (e.g., 'gather_info', 'confirm', 'complete')
- `name: string` — human-readable step name
- `description?: string` — optional description of what this step does

**WorkflowDefinition** type:
- `id: string` — definition identifier
- `name: string` — human-readable workflow name
- `steps: WorkflowStep[]` — ordered array of steps

**DEFAULT_WORKFLOW_DEFINITION** constant:
A sensible default workflow with generic steps that work for any Copilot agent:
```typescript
export const DEFAULT_WORKFLOW_DEFINITION: WorkflowDefinition = {
  id: 'default',
  name: 'Default Workflow',
  steps: [
    { id: 'initial', name: 'Initial', description: 'Starting state — awaiting first user input' },
    { id: 'gather_info', name: 'Gather Information', description: 'Collecting user requirements and preferences' },
    { id: 'research', name: 'Research', description: 'Agent researching options based on collected data' },
    { id: 'confirm', name: 'Confirm', description: 'Presenting recommendation for user confirmation' },
    { id: 'complete', name: 'Complete', description: 'Workflow completed — final response delivered' },
  ],
};
```

**loadWorkflowDefinition** function:
- Takes optional `definitionPath?: string`
- If path provided: read and parse the JSON file (fs.readFileSync), validate shape, return
- If no path: return DEFAULT_WORKFLOW_DEFINITION
- For v1.5 this is sufficient. If needed later, can add dynamic loading from Redis or API.

**getStepProgress** helper function:
- Takes `(stepId: string, definition: WorkflowDefinition) => WorkflowProgress`
- Finds step index in definition.steps by id
- Returns `{ currentStep: stepId, stepIndex, totalSteps: definition.steps.length, percentComplete: Math.round((stepIndex / definition.steps.length) * 100) }`
- If stepId not found in definition, returns stepIndex 0 with percentComplete 0

Export all types, constants, and functions.

Commit: `feat(16-02): create workflow step definition config and loader`
  </action>
  <verify>cd server && npx tsc --noEmit</verify>
  <done>WorkflowDefinition type and default definition established. Step definitions live in config, not in WorkflowState per user decision. getStepProgress helper computes progress from step position.</done>
</task>

<task type="auto">
  <name>Task 3: Extend WorkflowState schema for orchestrator needs</name>
  <files>
    shared/src/schemas/workflowState.ts
    shared/src/index.ts
  </files>
  <action>
Update `shared/src/schemas/workflowState.ts`:

Add optional fields to WorkflowStateSchema that the orchestrator needs for state tracking:
- `status: z.enum(['active', 'completed', 'error']).default('active')` — workflow lifecycle status
- `currentPhase: z.string().optional()` — maps to the step from WorkflowDefinition (used for progress tracking)
- `userId: z.string().optional()` — scoping field for ORCH-01
- `tenantId: z.string().optional()` — scoping field for ORCH-01

Keep all existing fields (step, collectedData, lastRecommendation, turnCount). All new fields MUST be optional or have defaults to maintain backward compatibility with existing stored states (Zod .default() chains pattern from Phase 11).

Rebuild shared: `cd shared && npm run build`

Verify `shared/src/index.ts` already exports WorkflowStateSchema and WorkflowState — it does, no changes needed to the barrel export.

Commit: `feat(16-02): extend WorkflowState schema with status, currentPhase, userId, tenantId`
  </action>
  <verify>
cd shared && npm run build && cd ../server && npx tsc --noEmit
Verify existing WorkflowState tests still pass: cd shared && npx vitest run src/schemas/workflowState.test.ts
Verify server tests still pass: cd server && npx vitest run
  </verify>
  <done>WorkflowState schema extended with status, currentPhase, userId, tenantId — all backward compatible via optional/defaults. Shared rebuilt and consumable by server.</done>
</task>

</tasks>

<verification>
- `cd shared && npm run build` — shared compiles successfully
- `cd server && npx tsc --noEmit` — server compiles with new types
- `cd server && npx vitest run` — all existing tests pass (no regressions from schema changes)
- `npm run lint` — no new lint errors
- WorkflowResponse type includes all fields: messages, parsedTurn, workflowState, progress, turnMeta, latencyMs
- WorkflowDefinition has default steps and getStepProgress helper
</verification>

<success_criteria>
- WorkflowResponse fully defines the expanded response shape with progress and turn metadata
- WorkflowDefinition separates step definitions from state (config file, not embedded in state)
- WorkflowState schema backward-compatible with existing stored states
- All types compile, all existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-workflow-orchestrator-engine/16-02-SUMMARY.md`
</output>
