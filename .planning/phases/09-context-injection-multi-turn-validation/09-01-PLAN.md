---
phase: 09-context-injection-multi-turn-validation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/schemas/workflowContext.ts
  - shared/src/schemas/api.ts
  - shared/src/index.ts
autonomous: true
requirements: [CTX-01]

must_haves:
  truths:
    - "SendMessageRequest schema accepts an optional workflowContext field with step, constraints, and collectedData sub-fields"
    - "Zod rejects a SendMessageRequest with workflowContext missing required step field"
    - "Zod accepts a SendMessageRequest with workflowContext omitted entirely (backwards-compatible)"
    - "WorkflowContext type is exported from @copilot-chat/shared for server and client consumption"
  artifacts:
    - path: "shared/src/schemas/workflowContext.ts"
      provides: "WorkflowContextSchema and WorkflowContext type"
      exports: ["WorkflowContextSchema", "WorkflowContext"]
    - path: "shared/src/schemas/api.ts"
      provides: "SendMessageRequestSchema extended with optional workflowContext"
      contains: "workflowContext: WorkflowContextSchema.optional()"
    - path: "shared/src/index.ts"
      provides: "Barrel export of WorkflowContext types"
      contains: "WorkflowContextSchema"
  key_links:
    - from: "shared/src/schemas/api.ts"
      to: "shared/src/schemas/workflowContext.ts"
      via: "import WorkflowContextSchema"
      pattern: "WorkflowContextSchema\\.optional\\(\\)"
    - from: "shared/src/index.ts"
      to: "shared/src/schemas/workflowContext.ts"
      via: "re-export"
      pattern: "WorkflowContextSchema"
---

<objective>
Define the WorkflowContext Zod schema and extend SendMessageRequest to accept optional context injection payload.

Purpose: The server must validate inbound workflowContext at the Zod boundary before injecting it into outbound Copilot messages. The schema must be backwards-compatible (omitting workflowContext must still pass validation).

Output: WorkflowContextSchema in shared/, SendMessageRequest extended, types barrel-exported.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@shared/src/schemas/api.ts
@shared/src/schemas/extractedPayload.ts
@shared/src/index.ts
</context>

<feature>
  <name>WorkflowContext schema + SendMessageRequest extension</name>
  <files>shared/src/schemas/workflowContext.ts, shared/src/schemas/api.ts, shared/src/index.ts</files>
  <behavior>
    WorkflowContextSchema shape:
      - step: z.string().min(1)                         — required, identifies the current workflow step
      - constraints: z.array(z.string()).optional()      — optional list of constraint strings
      - collectedData: z.record(z.string(), z.unknown()).optional() — optional KV bag of collected workflow data

    SendMessageRequestSchema extension:
      - workflowContext: WorkflowContextSchema.optional() — must be entirely optional; no change to existing fields

    Cases:
      { conversationId: "<uuid>", text: "hello" }
        → valid (no workflowContext)

      { conversationId: "<uuid>", text: "hello", workflowContext: { step: "gather-name" } }
        → valid (minimal workflowContext)

      { conversationId: "<uuid>", text: "hello", workflowContext: { step: "gather-name", constraints: ["max 10 words"], collectedData: { name: "Alice" } } }
        → valid (full workflowContext)

      { conversationId: "<uuid>", text: "hello", workflowContext: {} }
        → INVALID (step is required, empty object missing it)

      { conversationId: "<uuid>", text: "hello", workflowContext: { step: "" } }
        → INVALID (step must be min(1))
  </behavior>
  <implementation>
    1. Create shared/src/schemas/workflowContext.ts with WorkflowContextSchema (step, constraints, collectedData)
    2. Import WorkflowContextSchema into shared/src/schemas/api.ts and add workflowContext: WorkflowContextSchema.optional() to SendMessageRequestSchema
    3. Re-export WorkflowContextSchema and WorkflowContext type from shared/src/index.ts
    4. Rebuild shared: cd shared && npm run build
    5. Run npm test from repo root to confirm all 54+ normalizer tests still pass and new schema tests pass
  </implementation>
</feature>

<verification>
- `cd /Users/zycroft/Documents/PA/aaae/shared && npm run build` completes without errors
- `npm test` from repo root passes all existing tests
- Manual Zod parse confirms: valid inputs parse, invalid inputs throw (step missing, step empty string)
</verification>

<success_criteria>
WorkflowContextSchema is the source of truth in shared/. SendMessageRequest.workflowContext is optional — existing callers passing { conversationId, text } still pass Zod validation. All pre-existing tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/09-context-injection-multi-turn-validation/09-01-SUMMARY.md`
</output>
