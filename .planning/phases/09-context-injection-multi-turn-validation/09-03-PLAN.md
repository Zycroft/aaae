---
phase: 09-context-injection-multi-turn-validation
plan: 03
type: execute
wave: 3
depends_on: [09-02]
files_modified:
  - spike/context-injection-spike.ts
  - spike/CONTEXT-INJECTION-RESULTS.md
autonomous: false
requirements: [CTX-03, CTX-04, ORCH-04]

must_haves:
  truths:
    - "A spike script drives a 3-turn live Copilot conversation injecting workflowContext on each turn"
    - "The spike tests both 500-char and 1000-char context sizes and records whether agent responses are coherent"
    - "A results document records pass/fail for each turn and size threshold, and notes any degraded responses"
    - "ORCH-04 is satisfied: conversation state is not lost between turns (agent responds sensibly to turn 2 and turn 3)"
  artifacts:
    - path: "spike/context-injection-spike.ts"
      provides: "3-turn live spike with context injection at two size thresholds"
      min_lines: 80
    - path: "spike/CONTEXT-INJECTION-RESULTS.md"
      provides: "Documented test results for CTX-03 and CTX-04 size thresholds"
      contains: "500 chars"
  key_links:
    - from: "spike/context-injection-spike.ts"
      to: "server/src/routes/chat.ts buildContextPrefix"
      via: "imports and invokes buildContextPrefix directly (same logic, standalone)"
      pattern: "buildContextPrefix"
    - from: "spike/CONTEXT-INJECTION-RESULTS.md"
      to: "spike/context-injection-spike.ts"
      via: "records actual output from script run"
      pattern: "Turn [123]"
---

<objective>
Build and run a spike script that drives a 3-turn live conversation against the real Copilot agent with context injection, verifying conversation continuity (ORCH-04) and documenting size thresholds (CTX-04).

Purpose: Phase 9 success criteria 3 and 4 require empirical evidence from a live agent run. The spike produces CONTEXT-INJECTION-RESULTS.md as that evidence. This plan cannot be fully autonomous because running the script requires real Copilot Studio credentials.

Output: spike/context-injection-spike.ts (runnable script) + spike/CONTEXT-INJECTION-RESULTS.md (results with real or placeholder data depending on credential availability).
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/09-context-injection-multi-turn-validation/09-02-SUMMARY.md
@spike/latency-baseline.ts
@server/src/routes/chat.ts
@shared/src/schemas/workflowContext.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create context injection spike script</name>
  <files>spike/context-injection-spike.ts</files>
  <action>
    Model after spike/latency-baseline.ts in structure (dotenv load from server/.env, credential check, error handling).

    The script must:
    1. Start a single Copilot conversation via `CopilotStudioClient.startConversationStreaming(true)`
    2. Run 3 turns using `sendActivityStreaming`, injecting workflowContext prefix on each turn

    Define a `buildContextPrefix` function matching the exact format from server/src/routes/chat.ts:
    ```
    [WORKFLOW_CONTEXT]
    step: {step}
    constraints: {constraints joined or 'none'}
    data: {JSON.stringify(collectedData ?? {})}
    [/WORKFLOW_CONTEXT]

    ```

    Turn design:
    - Turn 1: step="gather-name", constraints=[], collectedData={} + user query "What information do you need from me?"
    - Turn 2: step="gather-budget", constraints=["must be numeric"], collectedData={name:"Alice"} + user query "My name is Alice, what's next?"
    - Turn 3: step="confirm", constraints=[], collectedData={name:"Alice",budget:5000} + user query "Please confirm my details"

    Context size testing — wrap turns in a loop testing two variants:
    - Small context (target ≈500 chars): use the Turn 1–3 design above
    - Large context (target ≈1000 chars): pad collectedData with extra fields to reach ~1000 chars in the serialized prefix

    For each turn, print:
    - Turn number and context size (chars)
    - First 200 chars of agent response text (or "NO TEXT RESPONSE" if no text activity)
    - Whether the agent referenced context (simple heuristic: does response mention the step name?)
    - Pass/Fail indicator (Fail if no response or if the script throws)

    If credentials are missing or connection fails → print clear error and exit 1 (do NOT crash silently).

    Usage comment at top:
    ```
    // Usage: npx tsx spike/context-injection-spike.ts
    // Requires server/.env with real COPILOT_ENVIRONMENT_ID, COPILOT_AGENT_SCHEMA_NAME, COPILOT_STUB_TOKEN
    ```
  </action>
  <verify>
    `npx tsc --noEmit spike/context-injection-spike.ts` OR `npx tsx --check spike/context-injection-spike.ts` compiles without type errors (use ts config from server tsconfig or root).
    Alternative: `npx tsx spike/context-injection-spike.ts` with stub credentials — script must exit with a clear credential error message, not a stack trace.
  </verify>
  <done>
    spike/context-injection-spike.ts exists, compiles without TypeScript errors, and handles missing credentials gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CONTEXT-INJECTION-RESULTS.md with structure and placeholders</name>
  <files>spike/CONTEXT-INJECTION-RESULTS.md</files>
  <action>
    Create spike/CONTEXT-INJECTION-RESULTS.md as a structured results document. Even if real credentials are unavailable, the document must exist with the correct structure and [TBD] placeholders for actual values.

    Document structure:

    ```markdown
    # Context Injection Spike Results

    **Date:** {today or TBD}
    **Agent schema:** {COPILOT_AGENT_SCHEMA_NAME from env or [TBD]}
    **Script:** spike/context-injection-spike.ts

    ## Summary

    | Scenario | Context Size | Turn 1 | Turn 2 | Turn 3 | Overall |
    |----------|-------------|--------|--------|--------|---------|
    | Small context | ~500 chars | [TBD] | [TBD] | [TBD] | [TBD] |
    | Large context | ~1000 chars | [TBD] | [TBD] | [TBD] | [TBD] |

    ## CTX-04: Size Threshold Findings

    - **500 chars:** [TBD — PASS/DEGRADED/FAIL — describe agent behavior]
    - **1000 chars:** [TBD — PASS/DEGRADED/FAIL — describe agent behavior]

    ## ORCH-04: Conversation Continuity

    - Turn 1 → Turn 2 state preserved: [TBD]
    - Turn 2 → Turn 3 state preserved: [TBD]
    - Conclusion: [TBD — agent demonstrated awareness of prior turn / did not demonstrate]

    ## Turn-by-Turn Details

    ### Small Context (~500 chars)

    **Turn 1** (step: gather-name, context: ~NNN chars)
    - Injected prefix: [excerpt or TBD]
    - Agent response (first 200 chars): [TBD]
    - Referenced step: [yes/no/TBD]
    - Result: [PASS/FAIL/TBD]

    **Turn 2** (step: gather-budget, context: ~NNN chars)
    - Agent response (first 200 chars): [TBD]
    - Referenced prior context (name=Alice): [yes/no/TBD]
    - Result: [PASS/FAIL/TBD]

    **Turn 3** (step: confirm, context: ~NNN chars)
    - Agent response (first 200 chars): [TBD]
    - Referenced collectedData: [yes/no/TBD]
    - Result: [PASS/FAIL/TBD]

    ### Large Context (~1000 chars)

    **Turn 1** (step: gather-name, context: ~NNN chars)
    - Result: [PASS/FAIL/TBD]

    **Turn 2** (step: gather-budget, context: ~NNN chars)
    - Result: [PASS/FAIL/TBD]

    **Turn 3** (step: confirm, context: ~NNN chars)
    - Result: [PASS/FAIL/TBD]

    ## Notes

    [Any degradation, garbling, or unexpected agent behavior observed]
    ```

    If real results are available at execution time (credentials present), populate the [TBD] values with actual observations from running the script.
  </action>
  <verify>
    File exists at spike/CONTEXT-INJECTION-RESULTS.md with all section headings present (Summary, CTX-04, ORCH-04, Turn-by-Turn Details).
  </verify>
  <done>
    spike/CONTEXT-INJECTION-RESULTS.md exists with correct structure. Either populated with real results (if credentials available) or contains [TBD] placeholders.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify spike results and sign off on CTX-03, CTX-04, ORCH-04</name>
  <files>spike/CONTEXT-INJECTION-RESULTS.md</files>
  <action>Human reviews the spike results document and (if credentials available) runs the spike script to produce real measurements. Update [TBD] fields in spike/CONTEXT-INJECTION-RESULTS.md with actual observations.</action>
  <what-built>
    Context injection spike script (spike/context-injection-spike.ts) and results document (spike/CONTEXT-INJECTION-RESULTS.md).
    The script drives 3 turns with context injection at ~500 and ~1000 char sizes.
  </what-built>
  <how-to-verify>
    1. If real Copilot Studio credentials are available in server/.env:
       Run: `npx tsx spike/context-injection-spike.ts`
       - Confirm 3 turns complete without errors
       - Note whether agent responses are coherent (not garbled by injected prefix)
       - Note which context sizes (500/1000 chars) caused degraded responses (if any)
       - Update spike/CONTEXT-INJECTION-RESULTS.md with actual observations

    2. Review spike/CONTEXT-INJECTION-RESULTS.md structure — confirm:
       - CTX-04 section present (500 chars, 1000 chars thresholds documented)
       - ORCH-04 section present (turn-to-turn continuity assessment)
       - Turn-by-turn detail section present for both scenarios

    3. If credentials are NOT available:
       Verify script exits with a clear error (not a crash) when run without credentials.
       The [TBD] results document still satisfies the structural requirement.
  </how-to-verify>
  <resume-signal>Type "approved" once you have reviewed the results document and are satisfied that CTX-03, CTX-04, and ORCH-04 are addressed. If real credentials were used, describe any degraded responses observed.</resume-signal>
</task>

</tasks>

<verification>
- spike/context-injection-spike.ts compiles without TypeScript errors
- spike/CONTEXT-INJECTION-RESULTS.md exists with all required sections
- CTX-04 thresholds (500 chars, 1000 chars) are present in the results document
- ORCH-04 conversation continuity section is present
- Human checkpoint completed: real results populated or [TBD] structure accepted
</verification>

<success_criteria>
spike/context-injection-spike.ts drives a 3-turn conversation with context injection and compiles correctly. spike/CONTEXT-INJECTION-RESULTS.md documents the tested size thresholds and conversation continuity findings. CTX-03, CTX-04, and ORCH-04 requirements are empirically addressed.
</success_criteria>

<output>
After completion, create `.planning/phases/09-context-injection-multi-turn-validation/09-03-SUMMARY.md`
</output>
