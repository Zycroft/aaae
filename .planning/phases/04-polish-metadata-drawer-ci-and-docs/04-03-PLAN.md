---
phase: 04-polish-metadata-drawer-ci-and-docs
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - README.md
  - docs/adaptive-card-playbook.md
  - docs/cards/feedback-survey.json
autonomous: true
requirements: [DOCS-01, DOCS-02, DOCS-03]

must_haves:
  truths:
    - "A developer with no prior project knowledge can read README.md and follow it to clone, configure .env files, run npm run dev, and have a working local instance"
    - "README.md contains a complete env var reference table for both client/.env and server/.env with variable names, descriptions, and example values"
    - "A card author can follow docs/adaptive-card-playbook.md to register a new card ID, write card JSON, and wire it through the server allowlist without reading source code"
    - "The playbook explains all four steps: register card ID, create docs/cards/{cardId}.json, define userSummary formatter in the allowlist, verify via tests"
    - "docs/cards/feedback-survey.json is a valid Adaptive Card v1.5 JSON file referenced in the playbook as a worked example"
  artifacts:
    - path: "README.md"
      provides: "Monorepo quick-start: prerequisites, clone+install, env configuration, npm run dev, npm test, lint, project structure, workspace descriptions"
      min_lines: 80
    - path: "docs/adaptive-card-playbook.md"
      provides: "Step-by-step guide for registering and wiring a new Adaptive Card — card ID selection, JSON template, allowlist wiring, test pattern"
      min_lines: 100
    - path: "docs/cards/feedback-survey.json"
      provides: "Sample Adaptive Card v1.5 JSON with Input.ChoiceSet and Action.Submit; used as worked example in playbook"
      contains: "AdaptiveCard"
  key_links:
    - from: "README.md"
      to: "client/.env.example"
      via: "env var table references VITE_API_URL"
      pattern: "VITE_API_URL"
    - from: "README.md"
      to: "server/.env.example"
      via: "env var table references COPILOT_* vars"
      pattern: "COPILOT_TENANT_ID"
    - from: "docs/adaptive-card-playbook.md"
      to: "docs/cards/feedback-survey.json"
      via: "worked example section references file path"
      pattern: "feedback-survey\\.json"
    - from: "docs/adaptive-card-playbook.md"
      to: "server/src/allowlist/cardActionAllowlist.ts"
      via: "Step 3 wiring instructions reference file path"
      pattern: "cardActionAllowlist"
---

<objective>
Write README.md (DOCS-01), docs/adaptive-card-playbook.md (DOCS-02), and docs/cards/feedback-survey.json (DOCS-03) so that new developers and card authors can onboard and extend the app without reading source code.

Purpose: Documentation gap from v1.0 — the codebase is complete but undiscoverable. These three files are the onboarding surface.
Output: README.md at repo root; docs/adaptive-card-playbook.md; docs/cards/feedback-survey.json.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish-metadata-drawer-ci-and-docs/04-RESEARCH.md
@server/src/allowlist/cardActionAllowlist.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write README.md</name>
  <files>README.md</files>
  <action>
Create (or replace if it exists as a stub) `README.md` at the repository root. The README must enable a developer with zero prior context to configure and run the app.

Required sections in order:

**1. Title and tagline**
`# Agentic Copilot Chat App`
One-sentence description: "A production-ready monorepo delivering a responsive chat experience powered by Microsoft Copilot Studio and Adaptive Cards."

**2. Quick Start** (most important section — keep it first and brief)

Prerequisites block:
- Node.js 20+
- npm 10+

Steps numbered 1–5:
1. Clone and install: `git clone <repo-url> && cd <repo-name> && npm ci`
2. Configure environment — copy .env.example files for BOTH client/ and server/:
   ```bash
   cp client/.env.example client/.env
   cp server/.env.example server/.env
   ```
   Then fill in values. Include a markdown table of ALL env vars:
   | Variable | Workspace | Description | Example |
   |----------|-----------|-------------|---------|
   | `VITE_API_URL` | client | Express server URL | `http://localhost:3001` |
   | `COPILOT_TENANT_ID` | server | Azure AD tenant ID | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
   | `COPILOT_APP_ID` | server | Copilot Studio app registration ID | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
   | `COPILOT_AGENT_IDENTIFIER` | server | Agent identifier from Copilot Studio portal | `your-agent-name` |
   | `AUTH_REQUIRED` | server | Fail-closed auth stub; set `false` to disable (dev only) | `true` |
   | `PORT` | server | Express listen port | `3001` |

3. Run dev: `npm run dev` — opens client at http://localhost:5173, server at http://localhost:3001
4. Run tests: `npm test` — runs Vitest across server/ and shared/
5. Lint: `npm run lint` — check all workspaces

**3. Project Structure**
Code block showing:
```
.
├── client/              # React 18 + Vite chat UI
├── server/              # Express.js Copilot Studio proxy
├── shared/              # Zod schemas and TypeScript types (single source of truth)
├── .github/workflows/   # GitHub Actions CI
├── docs/                # Documentation and Adaptive Card assets
│   ├── adaptive-card-playbook.md
│   └── cards/           # Sample Adaptive Card JSON files
└── README.md
```

**4. Workspaces** (brief — one paragraph each)
- **client/**: React + TypeScript chat interface. Vite dev server. Renders messages and Adaptive Cards.
- **server/**: Express.js proxy for Copilot Studio. All secrets (tenant ID, app ID) live here only. Never directly accessible from browser.
- **shared/**: Zod schemas used by both client and server. Generates TypeScript types. Zod is installed here only (single instance enforced).

**5. Adaptive Cards**
Two sentences: refer reader to `docs/adaptive-card-playbook.md` for registering new cards. Mention `docs/cards/` for sample JSON.

**6. Security**
Three bullet points:
- All Copilot Studio calls are server-side only; no credentials in client
- Card actions validated against server-side allowlist before forwarding
- CI enforces no COPILOT_* credential assignments in client code on every push

**7. CI**
One paragraph: GitHub Actions (`.github/workflows/ci.yml`) lints, tests, and runs security checks on every push and PR to main.

**8. License**
`Proprietary.`

Keep the README practical. No "motivation" or "roadmap" sections. No badges (YAML frontmatter). Total length: 80–150 lines.
  </action>
  <verify>
1. `wc -l README.md` — between 80 and 200 lines
2. `grep "VITE_API_URL" README.md` — env var table present
3. `grep "COPILOT_TENANT_ID" README.md` — server env vars documented
4. `grep "npm run dev" README.md` — dev command present
5. `grep "adaptive-card-playbook" README.md` — playbook reference present
  </verify>
  <done>README.md exists at repo root with Quick Start (prerequisites, env config with complete table, npm run dev, npm test), project structure, workspace descriptions, security notes, and CI mention. Developer can follow it cold to run the app.</done>
</task>

<task type="auto">
  <name>Task 2: Write adaptive-card-playbook.md and sample card JSON</name>
  <files>docs/adaptive-card-playbook.md, docs/cards/feedback-survey.json</files>
  <action>
Create the `docs/` directory and `docs/cards/` subdirectory if they do not exist.

**docs/cards/feedback-survey.json** — write first (referenced in playbook):

```json
{
  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
  "type": "AdaptiveCard",
  "version": "1.5",
  "body": [
    {
      "type": "TextBlock",
      "text": "How satisfied are you with this interaction?",
      "weight": "Bolder",
      "wrap": true
    },
    {
      "type": "Input.ChoiceSet",
      "id": "satisfaction",
      "style": "expanded",
      "isRequired": true,
      "errorMessage": "Please select a satisfaction level",
      "choices": [
        { "title": "Very Satisfied", "value": "5" },
        { "title": "Satisfied", "value": "4" },
        { "title": "Neutral", "value": "3" },
        { "title": "Dissatisfied", "value": "2" },
        { "title": "Very Dissatisfied", "value": "1" }
      ]
    },
    {
      "type": "Input.Text",
      "id": "comments",
      "placeholder": "Optional comments...",
      "isMultiline": true,
      "maxLength": 500
    }
  ],
  "actions": [
    {
      "type": "Action.Submit",
      "title": "Submit Feedback",
      "data": {
        "action": "Action.Submit",
        "cardId": "feedback-survey"
      }
    }
  ]
}
```

**docs/adaptive-card-playbook.md** — four clearly numbered steps that tell a card author everything needed to add a new card:

```markdown
# Adaptive Cards Playbook

This guide shows you how to register, build, and wire a new Adaptive Card into the chat system. You do not need to read source code — follow these four steps.

## Overview

Every Adaptive Card in the system is identified by a `cardId`. The server validates card submissions against an allowlist before forwarding to Copilot Studio. This ensures:
- Only registered cards can be submitted
- Card submissions produce consistent summary text in the chat transcript
- Unrecognized or malformed card actions are rejected at the server boundary

## Step 1: Choose a Card ID

Pick a descriptive, lowercase, kebab-case identifier. This string must be unique across all cards.

**Good examples:**
- `approval-request`
- `feedback-survey`
- `resource-booking`
- `leave-request`

**Rules:**
- Lowercase only
- Hyphens as separators (no underscores, no spaces)
- Describes the card's purpose, not its visual appearance

---

## Step 2: Create the Card JSON

Save the Adaptive Card JSON to `docs/cards/{your-card-id}.json`. Use Adaptive Cards schema version 1.5.

**Required structure:**
```json
{
  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
  "type": "AdaptiveCard",
  "version": "1.5",
  "body": [ ... ],
  "actions": [
    {
      "type": "Action.Submit",
      "title": "Submit",
      "data": {
        "action": "Action.Submit",
        "cardId": "your-card-id"
      }
    }
  ]
}
```

**Critical:** The `data` object in `Action.Submit` MUST include both `action` and `cardId` fields. The server uses `cardId` for allowlist lookup and action routing.

**Working example** (`docs/cards/feedback-survey.json`):

See `docs/cards/feedback-survey.json` for a complete card with `Input.ChoiceSet` and optional `Input.Text`. The feedback-survey card:
- Uses `Input.ChoiceSet` with `style: "expanded"` for radio-button style selection
- Includes an optional free-text comment field
- Submits with `action: "Action.Submit"` and `cardId: "feedback-survey"`

**Design constraints:**
- Supported input types: `Input.Text`, `Input.Number`, `Input.ChoiceSet`, `Input.Toggle`, `Input.Date`
- Supported action: `Action.Submit` only (no `Action.OpenUrl` in card actions for security reasons)
- Max card body nesting: 3 levels
- Keep cards concise — the Adaptive Cards SDK (v3) renders inside the chat transcript column

---

## Step 3: Register the Card in the Server Allowlist

Open `server/src/allowlist/cardActionAllowlist.ts` and add two entries:

**3a. Add the cardId to the allowed cards set** (if the file uses a set or array of permitted card IDs — check the existing pattern in the file):

Follow the existing pattern for registering `cardId` strings. If the file uses an array constant `ALLOWED_CARD_IDS`, add your cardId there.

**3b. Add a userSummary formatter.** Find the `CARD_SUMMARIES` record (or equivalent map) and add an entry:

```typescript
// In server/src/allowlist/cardActionAllowlist.ts
'feedback-survey': (data) => {
  const d = data as { satisfaction?: string; comments?: string };
  const labels: Record<string, string> = {
    '5': 'Very Satisfied',
    '4': 'Satisfied',
    '3': 'Neutral',
    '2': 'Dissatisfied',
    '1': 'Very Dissatisfied',
  };
  const rating = labels[d.satisfaction ?? ''] ?? 'No rating';
  return d.comments
    ? `Feedback: ${rating} — "${d.comments.slice(0, 60)}${d.comments.length > 60 ? '…' : ''}"`
    : `Feedback: ${rating}`;
},
```

The formatter receives `data: unknown` from the card submission payload. Cast it safely. Return a human-readable summary string (shown in the chat transcript as a submission chip).

**Summary string guidelines:**
- ≤80 characters is ideal (fits in transcript chip)
- Include the card's key submitted value(s)
- Truncate long free-text inputs with ellipsis
- Never include raw form field names — use human labels

---

## Step 4: Write a Test

Add a test case to `server/src/allowlist/cardActionAllowlist.test.ts` (or the equivalent test file — see existing tests for pattern):

```typescript
describe('feedback-survey card', () => {
  it('accepts a valid submission', () => {
    const submitData = { action: 'Action.Submit', cardId: 'feedback-survey', satisfaction: '5' };
    const result = validateCardAction(submitData);
    expect(result.ok).toBe(true);
  });

  it('generates correct summary for Very Satisfied', () => {
    // Call the summary formatter directly or via the allowlist validation path
    // Follow existing test patterns in the file
    const summary = CARD_SUMMARIES['feedback-survey']({ satisfaction: '5' });
    expect(summary).toBe('Feedback: Very Satisfied');
  });

  it('truncates long comments', () => {
    const longComment = 'a'.repeat(100);
    const summary = CARD_SUMMARIES['feedback-survey']({ satisfaction: '4', comments: longComment });
    expect(summary).toContain('…');
  });
});
```

Run `npm test` to confirm the new tests pass.

---

## Reference

### Card Input Types

| Type | Use For | Key Properties |
|------|---------|----------------|
| `Input.Text` | Short text, free-form | `id`, `placeholder`, `isMultiline`, `maxLength` |
| `Input.Number` | Numeric values | `id`, `min`, `max`, `placeholder` |
| `Input.ChoiceSet` | Multiple choice | `id`, `style` (compact/expanded), `choices[]`, `isMultiRequired` |
| `Input.Toggle` | Yes/No boolean | `id`, `title`, `valueOn`, `valueOff` |
| `Input.Date` | Date selection | `id`, `min`, `max` |

### File Checklist

When adding a new card, ensure all of these exist:

- [ ] `docs/cards/{cardId}.json` — card schema JSON (v1.5)
- [ ] Entry in `server/src/allowlist/cardActionAllowlist.ts` — cardId registered
- [ ] Summary formatter in `CARD_SUMMARIES` for the cardId
- [ ] Test cases in `cardActionAllowlist.test.ts`

### Resources

- [Adaptive Cards Designer (visual editor)](https://adaptivecards.io/designer/)
- [Adaptive Cards Schema Explorer (v1.5)](https://adaptivecards.io/explorer/)
- [Adaptive Cards Samples](https://adaptivecards.io/samples/)
```

Write the playbook with all sections as shown above. The playbook must be self-contained: a card author reading only this file plus the existing `docs/cards/feedback-survey.json` should have everything needed to add a new card.
  </action>
  <verify>
1. `python3 -c "import json; json.load(open('docs/cards/feedback-survey.json')); print('JSON valid')"` — valid JSON
2. `python3 -c "import json; d=json.load(open('docs/cards/feedback-survey.json')); assert d['type']=='AdaptiveCard'; assert d['version']=='1.5'; print('Schema valid')"` — schema assertions pass
3. `grep "cardId" docs/cards/feedback-survey.json` — cardId present in action data
4. `grep "Step 1\|Step 2\|Step 3\|Step 4" docs/adaptive-card-playbook.md` — four steps present
5. `grep "cardActionAllowlist" docs/adaptive-card-playbook.md` — allowlist file reference present
6. `grep "feedback-survey.json" docs/adaptive-card-playbook.md` — sample card referenced
7. `wc -l docs/adaptive-card-playbook.md` — at least 100 lines
  </verify>
  <done>
docs/cards/feedback-survey.json exists with valid Adaptive Card v1.5 JSON including cardId in action data. docs/adaptive-card-playbook.md exists with all four steps (choose ID, create JSON, register in allowlist with summary formatter, write tests), a file checklist, and external resource links. A card author can follow the playbook without reading source code.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. README.md: `wc -l README.md` ≥ 80; env var table has VITE_API_URL + all COPILOT_* vars; `npm run dev` present; playbook cross-reference present
2. docs/cards/feedback-survey.json: valid JSON; type=AdaptiveCard; version=1.5; cardId in action data
3. docs/adaptive-card-playbook.md: four steps present; references cardActionAllowlist.ts; references feedback-survey.json; ≥100 lines
4. `npm test` — no regressions (documentation doesn't touch source)
</verification>

<success_criteria>
- README.md at repo root enables cold-start developer to configure .env, run npm run dev, run npm test
- docs/adaptive-card-playbook.md enables a card author to add a new card in four steps without reading source code
- docs/cards/feedback-survey.json is a valid Adaptive Card v1.5 JSON used as worked example in the playbook
- All three files cross-reference each other appropriately (README → playbook, playbook → feedback-survey.json, playbook → cardActionAllowlist.ts path)
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-metadata-drawer-ci-and-docs/04-03-SUMMARY.md` summarizing what was written, file sizes (line counts), and any structural decisions made.
</output>
