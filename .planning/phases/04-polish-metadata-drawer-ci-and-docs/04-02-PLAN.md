---
phase: 04-polish-metadata-drawer-ci-and-docs
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
autonomous: true
requirements: [INFRA-07]

must_haves:
  truths:
    - "Pushing to main or opening a PR against main triggers the GitHub Actions workflow automatically"
    - "The lint-test job runs npm ci, npm run lint, and npm test in sequence; the job fails if any command exits non-zero"
    - "The security-checks job fails with exit code 1 if grep finds any COPILOT_* assignment patterns in client/ source files"
    - "The security-checks job fails with exit code 1 if npm ls zod shows more than one Zod instance installed"
    - "The two jobs (lint-test and security-checks) run in parallel as separate jobs on ubuntu-latest"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI workflow with lint-test and security-checks jobs"
      contains: "on:\n  push"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "npm run lint"
      via: "lint-test job step"
      pattern: "npm run lint"
    - from: ".github/workflows/ci.yml"
      to: "grep.*COPILOT.*client/"
      via: "security-checks job credential-leak step"
      pattern: "grep.*COPILOT"
    - from: ".github/workflows/ci.yml"
      to: "npm ls zod"
      via: "security-checks job Zod-instance step"
      pattern: "npm ls zod"
---

<objective>
Create the GitHub Actions CI workflow (INFRA-07) that lints, tests, and runs security checks on every push and pull request.

Purpose: Enforce code quality and prevent credential leaks and Zod instance duplication from merging to main. Automated gate replaces manual audits.
Output: `.github/workflows/ci.yml` — two parallel jobs (lint-test, security-checks).
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish-metadata-drawer-ci-and-docs/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml`. Create the `.github/workflows/` directory first if it does not exist.

The workflow must have exactly two jobs that run in parallel:

**Job 1: lint-test**
- `name: Lint & Test`
- `runs-on: ubuntu-latest`
- Steps:
  1. `actions/checkout@v4`
  2. `actions/setup-node@v4` with `node-version: 20` and `cache: 'npm'`
  3. `run: npm ci` (name: "Install dependencies")
  4. `run: npm run lint` (name: "Lint")
  5. `run: npm test` (name: "Test")

**Job 2: security-checks**
- `name: Security Checks`
- `runs-on: ubuntu-latest`
- Steps:
  1. `actions/checkout@v4`
  2. `actions/setup-node@v4` with `node-version: 20` and `cache: 'npm'`
  3. `run: npm ci` (name: "Install dependencies")
  4. Credential leak check step (name: "Check credential leaks"):
     ```bash
     if grep -r "COPILOT_[A-Z_]*=" client/ 2>/dev/null | grep -v "node_modules" | grep -v ".git" | grep -q .; then
       echo "FAIL: Copilot credentials found in client code"
       grep -r "COPILOT_[A-Z_]*=" client/ | grep -v "node_modules" | grep -v ".git"
       exit 1
     fi
     echo "PASS: No credential leaks detected"
     ```
     Pattern `COPILOT_[A-Z_]*=` catches only assignment patterns (e.g., `COPILOT_TENANT_ID=somevalue`) not legitimate code identifiers like `CopilotStudioClient`. This avoids the false-positive pitfall documented in RESEARCH.md.
  5. Zod instance count check step (name: "Check Zod instance count"):
     ```bash
     ZOD_COUNT=$(npm ls zod --depth=Infinity 2>/dev/null | grep -c "zod@" || echo "0")
     if [ "$ZOD_COUNT" -ne 1 ]; then
       echo "FAIL: Expected 1 Zod instance, found $ZOD_COUNT"
       npm ls zod
       exit 1
     fi
     echo "PASS: Single Zod instance verified (count=$ZOD_COUNT)"
     ```
     Using `--depth=Infinity` (npm v10 flag) ensures the full dependency tree is checked, not just direct deps. The `|| echo "0"` guards against grep returning exit code 1 when no matches.

**Trigger block:**
```yaml
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
```

Full file example structure:
```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      ...

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      ...
```

Important: Do NOT use `--depth=0` for the Zod check — that only checks direct dependencies of the root workspace, not the full tree where duplicate Zod instances would appear. Use `--depth=Infinity`.
  </action>
  <verify>
1. Run `cd /Users/zycroft/Documents/PA/aaae && node -e "const yaml = require('js-yaml'); yaml.load(require('fs').readFileSync('.github/workflows/ci.yml', 'utf8')); console.log('YAML valid')" 2>&1` — if js-yaml not available, use Python: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml')); print('YAML valid')"`
2. Verify both jobs exist: `grep -E "lint-test:|security-checks:" .github/workflows/ci.yml`
3. Verify credential-leak pattern: `grep "COPILOT_\[A-Z_\]" .github/workflows/ci.yml`
4. Verify Zod check: `grep "npm ls zod" .github/workflows/ci.yml`
5. Verify triggers: `grep -A4 "^on:" .github/workflows/ci.yml`
  </verify>
  <done>
.github/workflows/ci.yml exists with valid YAML syntax. Both jobs (lint-test, security-checks) are present. Workflow triggers on push and pull_request to main. Credential check uses COPILOT_[A-Z_]*= pattern (not bare COPILOT). Zod check uses --depth=Infinity and counts instances.
  </done>
</task>

</tasks>

<verification>
After task completion:
1. YAML is valid (python3 or js-yaml parse succeeds)
2. Both jobs present in file
3. `git diff --stat` shows only `.github/workflows/ci.yml` added
4. Workflow will be triggered on next push to main or PR open — no local execution possible, but structure is validated
</verification>

<success_criteria>
- `.github/workflows/ci.yml` exists with valid YAML
- Triggers: push and pull_request on branches: [main]
- Job 1 (lint-test): npm ci → npm run lint → npm test
- Job 2 (security-checks): npm ci → grep COPILOT_[A-Z_]*= in client/ (fails if found) → npm ls zod --depth=Infinity (fails if count ≠ 1)
- Both jobs run in parallel (no `needs:` dependency between them)
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-metadata-drawer-ci-and-docs/04-02-SUMMARY.md` summarizing what was built and any decisions made (especially around the grep pattern and Zod depth flag).
</output>
