---
phase: 04-polish-metadata-drawer-ci-and-docs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/components/MetadataPane.tsx
  - client/src/components/ChatShell.tsx
  - client/src/components/chat.css
autonomous: true
requirements: [UI-11, UI-12]

must_haves:
  truths:
    - "On desktop (≥768px), the metadata sidebar is visible and lists all adaptiveCard-kind messages in chronological order with card ID and summary text"
    - "When no card actions exist, the sidebar shows a non-empty placeholder rather than a blank container"
    - "Clicking the Download Activity Log button triggers a browser file download of a valid JSON file containing all conversation messages"
    - "The downloaded JSON includes exportedAt ISO timestamp, messageCount, and the full messages array"
  artifacts:
    - path: "client/src/components/MetadataPane.tsx"
      provides: "MetadataPane component — filters messages to adaptiveCard kind, renders ordered list and download button"
      exports: ["MetadataPane"]
    - path: "client/src/components/ChatShell.tsx"
      provides: "ChatShell wired to pass messages prop to MetadataPane replacing placeholder aside"
      contains: "MetadataPane"
    - path: "client/src/components/chat.css"
      provides: "metadataPaneHeader, activityTimeline, timelineItem, downloadButton CSS classes"
  key_links:
    - from: "client/src/components/ChatShell.tsx"
      to: "client/src/components/MetadataPane.tsx"
      via: "messages prop (NormalizedMessage[])"
      pattern: "messages={messages}"
    - from: "client/src/components/MetadataPane.tsx"
      to: "NormalizedMessage.kind"
      via: "filter((m) => m.kind === 'adaptiveCard')"
      pattern: "kind.*adaptiveCard"
    - from: "download button onClick"
      to: "Blob + URL.createObjectURL"
      via: "downloadActivityLog() function inside MetadataPane"
      pattern: "URL\\.createObjectURL"
---

<objective>
Implement the metadata drawer sidebar (UI-11) and activity log download button (UI-12) by building a MetadataPane component and wiring it into ChatShell.

Purpose: Give desktop users visibility into their card action history and the ability to export the full conversation as a JSON file.
Output: MetadataPane.tsx component; ChatShell.tsx updated to wire messages through; chat.css updated with timeline and button styles.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-polish-metadata-drawer-ci-and-docs/04-RESEARCH.md
@client/src/components/ChatShell.tsx
@client/src/components/chat.css
@shared/src/schemas/message.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build MetadataPane component with timeline and download</name>
  <files>client/src/components/MetadataPane.tsx</files>
  <action>
Create `client/src/components/MetadataPane.tsx`. This component receives `messages: NormalizedMessage[]` as its only prop (import the type from `@copilot-chat/shared`).

Inside the component:
1. Filter to card actions: `const cardActions = messages.filter((m) => m.kind === 'adaptiveCard');`
2. Define `downloadActivityLog` as an inner function (not exported). It must:
   - Build `{ exportedAt: new Date().toISOString(), messageCount: messages.length, messages }` as the export object
   - Create `new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })`
   - Create an anchor element via `document.createElement('a')`, set `href = URL.createObjectURL(blob)`, set `download = \`activity-log-${new Date().toISOString().slice(0, 10)}.json\``
   - Append to body, click, remove from body, then `URL.revokeObjectURL(url)` — this avoids memory leaks
3. Render structure:
   ```tsx
   <aside className="metadataPane" aria-label="Activity log">
     <div className="metadataPaneHeader">
       <h2 className="metadataPaneTitle">Activity Log</h2>
       <button className="downloadButton" onClick={downloadActivityLog} aria-label="Download activity log as JSON">
         Download
       </button>
     </div>
     {cardActions.length === 0 ? (
       <p className="metadataPanePlaceholder">No card actions yet</p>
     ) : (
       <ol className="activityTimeline">
         {cardActions.map((action, idx) => (
           <li key={action.id} className="timelineItem">
             <span className="timelineIndex" aria-label={`Action ${idx + 1}`}>#{idx + 1}</span>
             <span className="cardId">{action.cardId ?? 'unknown'}</span>
             {action.text && <p className="actionSummary">{action.text}</p>}
           </li>
         ))}
       </ol>
     )}
   </aside>
   ```

Import `'./chat.css'` for styles (no separate CSS file — styles go in the existing chat.css in Task 2).

Do NOT use `adaptivecards-react` or any library. This is pure React functional component.
  </action>
  <verify>
Run `cd /Users/zycroft/Documents/PA/aaae && npx tsc --noEmit -p client/tsconfig.json 2>&1 | head -20` — should produce no type errors on MetadataPane.tsx.
  </verify>
  <done>MetadataPane.tsx exists, TypeScript compiles cleanly, component filters adaptiveCard messages, renders placeholder when empty, renders ordered list when messages exist, download button creates Blob and triggers file download.</done>
</task>

<task type="auto">
  <name>Task 2: Wire MetadataPane into ChatShell and add CSS</name>
  <files>client/src/components/ChatShell.tsx, client/src/components/chat.css</files>
  <action>
**ChatShell.tsx** — Replace the hardcoded `<aside>` placeholder with the new component:
1. Add import: `import { MetadataPane } from './MetadataPane.js';`
2. Replace the existing aside block:
   ```tsx
   {/* Phase 4: metadata drawer — UI-11, UI-12 */}
   <MetadataPane messages={messages} />
   ```
   Remove the old `<aside className="metadataPane" aria-label="Metadata panel"><p className="metadataPanePlaceholder">Activity log (Phase 4)</p></aside>` entirely.

**chat.css** — Add styles for the new classes (append after the existing `.metadataPane` block, before the closing media query or at end of file in the responsive section):

```css
.metadataPaneHeader {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-3) var(--space-4);
  border-bottom: 1px solid var(--color-border);
  gap: var(--space-2);
}

.metadataPaneTitle {
  font-size: var(--font-size-sm);
  font-weight: 600;
  color: var(--color-text-primary);
  margin: 0;
}

.downloadButton {
  font-size: var(--font-size-xs, 0.75rem);
  padding: var(--space-1) var(--space-2);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm, 4px);
  background: var(--color-surface);
  color: var(--color-text-primary);
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
}

.downloadButton:hover {
  background: var(--color-surface-hover, var(--color-border));
}

.downloadButton:focus-visible {
  outline: 2px solid var(--color-focus, #0057b8);
  outline-offset: 2px;
}

.activityTimeline {
  list-style: none;
  margin: 0;
  padding: var(--space-2) 0;
}

.timelineItem {
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
  padding: var(--space-2) var(--space-4);
  border-bottom: 1px solid var(--color-border);
}

.timelineIndex {
  font-size: var(--font-size-xs, 0.75rem);
  color: var(--color-text-muted);
  font-variant-numeric: tabular-nums;
}

.cardId {
  font-size: var(--font-size-sm);
  font-weight: 500;
  color: var(--color-text-primary);
  font-family: var(--font-mono, monospace);
  word-break: break-all;
}

.actionSummary {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary, var(--color-text-muted));
  margin: 0;
  line-height: 1.4;
}
```

Preserve ALL existing CSS. Do not touch `.metadataPane`, `.metadataPanePlaceholder`, or the `@media (min-width: 768px)` block that enables the sidebar — these remain unchanged.
  </action>
  <verify>
1. Run `cd /Users/zycroft/Documents/PA/aaae && npx tsc --noEmit -p client/tsconfig.json 2>&1` — no type errors.
2. Run `cd /Users/zycroft/Documents/PA/aaae && npm run lint 2>&1 | tail -10` — lint passes (warnings OK, errors not OK).
  </verify>
  <done>ChatShell.tsx passes messages to MetadataPane (no hardcoded aside placeholder). TypeScript compiles. Lint passes. New CSS classes exist in chat.css without removing or overriding any existing rules.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `npx tsc --noEmit -p client/tsconfig.json` — zero type errors
2. `npm run lint` — passes (no errors; warnings acceptable for existing ESLint JSX debt)
3. `npm test` — existing tests still pass (no regression)
4. Visual check: `npm run dev`, navigate to app, send a message with an Adaptive Card → sidebar shows timeline item with card ID and summary. With no card actions, sidebar shows "No card actions yet". Download button triggers file save.
</verification>

<success_criteria>
- MetadataPane.tsx exists and is wired into ChatShell.tsx
- On desktop (≥768px), metadataPane is visible (CSS already handles this) with Activity Log header and Download button
- Sidebar shows "No card actions yet" when messages contain no adaptiveCard items
- Sidebar renders an ordered list of card actions (cardId, sequence number, optional summary text) when adaptiveCard messages exist
- Download button saves `activity-log-YYYY-MM-DD.json` containing `{ exportedAt, messageCount, messages }`
- TypeScript compiles; lint passes; existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-metadata-drawer-ci-and-docs/04-01-SUMMARY.md` summarizing what was built, files modified, and any decisions made.
</output>
