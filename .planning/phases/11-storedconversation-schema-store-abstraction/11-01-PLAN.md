---
phase: 11-storedconversation-schema-store-abstraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/schemas/storedConversation.ts
  - shared/src/index.ts
autonomous: true
requirements:
  - STATE-01
  - STATE-02
  - STATE-03
  - STATE-04
  - STATE-05
  - STATE-06

must_haves:
  truths:
    - "StoredConversationSchema exports from shared/ with userId, tenantId, createdAt, updatedAt, status fields"
    - "Old records missing new fields deserialize without error via Zod .default() chains"
    - "StoredConversation TypeScript type is inferred from the Zod schema and exported from shared/"
    - "Optional workflow fields (workflowId, currentStep, stepData, metadata) are present but not required"
  artifacts:
    - path: "shared/src/schemas/storedConversation.ts"
      provides: "StoredConversationSchema Zod object + StoredConversation TypeScript type"
      exports:
        - StoredConversationSchema
        - StoredConversation
    - path: "shared/src/index.ts"
      provides: "Barrel export of StoredConversationSchema and StoredConversation"
      contains: "StoredConversationSchema"
  key_links:
    - from: "shared/src/schemas/storedConversation.ts"
      to: "shared/src/schemas/message.ts"
      via: "import NormalizedMessageSchema"
      pattern: "NormalizedMessageSchema"
    - from: "shared/src/index.ts"
      to: "shared/src/schemas/storedConversation.ts"
      via: "named re-export"
      pattern: "StoredConversationSchema"
---

<objective>
Define the StoredConversation Zod schema in shared/ as the single source of truth for persistent conversation state.

Purpose: Establish the data model that Phase 12 (RedisStore) and Phase 13 (route integration) will use. The schema replaces the plain TypeScript interface currently in server/src/store/ConversationStore.ts with a Zod-validated, backward-compatible persistent entity living in shared/.

Output:
- shared/src/schemas/storedConversation.ts (new)
- shared/src/index.ts (updated — adds StoredConversation exports)
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/src/schemas/message.ts
@shared/src/index.ts
@.planning/phases/11-storedconversation-schema-store-abstraction/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StoredConversation Zod schema in shared/</name>
  <files>shared/src/schemas/storedConversation.ts</files>
  <action>
Create shared/src/schemas/storedConversation.ts with the following structure:

```typescript
import { z } from 'zod';
import { NormalizedMessageSchema } from './message.js';

/**
 * StoredConversation — the persistent entity for a conversation.
 *
 * Combines transport data (externalId, sdkConversationRef, history) with
 * persistence metadata (userId, tenantId, timestamps, status) and optional
 * workflow fields for v1.5 Workflow Orchestrator.
 *
 * Backward compatible: old records without new fields deserialize with
 * Zod .default() values — never fail on missing fields.
 *
 * STATE-01, STATE-02, STATE-03, STATE-04, STATE-05, STATE-06
 */
export const StoredConversationSchema = z.object({
  // ─── Existing Transport Data ───
  /** Server-generated UUID — external identifier sent to clients */
  externalId: z.string().uuid(),

  /**
   * Opaque Copilot SDK conversation reference.
   * Typed as unknown — never serialize to JSON (class instance, not JSON-safe).
   * Routes cast to the appropriate SDK type when needed.
   */
  sdkConversationRef: z.unknown(),

  /** Full message history for this conversation */
  history: z.array(NormalizedMessageSchema),

  // ─── Persistence Metadata (Phase 11) ───
  /** User who owns this conversation; populated from JWT claims in Phase 13 */
  userId: z.string().min(1).default('anonymous'),

  /** Tenant ID for multi-tenancy; populated from JWT claims in Phase 13 */
  tenantId: z.string().min(1).default('dev'),

  /** Creation timestamp in ISO 8601 format */
  createdAt: z.string().datetime().default(() => new Date().toISOString()),

  /** Last modification timestamp in ISO 8601 format */
  updatedAt: z.string().datetime().default(() => new Date().toISOString()),

  /** Conversation lifecycle state */
  status: z.enum(['active', 'completed', 'abandoned']).default('active'),

  // ─── Optional Workflow Fields (v1.5 Workflow Orchestrator) ───
  /** ID of the workflow this conversation is executing */
  workflowId: z.string().uuid().optional(),

  /** Current step number in the workflow */
  currentStep: z.number().nonnegative().optional(),

  /** Step-specific data (arbitrary key-value pairs) */
  stepData: z.record(z.string(), z.unknown()).optional(),

  /** Conversation-level metadata (arbitrary key-value pairs) */
  metadata: z.record(z.string(), z.unknown()).optional(),
});

/** TypeScript type inferred from StoredConversationSchema */
export type StoredConversation = z.infer<typeof StoredConversationSchema>;
```

Critical implementation notes:
- `.default(() => new Date().toISOString())` MUST use an arrow function — not `.default(new Date().toISOString())`. The arrow function form is called at parse time per record; the non-function form is evaluated once at schema definition (server startup) giving every old record the same timestamp.
- `sdkConversationRef: z.unknown()` stays as-is — this field holds the live SDK object in memory and is never round-tripped through Redis JSON serialization. The server stores only the conversationId string in Redis; sdkConversationRef is reconstructed in memory.
- Do NOT add `.optional()` to userId or tenantId — they have defaults and will always be present after deserialization.
  </action>
  <verify>
Run: `cd /Users/zycroft/Documents/PA/aaae/shared && npm run build`
Expected: Zero TypeScript errors. The compiled output appears in shared/dist/.
Also confirm: `grep -n "StoredConversationSchema" shared/src/schemas/storedConversation.ts` shows the export.
  </verify>
  <done>
shared/src/schemas/storedConversation.ts exists and compiles without errors. Schema exports StoredConversationSchema and StoredConversation type. Default values use arrow function form for datetime fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export StoredConversation from shared/ barrel</name>
  <files>shared/src/index.ts</files>
  <action>
Add the StoredConversation exports to shared/src/index.ts.

Add this export block after the existing WorkflowState export block and before the api.ts block (or at the logical end of schema exports, consistent with the existing ordering):

```typescript
export {
  StoredConversationSchema,
  type StoredConversation,
} from './schemas/storedConversation.js';
```

Then rebuild shared/ so the new exports are available to server/:

```bash
cd /Users/zycroft/Documents/PA/aaae/shared && npm run build
```

IMPORTANT: After adding the export block, run `npm run build` from the shared/ directory to compile the updated index. The server workspace imports from `@copilot-chat/shared` which resolves to shared/dist/index.js — the server will not see the new types until shared/ is rebuilt.
  </action>
  <verify>
1. Run: `cd /Users/zycroft/Documents/PA/aaae/shared && npm run build` — zero errors
2. Run: `node -e "try { const s = require('./shared/dist/index.js'); console.log(typeof s.StoredConversationSchema); } catch(e) { console.error('FAILED:', e.message); process.exit(1); }"` from /Users/zycroft/Documents/PA/aaae — should print "object"
3. Run: `cd /Users/zycroft/Documents/PA/aaae && npm run lint 2>&1 | grep -i "storedConversation" | head -5` — expect no lint errors for the new file
  </verify>
  <done>
shared/src/index.ts exports StoredConversationSchema and StoredConversation type. shared/ builds cleanly. StoredConversationSchema is accessible at runtime from shared/dist/index.js.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/zycroft/Documents/PA/aaae/shared && npm run build` — zero TypeScript errors
2. Backward compatibility — parse a minimal old-format record (only the three original fields, no new fields):
   `node -e "try { const s = require('./shared/dist/index.js'); const sc = s.StoredConversationSchema.parse({ externalId: '00000000-0000-0000-0000-000000000001', sdkConversationRef: null, history: [] }); console.log('OK:', sc.userId, sc.status, sc.createdAt); } catch(e) { console.error('BACKWARD COMPAT FAILED:', e.message); process.exit(1); }"` from /Users/zycroft/Documents/PA/aaae — must print "OK: anonymous active <ISO timestamp>" without throwing. This confirms defaults are applied when userId, tenantId, timestamps, and status are absent.
3. Parsing with optional workflow fields (workflowId, currentStep, stepData, metadata) omitted also succeeds — same command confirms this since none are present in the minimal record.
4. Confirm no new fields are required: the parse in step 2 uses only `{ externalId, sdkConversationRef, history }` — the original three fields — proving full backward compatibility.
</verification>

<success_criteria>
- shared/src/schemas/storedConversation.ts exists with all fields from STATE-01 through STATE-04
- StoredConversationSchema and StoredConversation exported from shared/src/index.ts (STATE-05)
- Parsing a minimal record {externalId, sdkConversationRef, history} succeeds with defaults applied (STATE-06)
- shared/ builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-storedconversation-schema-store-abstraction/11-01-SUMMARY.md` documenting:
- Files created/modified
- Key decisions (arrow function defaults, sdkConversationRef as z.unknown(), default values)
- Export shape
- Any deviations from the plan
</output>
