---
phase: 19-workflowstate-schema-client-state-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/schemas/workflowState.ts
  - shared/src/schemas/workflowState.test.ts
autonomous: true
requirements: [SCHEMA-01, SCHEMA-02, SCHEMA-03]

must_haves:
  truths:
    - "WorkflowState Zod schema includes progress (null|number 0-1), suggestedInputType ('text'|'choice'|'confirmation'|'none'), and choices (string array)"
    - "All new fields are optional/nullable — absence produces valid parse result (backward compatible)"
    - "SendMessageResponse and CardActionResponse already include optional workflowState — existing tests pass unchanged"
    - "shared/ builds without TypeScript errors after schema extension"
  artifacts:
    - path: "shared/src/schemas/workflowState.ts"
      provides: "Extended WorkflowState Zod schema with v1.6 UX fields"
      exports: ["WorkflowStateSchema", "WorkflowState"]
    - path: "shared/src/schemas/workflowState.test.ts"
      provides: "Tests covering new fields and backward compat"
      contains: "suggestedInputType, progress, choices"
  key_links:
    - from: "shared/src/schemas/workflowState.ts"
      to: "shared/src/schemas/api.ts"
      via: "WorkflowStateSchema import — existing api.ts uses it for optional workflowState field"
      pattern: "WorkflowStateSchema\\.optional\\(\\)"
    - from: "shared/src/index.ts"
      to: "shared/src/schemas/workflowState.ts"
      via: "barrel export — WorkflowStateSchema and WorkflowState re-exported"
      pattern: "export.*WorkflowState"
---

<objective>
Extend the existing WorkflowStateSchema in shared/ with v1.6 client UX fields: progress, suggestedInputType, and choices — all nullable/optional for backward compatibility.

Purpose: Downstream UI components (Phases 20-21) need typed access to server-returned workflow UX hints. This plan creates the schema contract they will consume.
Output: Extended workflowState.ts + passing TDD tests proving backward compat and new field behavior.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/src/schemas/workflowState.ts
@shared/src/schemas/api.ts
@shared/src/index.ts
</context>

<feature>
  <name>WorkflowState v1.6 UX field extension</name>
  <files>shared/src/schemas/workflowState.ts, shared/src/schemas/workflowState.test.ts</files>
  <behavior>
    The existing WorkflowStateSchema has: step (string, required), turnCount (int, required), status ('active'|'completed'|'error'), collectedData (optional), currentPhase (optional), lastRecommendation (optional), userId (optional), tenantId (optional).

    Add three new optional/nullable fields for v1.6 UX:
    - progress: z.number().min(0).max(1).nullable().optional() — workflow progress as 0-1 float, null = indeterminate
    - suggestedInputType: z.enum(['text', 'choice', 'confirmation', 'none']).optional() — hints the client about input mode
    - choices: z.array(z.string()).optional() — list of choices when suggestedInputType is 'choice'

    Cases:
    - { step: 'gather_info', turnCount: 1 } → valid (minimal, no UX fields)
    - { step: 'confirm', turnCount: 2, progress: 0.5 } → valid, progress = 0.5
    - { step: 'confirm', turnCount: 2, progress: null } → valid, progress = null (indeterminate)
    - { step: 'gather_info', turnCount: 1, suggestedInputType: 'choice', choices: ['Option A', 'Option B'] } → valid
    - { step: 'gather_info', turnCount: 1, suggestedInputType: 'confirmation' } → valid, choices undefined
    - { step: 'gather_info', turnCount: 1, progress: 1.1 } → INVALID (>1)
    - { step: 'gather_info', turnCount: 1, progress: -0.1 } → INVALID (<0)
    - { step: 'gather_info', turnCount: 1, suggestedInputType: 'unknown' } → INVALID (not in enum)
  </behavior>
  <implementation>
    RED: Add failing tests to workflowState.test.ts for all new field cases above. Run `cd shared && npm test` — must fail on new test cases.

    GREEN: Extend WorkflowStateSchema in workflowState.ts with the three new fields. Run `cd shared && npm test` — all tests must pass including the original 8 tests.

    REFACTOR: Ensure JSDoc comment on the schema mentions SCHEMA-01. Run `cd shared && npm run build` — TypeScript must compile cleanly.

    After passing tests: run `cd shared && npm run build` to rebuild dist/ so client and server can import updated types.
  </implementation>
</feature>

<tasks>

<task type="tdd">
  <name>Task 1: RED — Add failing tests for v1.6 WorkflowState UX fields</name>
  <files>shared/src/schemas/workflowState.test.ts</files>
  <action>
    Append a new describe block to the existing workflowState.test.ts file. DO NOT modify or delete the existing 8 tests — they must continue to pass.

    Add describe block: 'WorkflowStateSchema v1.6 UX fields (SCHEMA-01, SCHEMA-03)' with these tests:
    1. 'accepts state with progress = 0.5' — safeParse with { step: 'confirm', turnCount: 2, progress: 0.5 }, expect success, data.progress === 0.5
    2. 'accepts state with progress = null (indeterminate)' — safeParse with { step: 'gather_info', turnCount: 1, progress: null }, expect success, data.progress === null
    3. 'accepts state without progress (backward compat)' — safeParse with { step: 'initial', turnCount: 0 }, expect success, data.progress === undefined
    4. 'rejects progress > 1' — safeParse with { step: 'gather_info', turnCount: 1, progress: 1.1 }, expect success === false
    5. 'rejects progress < 0' — safeParse with { step: 'gather_info', turnCount: 1, progress: -0.1 }, expect success === false
    6. 'accepts suggestedInputType choices' — for each of ['text', 'choice', 'confirmation', 'none'], safeParse with { step: 'x', turnCount: 1, suggestedInputType: value }, expect success
    7. 'rejects unknown suggestedInputType' — safeParse with { step: 'x', turnCount: 1, suggestedInputType: 'unknown' }, expect success === false
    8. 'accepts choices array when suggestedInputType is choice' — safeParse with { step: 'x', turnCount: 1, suggestedInputType: 'choice', choices: ['A', 'B', 'C'] }, expect success, data.choices equals ['A', 'B', 'C']
    9. 'accepts state without suggestedInputType or choices (backward compat)' — safeParse with { step: 'gather_info', turnCount: 1 }, expect success, data.suggestedInputType === undefined, data.choices === undefined

    Run: cd /Users/zycroft/Documents/PA/aaae/shared && npm test
    Expected: The 8 original tests PASS. The new 9 tests FAIL with "received value does not match expected type" or similar (because schema doesn't have the fields yet).
  </action>
  <verify>cd /Users/zycroft/Documents/PA/aaae/shared && npm test 2>&1 | tail -20</verify>
  <done>New tests fail, original 8 tests pass. Test output confirms new test failures are schema-related (not syntax errors).</done>
</task>

<task type="tdd">
  <name>Task 2: GREEN — Extend WorkflowStateSchema with v1.6 UX fields</name>
  <files>shared/src/schemas/workflowState.ts</files>
  <action>
    Extend the WorkflowStateSchema z.object() definition in shared/src/schemas/workflowState.ts to add three new fields. Add them AFTER the existing fields (before the closing brace):

    ```typescript
    /** Workflow progress as 0–1 float (null = indeterminate/pulsing). SCHEMA-01 */
    progress: z.number().min(0).max(1).nullable().optional(),
    /** Hints the client about the preferred input mode for this step. SCHEMA-01 */
    suggestedInputType: z.enum(['text', 'choice', 'confirmation', 'none']).optional(),
    /** Available choices when suggestedInputType is 'choice'. SCHEMA-01 */
    choices: z.array(z.string()).optional(),
    ```

    Update the JSDoc comment on the schema to reference SCHEMA-01 in addition to ORCH-01.

    Run: cd /Users/zycroft/Documents/PA/aaae/shared && npm test
    Expected: ALL 17 tests (8 original + 9 new) pass.

    Then rebuild: cd /Users/zycroft/Documents/PA/aaae/shared && npm run build
    Expected: Zero TypeScript errors.
  </action>
  <verify>cd /Users/zycroft/Documents/PA/aaae/shared && npm test && npm run build</verify>
  <done>All 17 tests pass. npm run build exits 0. dist/ is updated with new type definitions.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd /Users/zycroft/Documents/PA/aaae/shared && npm test` — all tests pass (original 8 + new 9 = 17 total)
2. `cd /Users/zycroft/Documents/PA/aaae/shared && npm run build` — exits 0, no TypeScript errors
3. Check that `WorkflowState` type from `@copilot-chat/shared` now includes `progress?: number | null`, `suggestedInputType?: 'text' | 'choice' | 'confirmation' | 'none'`, `choices?: string[]`
4. Check that `api.ts` still compiles (uses `WorkflowStateSchema.optional()` — extension is additive, no break)
5. No hardcoded phase names or step counts in workflowState.ts — all values flow from server
</verification>

<success_criteria>
- WorkflowState Zod schema in shared/ has all SCHEMA-01 required fields: status (pre-existing), currentPhase (pre-existing), progress (new, nullable), collectedData (pre-existing), suggestedInputType (new), choices (new)
- All new fields are optional/nullable — parsing a v1.5-era WorkflowState with only {step, turnCount} succeeds (SCHEMA-03 backward compat)
- 17 shared/ tests pass, build is clean
- SendMessageResponse and CardActionResponse already use WorkflowStateSchema.optional() — no changes needed to api.ts (SCHEMA-02 already satisfied)
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflowstate-schema-client-state-foundation/19-01-SUMMARY.md`
</output>
