---
phase: 05-shared-schema-config-foundation
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - server/.env.example
  - client/.env.example
  - server/src/config.ts
autonomous: true
requirements:
  - CFG-01
  - CFG-02
  - CFG-03
  - CFG-04
  - CFG-05

must_haves:
  truths:
    - "server/.env.example contains AZURE_TENANT_NAME, AZURE_CLIENT_ID, and ALLOWED_TENANT_IDS entries with placeholder values"
    - "client/.env.example contains VITE_AZURE_CLIENT_ID, VITE_AZURE_TENANT_NAME, and VITE_AZURE_REDIRECT_URI entries with placeholder values"
    - "When AUTH_REQUIRED=true and AZURE_CLIENT_ID is not set, server/src/config.ts causes the server to refuse all requests (fails closed)"
    - "When AUTH_REQUIRED=false, server starts and serves requests without any Azure AD env vars present"
  artifacts:
    - path: server/.env.example
      provides: "Server Azure AD env var documentation"
      contains: "AZURE_TENANT_NAME"
    - path: client/.env.example
      provides: "Client Azure AD env var documentation"
      contains: "VITE_AZURE_CLIENT_ID"
    - path: server/src/config.ts
      provides: "Validated config with Azure AD fail-closed logic"
      contains: "AZURE_CLIENT_ID"
  key_links:
    - from: server/src/config.ts
      to: "process.env.AZURE_CLIENT_ID"
      via: "conditional process.exit(1) when AUTH_REQUIRED=true and AZURE_CLIENT_ID missing"
      pattern: "AZURE_CLIENT_ID"
    - from: server/src/middleware/auth.ts
      to: server/src/config.ts
      via: "config.AUTH_REQUIRED already checked in auth middleware"
      pattern: "config\\.AUTH_REQUIRED"
---

<objective>
Add all Azure AD environment variables to both workspace .env.example files and update the server config module to fail closed (refuse requests with process.exit or per-request rejection) when AUTH_REQUIRED=true but AZURE_CLIENT_ID is not set.

Purpose: Developers know exactly which environment variables to configure for MSAL auth. The fail-closed behavior prevents accidentally running with real auth disabled in environments where it should be enforced — no silent pass-through.
Output: Updated server/.env.example, client/.env.example, and server/src/config.ts.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing files to read before modifying
@server/.env.example
@client/.env.example
@server/src/config.ts
@server/src/middleware/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update .env.example files with Azure AD variables</name>
  <files>server/.env.example, client/.env.example</files>
  <action>
    Read both .env.example files first to understand existing content and preserve it exactly.

    Append to server/.env.example — add a new section block after existing content:

    ```
    # --- Azure AD / Entra External ID (Phase 6+) ---
    # Your Entra External ID tenant name (e.g. "contoso" from contoso.ciamlogin.com)
    AZURE_TENANT_NAME=your-tenant-name-here

    # Azure App Registration client ID for the SERVER application
    # From Azure Portal > App Registrations > your server app > Overview > Application (client) ID
    AZURE_CLIENT_ID=your-server-app-client-id-here

    # Comma-separated list of allowed tenant IDs (tid claims)
    # Only tokens from these tenants will be accepted. Leave blank to block all.
    ALLOWED_TENANT_IDS=tenant-id-1,tenant-id-2
    ```

    Append to client/.env.example — add a new section block after existing content:

    ```
    # --- Azure AD / Entra External ID (Phase 7+) ---
    # Azure App Registration client ID for the CLIENT (SPA) application
    # From Azure Portal > App Registrations > your client SPA app > Overview > Application (client) ID
    VITE_AZURE_CLIENT_ID=your-client-app-client-id-here

    # Your Entra External ID tenant name (e.g. "contoso" from contoso.ciamlogin.com)
    VITE_AZURE_TENANT_NAME=your-tenant-name-here

    # The redirect URI registered in Azure Portal for this SPA
    # Development: http://localhost:5173 (must be registered in Azure Portal > Authentication)
    VITE_AZURE_REDIRECT_URI=http://localhost:5173
    ```

    Do NOT remove or modify any existing entries in either file.
  </action>
  <verify>
    - `grep "AZURE_TENANT_NAME" /Users/zycroft/Documents/PA/aaae/server/.env.example` — found
    - `grep "AZURE_CLIENT_ID" /Users/zycroft/Documents/PA/aaae/server/.env.example` — found
    - `grep "ALLOWED_TENANT_IDS" /Users/zycroft/Documents/PA/aaae/server/.env.example` — found
    - `grep "VITE_AZURE_CLIENT_ID" /Users/zycroft/Documents/PA/aaae/client/.env.example` — found
    - `grep "VITE_AZURE_TENANT_NAME" /Users/zycroft/Documents/PA/aaae/client/.env.example` — found
    - `grep "VITE_AZURE_REDIRECT_URI" /Users/zycroft/Documents/PA/aaae/client/.env.example` — found
    - `grep "COPILOT_ENVIRONMENT_ID" /Users/zycroft/Documents/PA/aaae/server/.env.example` — existing entry preserved
  </verify>
  <done>Both .env.example files contain all required Azure AD variables with placeholder values and inline documentation comments. No existing entries removed.</done>
</task>

<task type="auto">
  <name>Task 2: Update server config to fail closed on missing AZURE_CLIENT_ID</name>
  <files>server/src/config.ts</files>
  <action>
    Read `server/src/config.ts` first. The current config validates COPILOT_ENVIRONMENT_ID and COPILOT_AGENT_SCHEMA_NAME via a REQUIRED array and calls process.exit(1) if missing.

    Update config.ts to also validate Azure AD variables when AUTH_REQUIRED=true:

    After the existing REQUIRED vars loop, add a conditional block:

    ```typescript
    // Azure AD config — required when AUTH_REQUIRED=true (fail-closed: never silently skip validation)
    if (process.env.AUTH_REQUIRED !== 'false') {
      if (!process.env.AZURE_CLIENT_ID) {
        console.error('[config] FATAL: AUTH_REQUIRED=true but AZURE_CLIENT_ID is not set.');
        console.error('[config] Set AZURE_CLIENT_ID in server/.env or set AUTH_REQUIRED=false for local dev without Azure AD.');
        process.exit(1);
      }
    }
    ```

    Then add the Azure AD vars to the exported config object:

    ```typescript
    AZURE_TENANT_NAME: process.env.AZURE_TENANT_NAME,
    AZURE_CLIENT_ID: process.env.AZURE_CLIENT_ID,
    ALLOWED_TENANT_IDS: process.env.ALLOWED_TENANT_IDS
      ? process.env.ALLOWED_TENANT_IDS.split(',').map((id) => id.trim()).filter(Boolean)
      : [],
    ```

    The `ALLOWED_TENANT_IDS` splits the comma-separated string into a string array. Filter removes empty strings from trailing commas.

    Important: The existing `AUTH_REQUIRED` logic already uses `process.env.AUTH_REQUIRED !== 'false'` — match this exact pattern for consistency. Do NOT change existing config entries or the REQUIRED array.

    The config object type inference will automatically include these optional fields. The `AZURE_CLIENT_ID` field will be `string | undefined` in the type (present when AUTH_REQUIRED=true, undefined when AUTH_REQUIRED=false — callers in Phase 6 will assert non-null after the guard).
  </action>
  <verify>
    Test fail-closed: `cd /Users/zycroft/Documents/PA/aaae/server && COPILOT_ENVIRONMENT_ID=x COPILOT_AGENT_SCHEMA_NAME=x AUTH_REQUIRED=true node -e "import('./src/config.js')" 2>&1 | grep -i "FATAL"` — must print FATAL error about AZURE_CLIENT_ID

    Test AUTH_REQUIRED=false passes: `cd /Users/zycroft/Documents/PA/aaae/server && COPILOT_ENVIRONMENT_ID=x COPILOT_AGENT_SCHEMA_NAME=x AUTH_REQUIRED=false node -e "import('./src/config.js').then(m => console.log('OK', Object.keys(m.config)))" 2>&1` — must print OK without FATAL

    TypeScript compilation: `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1 | tail -5` — exits 0 (or only pre-existing errors)

    Verify config exports: `grep "AZURE_CLIENT_ID" /Users/zycroft/Documents/PA/aaae/server/src/config.ts` — found in both the guard and the export
  </verify>
  <done>
    - When AUTH_REQUIRED=true (default) and AZURE_CLIENT_ID is missing: server logs FATAL and exits with code 1 — refuses to start
    - When AUTH_REQUIRED=false: server starts without any Azure AD vars
    - config.ts exports AZURE_TENANT_NAME, AZURE_CLIENT_ID, and ALLOWED_TENANT_IDS (as string[])
    - TypeScript builds cleanly
  </done>
</task>

</tasks>

<verification>
Run these after all tasks complete:

1. `grep -E "AZURE_TENANT_NAME|AZURE_CLIENT_ID|ALLOWED_TENANT_IDS" /Users/zycroft/Documents/PA/aaae/server/.env.example` — all three found
2. `grep -E "VITE_AZURE_CLIENT_ID|VITE_AZURE_TENANT_NAME|VITE_AZURE_REDIRECT_URI" /Users/zycroft/Documents/PA/aaae/client/.env.example` — all three found
3. Fail-closed test (must print FATAL and exit 1):
   `cd /Users/zycroft/Documents/PA/aaae/server && COPILOT_ENVIRONMENT_ID=x COPILOT_AGENT_SCHEMA_NAME=x AUTH_REQUIRED=true node --input-type=module <<< "import './src/config.js'" 2>&1; echo "exit: $?"`
4. AUTH_REQUIRED=false test (must succeed, no FATAL):
   `cd /Users/zycroft/Documents/PA/aaae/server && COPILOT_ENVIRONMENT_ID=x COPILOT_AGENT_SCHEMA_NAME=x AUTH_REQUIRED=false node --input-type=module <<< "import './src/config.js'; console.log('started ok')" 2>&1`
5. `cd /Users/zycroft/Documents/PA/aaae && npm run build` — exits 0
</verification>

<success_criteria>
- server/.env.example has AZURE_TENANT_NAME, AZURE_CLIENT_ID, ALLOWED_TENANT_IDS with placeholder values and comments
- client/.env.example has VITE_AZURE_CLIENT_ID, VITE_AZURE_TENANT_NAME, VITE_AZURE_REDIRECT_URI with placeholder values and comments
- server/src/config.ts fails closed (process.exit(1)) when AUTH_REQUIRED=true and AZURE_CLIENT_ID missing
- server/src/config.ts allows startup when AUTH_REQUIRED=false without Azure AD vars
- TypeScript build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-shared-schema-config-foundation/05-02-SUMMARY.md`
</output>
