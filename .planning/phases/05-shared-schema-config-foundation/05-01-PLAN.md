---
phase: 05-shared-schema-config-foundation
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/schemas/auth.ts
  - shared/src/index.ts
autonomous: true
requirements:
  - SCHEMA-01
  - SCHEMA-02

must_haves:
  truths:
    - "shared/src/schemas/auth.ts exports UserClaims Zod schema with fields sub, tid, email (optional), name (optional), oid"
    - "TypeScript type UserClaims is exported from shared and usable in server and client without any Zod import"
    - "shared barrel (index.ts) re-exports both UserClaimsSchema and the UserClaims type"
    - "shared package builds cleanly after adding auth.ts (cd shared && npm run build exits 0)"
  artifacts:
    - path: shared/src/schemas/auth.ts
      provides: "UserClaims Zod schema and TypeScript type"
      exports:
        - UserClaimsSchema
        - UserClaims
    - path: shared/src/index.ts
      provides: "Barrel export including auth schema"
      contains: "UserClaimsSchema"
  key_links:
    - from: shared/src/index.ts
      to: shared/src/schemas/auth.ts
      via: "named re-export"
      pattern: "from './schemas/auth"
    - from: shared/src/schemas/auth.ts
      to: zod
      via: "import { z } from 'zod'"
      pattern: "z\\.object"
---

<objective>
Create the UserClaims Zod schema in the shared workspace so both server and client can import a typed, validated shape for decoded JWT claims.

Purpose: Establishes the single source of truth for user identity data. Server will use this in Phase 6 JWT middleware to validate and type `req.user`; client references the type for display logic in Phase 7.
Output: `shared/src/schemas/auth.ts` with UserClaimsSchema + UserClaims type; `shared/src/index.ts` updated with re-exports; `shared/dist/` rebuilt.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern reference — follow the same structure as the existing message schema
@shared/src/schemas/message.ts
@shared/src/index.ts
</context>

<feature>
  <name>UserClaims Zod schema</name>
  <files>shared/src/schemas/auth.ts, shared/src/index.ts</files>
  <behavior>
    UserClaimsSchema must validate a decoded JWT claims object with these fields:
    - sub: string (required) — subject identifier (user unique ID)
    - tid: string (required) — tenant ID (used by org allowlist in Phase 6)
    - oid: string (required) — object ID (stable Azure AD user identifier)
    - email: string, optional — user email address
    - name: string, optional — display name

    Cases (schema behavior):
    - { sub: "u1", tid: "t1", oid: "o1" } → valid (passes parse)
    - { sub: "u1", tid: "t1", oid: "o1", email: "a@b.com", name: "Alice" } → valid
    - { sub: "u1", tid: "t1" } → INVALID (missing oid)
    - { tid: "t1", oid: "o1" } → INVALID (missing sub)
    - { sub: "u1", oid: "o1" } → INVALID (missing tid)
    - {} → INVALID
  </behavior>
  <implementation>
    RED phase:
    1. Create `shared/src/schemas/auth.test.ts` — write Vitest tests covering all cases above.
       Use `UserClaimsSchema.safeParse()` to check valid/invalid.
       Run: `cd shared && npm test` — tests MUST fail (UserClaimsSchema does not exist yet).

    GREEN phase:
    2. Create `shared/src/schemas/auth.ts`:
       - Import z from 'zod' (follows existing pattern in message.ts)
       - Define UserClaimsSchema as z.object({...}) with required sub/tid/oid (z.string()) and optional email/name (z.string().optional())
       - Export `type UserClaims = z.infer<typeof UserClaimsSchema>`
       - Add a JSDoc comment referencing SCHEMA-01 and SCHEMA-02
       Run: `cd shared && npm test` — tests MUST pass.

    3. Update `shared/src/index.ts`:
       - Add export block for UserClaimsSchema and type UserClaims from './schemas/auth.js'
       - Follow exact same pattern as the NormalizedMessageSchema export block already in index.ts

    4. Rebuild shared: `cd shared && npm run build`
       - Verify `shared/dist/` contains updated index.js and index.d.ts with UserClaims exports
       - Check with: `grep -r "UserClaims" shared/dist/`

    REFACTOR phase (if needed):
    5. Ensure JSDoc is clear. No logic changes needed — schema is simple.
  </implementation>
</feature>

<verification>
- `cd /Users/zycroft/Documents/PA/aaae/shared && npm test` — all tests pass including new auth schema tests
- `cd /Users/zycroft/Documents/PA/aaae/shared && npm run build` — exits 0
- `grep -r "UserClaims" /Users/zycroft/Documents/PA/aaae/shared/dist/` — finds exports in compiled output
- `grep "from './schemas/auth" /Users/zycroft/Documents/PA/aaae/shared/src/index.ts` — export wired
</verification>

<success_criteria>
- shared/src/schemas/auth.ts exists with UserClaimsSchema and UserClaims type
- shared/src/index.ts re-exports both UserClaimsSchema and UserClaims
- shared build succeeds (dist/ updated)
- All tests pass including auth schema tests (valid/invalid cases)
- No Zod added to client/ or server/ package.json (only shared/ uses Zod — per CLAUDE.md constraint)
</success_criteria>

<output>
After completion, create `.planning/phases/05-shared-schema-config-foundation/05-01-SUMMARY.md`
</output>
