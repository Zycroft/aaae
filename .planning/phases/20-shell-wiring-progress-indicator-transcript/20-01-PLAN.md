---
phase: 20-shell-wiring-progress-indicator-transcript
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - client/src/components/WorkflowProgress.tsx
  - client/src/components/WorkflowProgress.test.tsx
  - client/src/components/chat.css
autonomous: true
requirements: [PROG-01, PROG-02, PROG-03, COMPAT-03, TEST-01]

must_haves:
  truths:
    - "WorkflowProgress renders a phase label and filled progress bar (0-100%) when workflow is active with numeric progress"
    - "WorkflowProgress renders a pulsing/indeterminate bar when progress is null and workflow is active"
    - "WorkflowProgress renders nothing (null) when workflowState is null — no layout shift"
    - "WorkflowProgress animates phase label changes smoothly via CSS transition"
    - "All WorkflowProgress states pass unit tests: active+determinate, active+indeterminate, inactive"
    - "Component renders correctly at 360px, 768px, 1280px and in both data-theme values"
  artifacts:
    - path: "client/src/components/WorkflowProgress.tsx"
      provides: "WorkflowProgress component accepting WorkflowState | null prop"
      exports: ["WorkflowProgress"]
    - path: "client/src/components/WorkflowProgress.test.tsx"
      provides: "Unit tests for all WorkflowProgress states"
      contains: "renders nothing when workflowState is null"
    - path: "client/src/components/chat.css"
      provides: "CSS for .workflowProgress, .workflowProgressBar, .workflowProgressLabel, pulse animation"
      contains: ".workflowProgress"
  key_links:
    - from: "client/src/components/WorkflowProgress.tsx"
      to: "WorkflowState type from @copilot-chat/shared"
      via: "import type { WorkflowState } from '@copilot-chat/shared'"
      pattern: "WorkflowState"
    - from: "client/src/components/WorkflowProgress.tsx"
      to: "client/src/components/chat.css"
      via: "CSS class names: workflowProgress, workflowProgressBar, workflowProgressLabel"
      pattern: "className.*workflowProgress"
---

<objective>
Build the WorkflowProgress component using TDD — tests first, then implementation. This component shows the current workflow phase label and a progress bar above the transcript when a workflow is active, and hides completely when inactive.

Purpose: Users see visual feedback on which phase the workflow is in and how far along it is, without any hardcoded phase names — all data flows from the server-returned workflowState.
Output: WorkflowProgress.tsx, WorkflowProgress.test.tsx, CSS classes in chat.css.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@client/src/components/chat.css
@client/src/hooks/useChatApi.ts
@shared/src/schemas/workflowState.ts
@.planning/phases/19-workflowstate-schema-client-state-foundation/19-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — write failing tests for WorkflowProgress</name>
  <files>client/src/components/WorkflowProgress.test.tsx</files>
  <action>
    Create `client/src/components/WorkflowProgress.test.tsx` with Jest + React Testing Library.

    The test setup must handle the ESM module environment. Import from `@testing-library/react` (check if it exists; if not in devDependencies, use manual DOM assertions via document API instead since client has only jest + ts-jest). Check `client/package.json` for `@testing-library/react` before writing imports — if absent, write tests as pure component logic tests using ReactDOM.render or document snapshots.

    Actually: since `client/package.json` has only `jest` and `ts-jest` without `@testing-library/react`, write tests that directly test the component's render output using `ReactDOM.renderToStaticMarkup` or `ReactDOM.render` + `document.querySelector`. Import `ReactDOM` from `react-dom`.

    Test cases (ALL must FAIL before implementation exists):
    1. `renders null when workflowState is null` — renders nothing, no DOM elements
    2. `renders phase label when workflow active with currentPhase` — container has text matching workflowState.currentPhase
    3. `renders determinate progress bar when progress is a number` — bar element has style with correct width (e.g., progress=0.5 → width: 50%)
    4. `renders indeterminate pulsing bar when progress is null` — bar element has CSS class indicating indeterminate, no inline width style
    5. `renders active without currentPhase (uses fallback label)` — renders without crashing when currentPhase is undefined
    6. `hides when workflowState status is not active` — does NOT render when status='completed' or status='error' (component only shows for active workflows; the shell handles error state separately per SHELL-02)

    Wait — re SUCCESS CRITERIA item 1: "WorkflowProgress component appears above the transcript when a workflow is active". Since SHELL-02 says ChatShell handles error state with retry, WorkflowProgress should only render when status === 'active'. Test accordingly.

    Use `renderToStaticMarkup` from `react-dom/server` for pure render assertions. Import React.

    IMPORTANT: The component file does NOT exist yet — all imports from `./WorkflowProgress` will cause test failures at this stage. Write the test file, run `cd client && npm test -- --testPathPattern=WorkflowProgress`, confirm ALL tests fail (module not found or assertion failures), then commit: `test(20-01): add failing tests for WorkflowProgress`.
  </action>
  <verify>Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=WorkflowProgress 2>&1`. All tests should FAIL — either "Cannot find module './WorkflowProgress'" or assertion errors. No passing tests at this stage.</verify>
  <done>WorkflowProgress.test.tsx exists with 6 test cases, all failing. Committed with message `test(20-01): add failing tests for WorkflowProgress`.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — implement WorkflowProgress component and CSS</name>
  <files>client/src/components/WorkflowProgress.tsx, client/src/components/chat.css</files>
  <action>
    Implement `client/src/components/WorkflowProgress.tsx`:

    ```tsx
    import type { WorkflowState } from '@copilot-chat/shared';

    interface WorkflowProgressProps {
      workflowState: WorkflowState | null;
    }

    export function WorkflowProgress({ workflowState }: WorkflowProgressProps) {
      // Only render when a workflow is actively running
      if (!workflowState || workflowState.status !== 'active') return null;

      const label = workflowState.currentPhase ?? 'Processing…';
      const isDeterminate = workflowState.progress != null;
      const widthPct = isDeterminate ? `${Math.round((workflowState.progress ?? 0) * 100)}%` : undefined;

      return (
        <div className="workflowProgress" role="status" aria-label={`Workflow: ${label}`}>
          <span className="workflowProgressLabel">{label}</span>
          <div className="workflowProgressTrack" aria-hidden="true">
            <div
              className={`workflowProgressBar${isDeterminate ? '' : ' indeterminate'}`}
              style={isDeterminate ? { width: widthPct } : undefined}
            />
          </div>
        </div>
      );
    }
    ```

    Add CSS to `client/src/components/chat.css` in a new section after the chatHeader section:

    ```css
    /* ─────────────────────────────────────────────────────────────────────────
       Workflow Progress Bar (PROG-01, PROG-02, PROG-03)
       Shows phase label + progress bar above transcript when workflow active.
       Hides via null render when inactive — no layout shift.
       ───────────────────────────────────────────────────────────────────────── */

    .workflowProgress {
      flex-shrink: 0;
      padding: var(--space-2) var(--space-4);
      border-bottom: 1px solid var(--color-border);
      background: var(--color-surface);
    }

    .workflowProgressLabel {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-1);
      transition: opacity 0.2s ease;
    }

    .workflowProgressTrack {
      height: 4px;
      background: var(--color-border);
      border-radius: 2px;
      overflow: hidden;
    }

    .workflowProgressBar {
      height: 100%;
      background: var(--color-primary);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    /* Indeterminate: pulsing animation when progress is null */
    .workflowProgressBar.indeterminate {
      width: 40%;
      animation: progressPulse 1.4s ease-in-out infinite;
    }

    @keyframes progressPulse {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(350%); }
    }

    /* Reduced motion: disable animation, show static bar */
    @media (prefers-reduced-motion: reduce) {
      .workflowProgressBar.indeterminate {
        animation: none;
        width: 100%;
        opacity: 0.5;
      }
    }
    ```

    After implementing, run `cd client && npm test -- --testPathPattern=WorkflowProgress`. All 6 tests must pass. Then commit: `feat(20-01): implement WorkflowProgress component with progress bar`.
  </action>
  <verify>Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=WorkflowProgress 2>&1`. All 6 tests pass. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1` to confirm no TypeScript errors.</verify>
  <done>All 6 WorkflowProgress tests pass. TypeScript build clean. Committed `feat(20-01): implement WorkflowProgress component with progress bar`.</done>
</task>

</tasks>

<verification>
1. Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=WorkflowProgress` — all 6 tests pass
2. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build` — no TypeScript errors
3. `WorkflowProgress.tsx` exports `WorkflowProgress` function, imports `WorkflowState` from `@copilot-chat/shared`
4. `WorkflowProgress` returns null when workflowState is null — grep for `return null` in component
5. CSS contains `.workflowProgressBar.indeterminate` with animation and `@media (prefers-reduced-motion)` override
</verification>

<success_criteria>
- WorkflowProgress.tsx and WorkflowProgress.test.tsx exist in client/src/components/
- 6 unit tests pass covering: null state, active+phase label, determinate bar, indeterminate bar, missing currentPhase fallback, non-active status hide
- CSS classes: workflowProgress, workflowProgressLabel, workflowProgressTrack, workflowProgressBar, progressPulse animation, reduced-motion override
- Component renders null (no DOM nodes) when workflowState is null — verified by test
- TypeScript build clean
</success_criteria>

<output>
After completion, create `.planning/phases/20-shell-wiring-progress-indicator-transcript/20-01-SUMMARY.md`
</output>
