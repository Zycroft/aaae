---
phase: 02-text-chat-end-to-end
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/src/normalizer/activityNormalizer.ts
  - server/src/normalizer/activityNormalizer.test.ts
autonomous: true
requirements:
  - SERV-06
  - SERV-11

must_haves:
  truths:
    - "normalizeActivities([textActivity]) returns one NormalizedMessage with kind='text' and the correct text"
    - "normalizeActivities([cardActivity]) returns one NormalizedMessage with kind='adaptiveCard', cardJson set, and a cardId"
    - "normalizeActivities([hybridActivity]) returns two NormalizedMessages — text first, then card"
    - "normalizeActivities skips non-message activity types (typing, endOfConversation, event, trace)"
    - "All returned NormalizedMessages pass NormalizedMessageSchema.parse() without throwing"
  artifacts:
    - path: "server/src/normalizer/activityNormalizer.ts"
      provides: "Pure function normalizeActivities(Activity[]) => NormalizedMessage[]"
      exports: ["normalizeActivities"]
    - path: "server/src/normalizer/activityNormalizer.test.ts"
      provides: "Vitest test suite covering text-only, card-only, hybrid, and skip cases"
  key_links:
    - from: "server/src/normalizer/activityNormalizer.ts"
      to: "@copilot-chat/shared NormalizedMessageSchema"
      via: "import and runtime validation in tests"
      pattern: "NormalizedMessageSchema\\.parse"
    - from: "server/src/normalizer/activityNormalizer.ts"
      to: "@microsoft/agents-activity Activity"
      via: "TypeScript import"
      pattern: "from '@microsoft/agents-activity'"
---

<objective>
Implement and test the Activity normalizer using TDD (RED → GREEN → REFACTOR).

Purpose: This pure function is the core of Phase 2. It converts raw `Activity` objects from the Copilot Studio SDK into `NormalizedMessage[]` that the client and server both understand. Testing it in isolation before wiring into the route makes the route trivial to implement.

Output: `activityNormalizer.ts` with `normalizeActivities()` exported, and a Vitest test suite covering all required cases (SERV-11).
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/02-text-chat-end-to-end/02-RESEARCH.md
@shared/src/schemas/message.ts
@server/src/store/ConversationStore.ts
</context>

<feature>
  <name>Activity Normalizer</name>
  <files>
    server/src/normalizer/activityNormalizer.ts
    server/src/normalizer/activityNormalizer.test.ts
  </files>
  <behavior>
    normalizeActivities(activities: Activity[]): NormalizedMessage[]

    Rules:
    1. Skip any activity where activity.type !== 'message'
    2. Determine role: activity.from?.role === 'bot' → 'assistant', otherwise 'user'
    3. If activity.text is a non-empty string → emit { id: uuidv4(), role, kind: 'text', text: activity.text }
    4. For each attachment where contentType === 'application/vnd.microsoft.card.adaptive' and content is defined →
       emit { id: uuidv4(), role, kind: 'adaptiveCard', cardJson: attachment.content as Record<string, unknown>, cardId: uuidv4() }
    5. Non-Adaptive Card attachments → silently skip
    6. Hybrid turn (text + card attachment) → emit text NormalizedMessage THEN card NormalizedMessage from the same Activity

    Test cases → expected output:
    - [{ type: 'message', text: 'Hello', from: { role: 'bot' } }]
      → [{ role: 'assistant', kind: 'text', text: 'Hello', id: <uuid> }]

    - [{ type: 'message', from: { role: 'bot' }, attachments: [{ contentType: 'application/vnd.microsoft.card.adaptive', content: { type: 'AdaptiveCard', version: '1.5' } }] }]
      → [{ role: 'assistant', kind: 'adaptiveCard', cardJson: { type: 'AdaptiveCard', version: '1.5' }, cardId: <uuid>, id: <uuid> }]

    - [{ type: 'message', text: 'Here is a card:', from: { role: 'bot' }, attachments: [{ contentType: 'application/vnd.microsoft.card.adaptive', content: { type: 'AdaptiveCard' } }] }]
      → [ { kind: 'text', text: 'Here is a card:' }, { kind: 'adaptiveCard' } ]  (2 items)

    - [{ type: 'typing' }, { type: 'endOfConversation' }, { type: 'message', text: 'Hi', from: { role: 'bot' } }]
      → [{ kind: 'text', text: 'Hi' }]  (1 item — non-message activities skipped)

    - [{ type: 'message', from: { role: 'bot' }, attachments: [{ contentType: 'image/png', contentUrl: 'https://example.com/img.png' }] }]
      → []  (image attachment silently skipped; no text either)

    Additional edge case:
    - Empty array input → []
    - Activity with empty string text (text: '') → skip text, only emit cards if present
  </behavior>
  <implementation>
    Import Activity from '@microsoft/agents-activity'.
    Import NormalizedMessage from '@copilot-chat/shared'.
    Import { v4 as uuidv4 } from 'uuid'.

    Export a single function: normalizeActivities(activities: Activity[]): NormalizedMessage[]

    Place file at: server/src/normalizer/activityNormalizer.ts
    Use ESM (.ts extension, consistent with rest of server).

    After GREEN phase, add NormalizedMessageSchema.parse() validation as a runtime assertion inside the function (validates output before returning). Import NormalizedMessageSchema from '@copilot-chat/shared'.

    IMPORTANT: The server uses vitest (not jest). Test file uses .test.ts extension.
    IMPORTANT: Server uses "type": "module" — imports must use .js extensions in compiled output, but in TypeScript source use bare imports (vitest handles resolution).
    IMPORTANT: Use `describe`, `it`, `expect` from 'vitest' (not jest globals).
  </implementation>
</feature>

<verification>
Run from repo root:
```bash
cd server && npm test
```
All normalizer tests must pass. Zero failing tests. TypeScript must compile clean:
```bash
cd server && npx tsc --noEmit
```
</verification>

<success_criteria>
- [ ] `server/src/normalizer/activityNormalizer.ts` exists and exports `normalizeActivities`
- [ ] `server/src/normalizer/activityNormalizer.test.ts` exists with all described test cases
- [ ] `cd server && npm test` exits 0 with all normalizer tests passing
- [ ] `cd server && npx tsc --noEmit` exits 0
- [ ] Text-only, card-only, hybrid, and skip cases all pass
- [ ] Returned messages each pass `NormalizedMessageSchema.parse()` in tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-chat-end-to-end/02-01-SUMMARY.md`
</output>
