---
phase: 02-text-chat-end-to-end
plan: "02"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - server/src/routes/chat.ts
autonomous: true
requirements:
  - SERV-03

must_haves:
  truths:
    - "POST /api/chat/send with a valid conversationId and text returns 200 with { conversationId, messages: NormalizedMessage[] }"
    - "POST /api/chat/send without Authorization header returns 401 (auth guard unchanged)"
    - "POST /api/chat/send with an unknown conversationId returns 404"
    - "POST /api/chat/send with missing or empty text returns 400"
    - "The route calls copilotClient.sendActivityStreaming() and pipes its output through normalizeActivities()"
  artifacts:
    - path: "server/src/routes/chat.ts"
      provides: "POST /api/chat/send route handling"
      exports: ["chatRouter"]
  key_links:
    - from: "server/src/routes/chat.ts"
      to: "server/src/normalizer/activityNormalizer.ts"
      via: "import normalizeActivities"
      pattern: "normalizeActivities"
    - from: "server/src/routes/chat.ts"
      to: "server/src/copilot.ts"
      via: "import copilotClient"
      pattern: "copilotClient\\.sendActivityStreaming"
    - from: "server/src/routes/chat.ts"
      to: "server/src/store/index.ts"
      via: "conversationStore.get(conversationId)"
      pattern: "conversationStore\\.get"
---

<objective>
Add the `POST /api/chat/send` route to the existing `chatRouter`.

Purpose: This is the server's side of the text chat loop. The route accepts a conversationId + text message, forwards it to Copilot Studio via `sendActivityStreaming()`, normalizes the response activities using the normalizer from Plan 02-01, and returns the bot's normalized messages.

Output: Extended `server/src/routes/chat.ts` with POST /api/chat/send registered on `chatRouter`.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/02-text-chat-end-to-end/02-RESEARCH.md
@.planning/phases/02-text-chat-end-to-end/02-01-SUMMARY.md
@server/src/routes/chat.ts
@server/src/copilot.ts
@server/src/store/ConversationStore.ts
@shared/src/schemas/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement POST /api/chat/send in chat.ts</name>
  <files>server/src/routes/chat.ts</files>
  <action>
    Append the POST /api/chat/send handler to `chatRouter` in `server/src/routes/chat.ts`. Keep the existing POST /start handler intact.

    Import at the top of the file (add to existing imports):
    - `import { normalizeActivities } from '../normalizer/activityNormalizer.js';`
    - `import { ActivityTypes } from '@microsoft/agents-activity';`
    - `import type { Activity } from '@microsoft/agents-activity';`
    - `import { SendMessageRequestSchema } from '@copilot-chat/shared';` (already in schema file as api.ts export)

    Handler logic for `chatRouter.post('/send', async (req, res) => { ... })`:

    1. **Validate request body** with `SendMessageRequestSchema.safeParse(req.body)`.
       - If parse fails → `res.status(400).json({ error: 'Invalid request', details: result.error.format() })` and return.

    2. **Look up conversation** via `conversationStore.get(conversationId)`.
       - If not found → `res.status(404).json({ error: 'Conversation not found' })` and return.

    3. **Build message Activity**:
       ```typescript
       const userActivity: Activity = {
         type: ActivityTypes.Message,
         text,
       };
       ```

    4. **Call sendActivityStreaming** — use the singleton; do NOT pass conversationId as second argument (let the SDK use its stored internal ID from the last startConversationStreaming call). This is the Phase 2 single-conversation approach documented in RESEARCH.md.
       ```typescript
       const collectedActivities: Activity[] = [];
       for await (const activity of copilotClient.sendActivityStreaming(userActivity)) {
         collectedActivities.push(activity);
       }
       ```

    5. **Normalize activities**:
       ```typescript
       const messages = normalizeActivities(collectedActivities);
       ```

    6. **Update conversation history** in store:
       ```typescript
       await conversationStore.set(conversationId, {
         ...conversation,
         history: [...conversation.history, ...messages],
       });
       ```

    7. **Return response**:
       ```typescript
       res.status(200).json({ conversationId, messages });
       ```

    8. **Error handling**: Wrap steps 4-7 in try/catch. On error, log with `console.error('[chat/send] Error:', err)` and return `res.status(502).json({ error: 'Failed to send message to Copilot Studio' })`.

    The route is already mounted at `/api/chat` in `app.ts` and protected by `authMiddleware`, so no changes to `app.ts` are needed.

    Comment the handler with `// SERV-03` similar to the existing `/start` handler's `// SERV-02` comment.
  </action>
  <verify>
    TypeScript compiles clean:
    ```bash
    cd /Users/zycroft/Documents/PA/aaae/server && npx tsc --noEmit
    ```
    Existing tests still pass:
    ```bash
    cd /Users/zycroft/Documents/PA/aaae/server && npm test
    ```
    Route is registered (grep for the handler):
    ```bash
    grep -n "chat/send\|\.post('/send'" /Users/zycroft/Documents/PA/aaae/server/src/routes/chat.ts
    ```
    normalizeActivities is imported:
    ```bash
    grep "normalizeActivities" /Users/zycroft/Documents/PA/aaae/server/src/routes/chat.ts
    ```
  </verify>
  <done>
    `server/src/routes/chat.ts` has a POST /send handler that: validates the request body (400 on bad input), returns 404 for unknown conversationId, calls sendActivityStreaming, runs normalizeActivities, and returns 200 with { conversationId, messages }.
    TypeScript compiles clean. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/zycroft/Documents/PA/aaae/server && npx tsc --noEmit && npm test
```
Both commands must exit 0. The route file must import from both the normalizer and the shared schema.
</verification>

<success_criteria>
- [ ] `POST /api/chat/send` handler added to `chatRouter` in `server/src/routes/chat.ts`
- [ ] Request body validated with `SendMessageRequestSchema.safeParse()`
- [ ] 404 returned for unknown `conversationId`
- [ ] 400 returned for invalid/missing `text`
- [ ] `normalizeActivities` imported and called on the collected activities
- [ ] Conversation history updated in `ConversationStore` after each turn
- [ ] `cd server && npx tsc --noEmit` exits 0
- [ ] `cd server && npm test` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-chat-end-to-end/02-02-SUMMARY.md`
</output>
