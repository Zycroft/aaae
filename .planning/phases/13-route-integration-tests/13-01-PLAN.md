---
phase: 13-route-integration-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/routes/chat.ts
  - server/src/routes/orchestrate.ts
  - server/src/store/__tests__/factory.test.ts
autonomous: true
requirements:
  - ROUTE-01
  - TEST-02

must_haves:
  truths:
    - "chat.ts /start route uses req.user.oid as userId and req.user.tid as tenantId (replacing hardcoded 'anonymous'/'dev')"
    - "orchestrate.ts uses req.user.oid and req.user.tid for both initial store and history update calls"
    - "When AUTH_REQUIRED=false, STUB_USER provides oid='local-dev-oid' and tid='local-dev-tenant' — routes work unchanged"
    - "Factory tests verify: REDIS_URL absent selects InMemoryStore, REDIS_URL set selects RedisStore"
  artifacts:
    - path: "server/src/routes/chat.ts"
      provides: "JWT-aware userId/tenantId in conversation storage"
      contains: "req.user"
    - path: "server/src/routes/orchestrate.ts"
      provides: "JWT-aware userId/tenantId in orchestrate conversation storage"
      contains: "req.user"
    - path: "server/src/store/__tests__/factory.test.ts"
      provides: "Unit tests for store factory pattern"
      exports: []
  key_links:
    - from: "server/src/routes/chat.ts"
      to: "server/src/types/express.d.ts"
      via: "req.user typed as UserClaims"
      pattern: "req.user"
---

<objective>
Wire JWT claims from req.user into chat route userId/tenantId fields and add store factory unit tests.

Purpose: Completes the v1.4 milestone by ensuring conversations are owned by the authenticated user, while maintaining dev usability via STUB_USER fallback. Factory tests confirm store selection logic.

Output:
- server/src/routes/chat.ts (updated — req.user.oid and req.user.tid)
- server/src/routes/orchestrate.ts (updated — same JWT wiring)
- server/src/store/__tests__/factory.test.ts (new — factory pattern tests)
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/routes/chat.ts
@server/src/routes/orchestrate.ts
@server/src/store/factory.ts
@server/src/middleware/auth.ts
@server/src/types/express.d.ts
@shared/src/schemas/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire JWT claims into route userId/tenantId</name>
  <files>
    server/src/routes/chat.ts
    server/src/routes/orchestrate.ts
  </files>
  <action>
**server/src/routes/chat.ts** — Replace hardcoded userId/tenantId with JWT claims:

1. In the `/start` handler, change:
   - `userId: 'anonymous',` → `userId: req.user?.oid ?? 'anonymous',`
   - `tenantId: 'dev',` → `tenantId: req.user?.tid ?? 'dev',`

Note: `req.user` is guaranteed to be populated by authMiddleware (either real JWT claims or STUB_USER). The optional chaining `?.` with fallback is a safety net for edge cases.

The `/start` handler uses `_req` — rename it to `req` so we can access `req.user`.

2. In the `/send` and `/card-action` handlers — no changes needed. They already spread `...conversation` which preserves the userId/tenantId from the initial /start call.

**server/src/routes/orchestrate.ts** — Same changes:

1. Replace both occurrences of hardcoded values:
   - `userId: 'anonymous',` → `userId: req.user?.oid ?? 'anonymous',`
   - `tenantId: 'dev',` → `tenantId: req.user?.tid ?? 'dev',`

(Two occurrences: initial store at line ~52 and history update at line ~108)
  </action>
  <verify>
Run: `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1 | grep -E "error TS" | head -10` — zero errors.
Run: `grep "req.user" /Users/zycroft/Documents/PA/aaae/server/src/routes/chat.ts` — shows JWT claim access.
Run: `grep "req.user" /Users/zycroft/Documents/PA/aaae/server/src/routes/orchestrate.ts` — shows JWT claim access.
  </verify>
  <done>
Chat routes use req.user.oid/tid from JWT claims. STUB_USER provides fallback values for AUTH_REQUIRED=false.
  </done>
</task>

<task type="auto">
  <name>Task 2: Store factory unit tests</name>
  <files>
    server/src/store/__tests__/factory.test.ts
  </files>
  <action>
Create server/src/store/__tests__/factory.test.ts:

Test the factory pattern by manipulating process.env.REDIS_URL and config. Since the factory imports config which reads env vars at module load, tests need to use dynamic imports or mock the config module.

Test cases:
1. When REDIS_URL is not set, createConversationStore returns InMemoryConversationStore
2. When config.REDIS_URL is set (with valid rediss:// URL), createConversationStore returns RedisConversationStore
3. getRedisClient() returns null when using InMemoryStore

Note: Testing the Redis path requires either mocking ioredis or accepting that the factory will try to connect. The simplest approach is to test that the InMemory path works correctly and that the factory function exists and is callable.
  </action>
  <verify>
Run: `cd /Users/zycroft/Documents/PA/aaae/server && npx vitest run src/store/__tests__/factory.test.ts 2>&1 | tail -10` — all tests pass.
  </verify>
  <done>
Factory tests confirm InMemory selection when REDIS_URL absent and getRedisClient returns null.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/zycroft/Documents/PA/aaae && npm run build` — zero TypeScript errors
2. `cd /Users/zycroft/Documents/PA/aaae/server && npx vitest run` — all tests pass
3. `grep "req.user" /Users/zycroft/Documents/PA/aaae/server/src/routes/chat.ts` — JWT claims used
4. `grep "req.user" /Users/zycroft/Documents/PA/aaae/server/src/routes/orchestrate.ts` — JWT claims used
5. `grep "'anonymous'" /Users/zycroft/Documents/PA/aaae/server/src/routes/chat.ts` — should be fallback only (after ??)
</verification>

<success_criteria>
- /api/chat/start stores userId from req.user.oid and tenantId from req.user.tid
- orchestrate route does the same for both store calls
- AUTH_REQUIRED=false works with STUB_USER (oid='local-dev-oid', tid='local-dev-tenant')
- Factory tests pass confirming InMemory selection and getRedisClient null return
- npm run build passes
- npm test passes (all workspaces)
</success_criteria>

<output>
After completion, create `.planning/phases/13-route-integration-tests/13-01-SUMMARY.md`
</output>
