---
phase: 03-adaptive-cards-accessibility-theming
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/components/chat.css
  - client/src/hooks/useTheme.ts
  - client/src/components/ThemeToggle.tsx
  - client/src/components/ChatShell.tsx
autonomous: true
requirements: [UI-13, UI-14, UI-15]

must_haves:
  truths:
    - "Toggling the theme button switches between dark and light mode visually"
    - "Theme preference survives a page reload (localStorage persists it)"
    - "App defaults to the OS color scheme on first visit (prefers-color-scheme)"
    - "All skeleton shimmer animations and CSS transitions are disabled when prefers-reduced-motion is set"
    - "All hardcoded color values in chat.css replaced with CSS custom properties"
    - "Font sizes use CSS clamp() for fluid typography"
  artifacts:
    - path: "client/src/hooks/useTheme.ts"
      provides: "useTheme() hook managing theme state, localStorage persistence, and system preference detection"
      exports: ["useTheme"]
    - path: "client/src/components/ThemeToggle.tsx"
      provides: "Theme toggle button component consuming useTheme"
      exports: ["ThemeToggle"]
    - path: "client/src/components/chat.css"
      provides: "CSS custom properties on :root and [data-theme=dark], fluid typography with clamp(), reduced-motion media query"
      contains: "--color-bg"
  key_links:
    - from: "client/src/components/ChatShell.tsx"
      to: "client/src/hooks/useTheme.ts"
      via: "useTheme() hook call"
      pattern: "useTheme"
    - from: "client/src/hooks/useTheme.ts"
      to: "document.documentElement.dataset.theme"
      via: "DOM attribute set on theme change"
      pattern: "dataset.theme"
    - from: "client/src/components/chat.css"
      to: "[data-theme=dark]"
      via: "CSS attribute selector for dark theme"
      pattern: "data-theme"
---

<objective>
Replace all hardcoded colors in chat.css with CSS custom properties, implement a dark/light theme with localStorage persistence and system-preference detection, add fluid typography with CSS clamp(), and respect prefers-reduced-motion.

Purpose: UI-13 (dark/light toggle + localStorage), UI-14 (fluid typography + CSS tokens), UI-15 (reduced-motion).
Output: `useTheme.ts` hook, `ThemeToggle.tsx` component, refactored `chat.css` with design tokens.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-adaptive-cards-accessibility-theming/03-CONTEXT.md
@.planning/phases/03-adaptive-cards-accessibility-theming/03-RESEARCH.md
@.planning/phases/02-text-chat-end-to-end/02-04-SUMMARY.md
@client/src/components/chat.css
@client/src/components/ChatShell.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor chat.css with CSS custom properties + dark theme + fluid typography + reduced-motion</name>
  <files>client/src/components/chat.css</files>
  <action>
    Replace the entire `chat.css` file content. The new file must:

    1. Define CSS custom properties on `:root` (light theme defaults):
       ```css
       :root {
         /* Colors */
         --color-bg: #ffffff;
         --color-surface: #f3f2f1;
         --color-primary: #0078d4;
         --color-primary-hover: #006cbf;
         --color-text: #323130;
         --color-text-inverse: #ffffff;
         --color-text-muted: #666666;
         --color-border: #e0e0e0;
         --color-error-bg: #fde7e9;
         --color-error-text: #a4262c;
         --color-error-border: #f1b8bb;
         --color-avatar-user-bg: #0078d4;
         --color-avatar-user-text: #ffffff;
         --color-avatar-bot-bg: #e8e8e8;
         --color-avatar-bot-text: #444444;
         --color-skeleton: #ebebeb;
         --color-skeleton-shine: #f5f5f5;
         --color-skeleton-dot: #999999;
         --color-card-surface: #ffffff;
         --color-card-border: #e0e0e0;
         --color-focus-ring: rgba(0, 120, 212, 0.4);
         /* Typography (UI-14: fluid with clamp) */
         --font-size-xs: clamp(10px, 1.2vw, 11px);
         --font-size-sm: clamp(11px, 1.4vw, 12px);
         --font-size-base: clamp(13px, 1.8vw, 14px);
         --font-size-lg: clamp(14px, 2vw, 16px);
         /* Spacing */
         --space-1: 4px;
         --space-2: 8px;
         --space-3: 12px;
         --space-4: 16px;
         --space-5: 20px;
         /* Transitions */
         --transition-base: 0.15s ease;
       }
       ```

    2. Define dark theme overrides on `[data-theme="dark"]`:
       ```css
       [data-theme="dark"] {
         --color-bg: #1b1a19;
         --color-surface: #2d2c2b;
         --color-primary: #4da3e0;
         --color-primary-hover: #6eb4e8;
         --color-text: #f3f2f1;
         --color-text-inverse: #1b1a19;
         --color-text-muted: #a0a0a0;
         --color-border: #3d3c3b;
         --color-error-bg: #3d1c1e;
         --color-error-text: #f4a8ab;
         --color-error-border: #6b2f33;
         --color-avatar-user-bg: #4da3e0;
         --color-avatar-user-text: #1b1a19;
         --color-avatar-bot-bg: #3d3c3b;
         --color-avatar-bot-text: #c8c8c8;
         --color-skeleton: #2d2c2b;
         --color-skeleton-shine: #3d3c3b;
         --color-skeleton-dot: #666666;
         --color-card-surface: #2d2c2b;
         --color-card-border: #3d3c3b;
         --color-focus-ring: rgba(77, 163, 224, 0.4);
       }
       ```

    3. Replace ALL hardcoded color values in existing rules with the corresponding custom property.

    4. Replace hardcoded font-size values with custom property equivalents.

    5. Add reduced-motion block at the end of the file (UI-15):
       ```css
       @media (prefers-reduced-motion: reduce) {
         *, *::before, *::after {
           animation-duration: 0.01ms !important;
           animation-iteration-count: 1 !important;
           transition-duration: 0.01ms !important;
         }
       }
       ```

    6. Add focus-visible styles for all interactive elements:
       ```css
       :focus-visible {
         outline: 2px solid var(--color-primary);
         outline-offset: 2px;
         box-shadow: 0 0 0 4px var(--color-focus-ring);
       }
       ```

    Preserve all existing class names and layout rules unchanged — only replace literal color/size values with custom properties. The `.chatShell` background, `.globalError` colors, bubble colors, avatar colors, skeleton colors, button colors, and border colors must all use custom properties.
  </action>
  <verify>
    cd client && npx tsc --noEmit
    grep -c "var(--color" client/src/components/chat.css
    grep -c "#[0-9a-fA-F]" client/src/components/chat.css
  </verify>
  <done>
    chat.css has `:root` with all custom properties, `[data-theme="dark"]` block, `@media (prefers-reduced-motion: reduce)` block.
    Zero hardcoded hex color values remain in the property values (custom property definitions in :root and [data-theme] are the only exception).
    TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: useTheme hook + ThemeToggle component + wire into ChatShell</name>
  <files>
    client/src/hooks/useTheme.ts
    client/src/components/ThemeToggle.tsx
    client/src/components/ChatShell.tsx
  </files>
  <action>
    **Create `client/src/hooks/useTheme.ts`:**

    ```ts
    import { useState, useEffect } from 'react';

    export type Theme = 'light' | 'dark';
    const STORAGE_KEY = 'chatTheme';

    function getSystemTheme(): Theme {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function getInitialTheme(): Theme {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored === 'dark' || stored === 'light') return stored;
      return getSystemTheme();
    }

    export function useTheme() {
      const [theme, setTheme] = useState<Theme>(getInitialTheme);

      useEffect(() => {
        document.documentElement.dataset.theme = theme;
        localStorage.setItem(STORAGE_KEY, theme);
      }, [theme]);

      const toggle = () => setTheme((t) => (t === 'dark' ? 'light' : 'dark'));

      return { theme, toggle };
    }
    ```

    **Create `client/src/components/ThemeToggle.tsx`:**

    A button component that:
    - Renders as a circular toggle button positioned in the ChatShell (floating top-right in the chat area or in a header bar — Claude's discretion)
    - Shows "Dark" or "Light" label (or a sun/moon text character — no external icon library; use text symbols: ☀ for light, ☾ for dark)
    - Has aria-label="Switch to dark mode" (or light) — updates based on current theme
    - Uses CSS class `.themeToggle` (add styles to chat.css: position absolute top-right, circular, z-index above transcript)

    **Modify `client/src/components/ChatShell.tsx`:**
    - Import `useTheme` hook
    - Import `ThemeToggle` component
    - Call `useTheme()` at the top of the component — destructure `{ theme, toggle }`
    - Render `<ThemeToggle theme={theme} onToggle={toggle} />` inside the chatShell div, above the error bar

    **Add ThemeToggle styles to `client/src/components/chat.css`:**
    ```css
    .themeToggle {
      position: absolute;
      top: var(--space-3);
      right: var(--space-4);
      z-index: 10;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text);
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition-base), border-color var(--transition-base);
    }
    .themeToggle:hover {
      background: var(--color-border);
    }
    ```

    Also add `position: relative;` to `.chatShell` to anchor the absolute-positioned toggle.

    Run `cd client && npx tsc --noEmit` — must exit 0.
  </action>
  <verify>
    cd client && npx tsc --noEmit
    ls client/src/hooks/useTheme.ts
    ls client/src/components/ThemeToggle.tsx
    grep "useTheme" client/src/components/ChatShell.tsx
    grep "ThemeToggle" client/src/components/ChatShell.tsx
  </verify>
  <done>
    useTheme.ts exports `useTheme` and `Theme` type.
    ThemeToggle.tsx renders a toggle button with aria-label.
    ChatShell.tsx imports and renders ThemeToggle.
    document.documentElement.dataset.theme is set on theme change.
    localStorage persists the theme.
    TypeScript compiles clean across client workspace.
  </done>
</task>

</tasks>

<verification>
- cd client && npx tsc --noEmit exits 0
- grep -c "var(--color" client/src/components/chat.css returns a high number (30+)
- client/src/hooks/useTheme.ts exports useTheme
- client/src/components/ThemeToggle.tsx exists
- client/src/components/ChatShell.tsx imports ThemeToggle and useTheme
- chat.css contains [data-theme="dark"] block and @media (prefers-reduced-motion: reduce) block
</verification>

<success_criteria>
- UI-13: Dark/light theme toggle exists; preference stored in localStorage; system preference used as default
- UI-14: Fluid typography via CSS clamp(); all spacing via CSS custom property tokens
- UI-15: prefers-reduced-motion media query disables all animations and transitions
</success_criteria>

<output>
After completion, create `.planning/phases/03-adaptive-cards-accessibility-theming/03-02-SUMMARY.md`
</output>
