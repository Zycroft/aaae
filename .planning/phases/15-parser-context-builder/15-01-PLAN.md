---
phase: 15-parser-context-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/schemas/workflow.ts
  - shared/src/index.ts
autonomous: true
requirements: [PARSE-05]

must_haves:
  truths:
    - "CopilotStructuredOutputSchema is importable from @copilot-chat/shared in both server and client"
    - "ParsedTurn discriminated union type (three kinds: structured, passthrough, parse_error) is exported from shared"
    - "NextAction enum type is exported from shared"
    - "Zod schema uses .passthrough() allowing unknown fields without validation errors"
  artifacts:
    - path: "shared/src/schemas/workflow.ts"
      provides: "CopilotStructuredOutputSchema, ParsedTurnSchema, NextAction type"
      contains: ".passthrough()"
    - path: "shared/src/index.ts"
      provides: "barrel export for all new workflow types"
      contains: "workflow.js"
  key_links:
    - from: "shared/src/schemas/workflow.ts"
      to: "server/src/parser/structuredOutputParser.ts"
      via: "import from @copilot-chat/shared"
      pattern: "CopilotStructuredOutputSchema|ParsedTurn"
    - from: "shared/src/schemas/workflow.ts"
      to: "shared/src/index.ts"
      via: "barrel re-export"
      pattern: "from './schemas/workflow.js'"
---

<objective>
Define the shared Zod schemas and TypeScript types for Phase 15: CopilotStructuredOutputSchema (validated structured output from Copilot), ParsedTurn (discriminated union covering structured/passthrough/parse_error outcomes), and NextAction enum. These are the shared contracts that the parser (Plan 02) and the orchestrator (Phase 16) consume.

Purpose: Establish the single source of truth for workflow output types in shared/ before any server modules depend on them. Shared/ must be rebuilt after this plan so server can import the new types.
Output: shared/src/schemas/workflow.ts + updated shared/src/index.ts barrel export
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-parser-context-builder/15-RESEARCH.md
@shared/src/schemas/extractedPayload.ts
@shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared/src/schemas/workflow.ts with CopilotStructuredOutputSchema and ParsedTurn</name>
  <files>shared/src/schemas/workflow.ts</files>
  <action>
Create `shared/src/schemas/workflow.ts` with the following exports:

**NextAction type:**
```typescript
export const NextActionSchema = z.enum(['ask', 'research', 'confirm', 'complete', 'error']);
export type NextAction = z.infer<typeof NextActionSchema>;
```

**CopilotStructuredOutputSchema** (use `.passthrough()` for forward compatibility — Copilot responses may include fields unknown to this schema):
```typescript
export const CopilotStructuredOutputSchema = z.object({
  action: NextActionSchema.optional(),
  prompt: z.string().optional(),
  data: z.record(z.string(), z.unknown()).optional(),
  confidence: z.number().min(0).max(1).optional(),
  citations: z.array(z.string()).optional(),
}).passthrough();
export type CopilotStructuredOutput = z.infer<typeof CopilotStructuredOutputSchema>;
```

**ParsedTurnSchema** — discriminated union with three variants. Because `NormalizedMessage` types live in server, the `displayMessages` field on ParsedTurn should use `z.array(z.unknown())` in the Zod schema (to avoid a circular shared→server import) but the TypeScript type exposes it correctly via the type annotation approach used in Phase 8. Alternatively — and preferred since NormalizedMessage IS in shared — use `z.array(NormalizedMessageSchema)`. Check that `NormalizedMessageSchema` is importable from `./message.js` and use it directly. Do NOT import from `@copilot-chat/shared` (no circular imports within shared/).

Three discriminated variants keyed on `kind`:
- `kind: 'structured'` — `data: z.record(z.string(), z.unknown())`, `nextAction: NextActionSchema`, `nextPrompt: z.string().nullable()`, `displayMessages: z.array(NormalizedMessageSchema)`, `confidence: ExtractionConfidenceSchema`, `citations: z.array(z.string())`, `parseErrors: z.tuple([])` (empty literal)
- `kind: 'passthrough'` — `data: z.null()`, `nextAction: z.null()`, `nextPrompt: z.null()`, `displayMessages: z.array(NormalizedMessageSchema)`, `confidence: z.null()`, `citations: z.tuple([])`, `parseErrors: z.tuple([])`
- `kind: 'parse_error'` — `data: z.null()`, `nextAction: z.null()`, `nextPrompt: z.null()`, `displayMessages: z.array(NormalizedMessageSchema)`, `confidence: z.null()`, `citations: z.tuple([])`, `parseErrors: z.array(z.string()).min(1)`

Export:
```typescript
export const ParsedTurnSchema = z.discriminatedUnion('kind', [
  ParsedTurnStructuredSchema,
  ParsedTurnPassthroughSchema,
  ParsedTurnParseErrorSchema,
]);
export type ParsedTurn = z.infer<typeof ParsedTurnSchema>;
```

Import `z` from `'zod'`, `NormalizedMessageSchema` from `'./message.js'`, and `ExtractionConfidenceSchema` from `'./extractedPayload.js'`. Add JSDoc on each schema referencing requirement IDs (PARSE-02, PARSE-03, PARSE-05).

Note on `z.tuple([])` for empty arrays: Zod's discriminated union inference works best with `z.literal('')` literals for discriminant fields. For empty arrays representing "guaranteed empty," use `z.array(z.never()).default([])` OR simply `z.tuple([])`. Prefer `z.tuple([])` as it is type-safe and communicates intent. If TypeScript complains about the discriminated union variants, use `z.array(z.string()).max(0)` for the empty parseErrors/citations variants.
  </action>
  <verify>
Run from repo root:
```bash
cd shared && npm run build
```
Build must succeed with zero TypeScript errors. Confirm output:
```bash
ls shared/dist/schemas/workflow.js
```
  </verify>
  <done>shared/src/schemas/workflow.ts exists, exports CopilotStructuredOutputSchema with .passthrough(), ParsedTurnSchema as discriminated union, NextAction type. `cd shared && npm run build` exits 0.</done>
</task>

<task type="auto">
  <name>Task 2: Export workflow types from shared barrel and rebuild</name>
  <files>shared/src/index.ts</files>
  <action>
Add the following export block to `shared/src/index.ts` after the existing workflowState export:

```typescript
export {
  NextActionSchema,
  type NextAction,
  CopilotStructuredOutputSchema,
  type CopilotStructuredOutput,
  ParsedTurnSchema,
  type ParsedTurn,
} from './schemas/workflow.js';
```

Then rebuild shared so server can import the new types:
```bash
cd shared && npm run build
```

Verify the new exports are accessible:
```bash
node -e "const s = require('./shared/dist/index.js'); console.log(Object.keys(s).filter(k => k.includes('Parsed') || k.includes('Copilot') || k.includes('NextAction')))"
```
Expected output includes: `ParsedTurnSchema`, `CopilotStructuredOutputSchema`, `NextActionSchema`, `NextAction`, `ParsedTurn`, `CopilotStructuredOutput` (type exports won't appear at runtime but schemas will).
  </action>
  <verify>
```bash
cd shared && npm run build
node -e "const s = require('./shared/dist/index.js'); console.log('ParsedTurnSchema:', typeof s.ParsedTurnSchema, 'CopilotStructuredOutputSchema:', typeof s.CopilotStructuredOutputSchema)"
```
Both should output `object` (Zod schemas are objects at runtime).
  </verify>
  <done>shared/src/index.ts exports all workflow types. `cd shared && npm run build` succeeds. Runtime node check confirms ParsedTurnSchema and CopilotStructuredOutputSchema are accessible from shared/dist/index.js.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `cd shared && npm run build` exits 0 — no TypeScript errors in workflow.ts or index.ts
2. `node -e "const s = require('./shared/dist/index.js'); console.log(typeof s.ParsedTurnSchema, typeof s.CopilotStructuredOutputSchema)"` prints `object object`
3. `grep -r "workflow" shared/src/index.ts` shows the new export block
4. `grep "passthrough" shared/src/schemas/workflow.ts` confirms .passthrough() is present on CopilotStructuredOutputSchema
</verification>

<success_criteria>
- shared/src/schemas/workflow.ts exists with CopilotStructuredOutputSchema (.passthrough()), ParsedTurnSchema (discriminated union, 3 kinds), NextActionSchema
- shared/src/index.ts re-exports all new types from workflow.js
- shared/ builds successfully (zero errors)
- Types importable from @copilot-chat/shared in both server (CommonJS/ESM) and client (type-only)
</success_criteria>

<output>
After completion, create `.planning/phases/15-parser-context-builder/15-01-SUMMARY.md`
</output>
