---
phase: 15-parser-context-builder
plan: 02
type: tdd
wave: 2
depends_on: ["15-01"]
files_modified:
  - server/src/parser/structuredOutputParser.ts
  - server/src/parser/structuredOutputParser.test.ts
autonomous: true
requirements: [PARSE-01, PARSE-02, PARSE-03, PARSE-04]

must_haves:
  truths:
    - "Calling parseTurn() with a NormalizedMessage that contains activity.value JSON returns kind='structured' with populated data and nextAction"
    - "Calling parseTurn() with a message containing only plain text returns kind='passthrough' with empty parseErrors"
    - "Calling parseTurn() with malformed JSON in a code fence returns kind='parse_error' with a non-empty parseErrors array"
    - "parseTurn() never throws — all error paths return ParsedTurn variants, no exceptions bubble out"
    - "Extracted JSON is validated against CopilotStructuredOutputSchema using Zod safeParse before populating 'structured' kind"
    - "Parser tries extraction surfaces in priority order: activity.value (extractedPayload source='value') → entities → text code fence"
  artifacts:
    - path: "server/src/parser/structuredOutputParser.ts"
      provides: "parseTurn() function implementing multi-strategy extraction with Zod validation"
      exports: ["parseTurn"]
    - path: "server/src/parser/structuredOutputParser.test.ts"
      provides: "TDD test suite covering all ParsedTurn kinds and extraction surfaces"
      min_lines: 80
  key_links:
    - from: "server/src/parser/structuredOutputParser.ts"
      to: "@copilot-chat/shared"
      via: "import CopilotStructuredOutputSchema, ParsedTurn, NormalizedMessage"
      pattern: "CopilotStructuredOutputSchema|ParsedTurn"
    - from: "server/src/parser/structuredOutputParser.ts"
      to: "server/src/normalizer/activityNormalizer.ts"
      via: "reuses extractedPayload field from NormalizedMessage (not re-extracting from raw Activity)"
      pattern: "extractedPayload"
---

<objective>
Implement the structured output parser via TDD. The parser accepts normalized messages (already-processed by activityNormalizer) and validates any extracted structured payload against CopilotStructuredOutputSchema, returning a ParsedTurn discriminated union.

Purpose: Provide the Phase 16 orchestrator with a reliable, non-throwing parser that clearly signals structured extraction success, clean passthrough, or extraction failure. Reuses the existing extractedPayload field on NormalizedMessage (set by activityNormalizer) rather than re-extracting from raw Activity objects.
Output: server/src/parser/structuredOutputParser.ts + test file
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-parser-context-builder/15-RESEARCH.md
@.planning/phases/15-parser-context-builder/15-01-SUMMARY.md
@server/src/normalizer/activityNormalizer.ts
@shared/src/schemas/extractedPayload.ts
@shared/src/schemas/workflow.ts
@server/src/normalizer/activityNormalizer.test.ts
</context>

<feature>
  <name>parseTurn — Structured Output Parser</name>
  <files>server/src/parser/structuredOutputParser.ts, server/src/parser/structuredOutputParser.test.ts</files>
  <behavior>
parseTurn(messages: NormalizedMessage[], schema?: ZodSchema): Promise&lt;ParsedTurn&gt;

Key behaviors and test cases:

**kind='passthrough' cases (no extraction attempted):**
- Input: `[{ role: 'assistant', kind: 'text', text: 'Hello!', id: '...', extractedPayload: undefined }]`
  → `{ kind: 'passthrough', data: null, parseErrors: [], displayMessages: [...] }`
- Input: `[]` (empty messages)
  → `{ kind: 'passthrough', data: null, parseErrors: [] }`
- Input: only user messages (role='user')
  → `{ kind: 'passthrough', data: null, parseErrors: [] }`

**kind='structured' cases (extraction succeeded + schema valid):**
- Input: message with `extractedPayload: { source: 'value', confidence: 'high', data: { action: 'ask', prompt: 'What is your name?' } }`
  Schema validates against CopilotStructuredOutputSchema
  → `{ kind: 'structured', data: { action: 'ask', prompt: '...' }, nextAction: 'ask', confidence: 'high', parseErrors: [] }`

- Input: message with `extractedPayload: { source: 'entities', confidence: 'medium', data: { action: 'confirm', data: { name: 'Alice' } } }`
  → `{ kind: 'structured', nextAction: 'confirm', confidence: 'medium', ... }`

- Input: message with `extractedPayload: { source: 'text', confidence: 'low', data: { action: 'complete' } }`
  → `{ kind: 'structured', nextAction: 'complete', confidence: 'low', ... }`

- Input: message with extractedPayload containing extra unknown fields (e.g., `{ action: 'ask', unknownField: 'x' }`)
  → Due to .passthrough() on CopilotStructuredOutputSchema, still validates as 'structured'

**kind='parse_error' cases (extraction attempted but schema validation failed):**
- Input: message with `extractedPayload: { source: 'value', confidence: 'high', data: { action: 'INVALID_ACTION' } }`
  Schema rejects unknown action enum value
  → `{ kind: 'parse_error', parseErrors: ['...'], data: null }`

- Input: message with `extractedPayload: { source: 'text', confidence: 'low', data: { someRandomField: 42 } }`
  No action field at all — if CopilotStructuredOutputSchema makes action required, this fails. But since action is optional, this would pass validation as 'structured'. Adjust test expectations accordingly.

**Confidence and nextAction mapping:**
- `nextAction` in the 'structured' variant is populated from `data.action` cast to NextAction
- `nextPrompt` is populated from `data.prompt` (string or null)
- `citations` is populated from `data.citations` (string[] or empty array)
- `confidence` is carried over from extractedPayload.confidence

**Non-throwing contract:**
- Wrap all logic in try/catch; any unexpected exception produces `{ kind: 'parse_error', parseErrors: [error.message] }`
  </behavior>
  <implementation>
**Architecture decision:** The parser operates on NormalizedMessage[] rather than raw Activity[]. The activityNormalizer already extracts structured payloads into `msg.extractedPayload`. The parser's job is to:
1. Find the first assistant message with a non-undefined extractedPayload
2. Validate `extractedPayload.data` against CopilotStructuredOutputSchema using `schema.safeParse()`
3. If validation passes → return `{ kind: 'structured', data: parsed.data, nextAction: parsed.data.action ?? null, ... }`
4. If validation fails → return `{ kind: 'parse_error', parseErrors: [result.error.message], displayMessages: messages }`
5. If no extractedPayload found in any assistant message → return `{ kind: 'passthrough', displayMessages: messages }`

**File: server/src/parser/structuredOutputParser.ts**
```typescript
import { CopilotStructuredOutputSchema, type ParsedTurn } from '@copilot-chat/shared';
import type { NormalizedMessage } from '@copilot-chat/shared';

export async function parseTurn(
  messages: NormalizedMessage[],
  schema = CopilotStructuredOutputSchema
): Promise<ParsedTurn> {
  try {
    for (const msg of messages) {
      if (msg.role !== 'assistant') continue;
      if (!msg.extractedPayload) continue;

      const result = schema.safeParse(msg.extractedPayload.data);
      if (result.success) {
        const parsed = result.data as Record<string, unknown>;
        return {
          kind: 'structured',
          data: parsed,
          nextAction: (parsed['action'] as ParsedTurn['nextAction']) ?? null,
          nextPrompt: typeof parsed['prompt'] === 'string' ? parsed['prompt'] : null,
          displayMessages: messages,
          confidence: msg.extractedPayload.confidence,
          citations: Array.isArray(parsed['citations']) ? (parsed['citations'] as string[]) : [],
          parseErrors: [],
        };
      } else {
        return {
          kind: 'parse_error',
          data: null,
          nextAction: null,
          nextPrompt: null,
          displayMessages: messages,
          confidence: null,
          citations: [],
          parseErrors: [result.error.message],
        };
      }
    }

    // No assistant message with extractedPayload found
    return {
      kind: 'passthrough',
      data: null,
      nextAction: null,
      nextPrompt: null,
      displayMessages: messages,
      confidence: null,
      citations: [],
      parseErrors: [],
    };
  } catch (err) {
    return {
      kind: 'parse_error',
      data: null,
      nextAction: null,
      nextPrompt: null,
      displayMessages: messages,
      confidence: null,
      citations: [],
      parseErrors: [err instanceof Error ? err.message : String(err)],
    };
  }
}
```

Note: If `NormalizedMessage` type doesn't include `extractedPayload` field after Phase 14, check `shared/src/schemas/message.ts` — it was added in v1.3b (SOUT-05). The field is optional so both old and new messages work.

TDD cycle: Write test file first (all tests failing), then implement parseTurn, then verify all pass.
  </implementation>
</feature>

<verification>
```bash
cd server && npm test -- --reporter=verbose 2>&1 | grep -E "parseTurn|structuredOutput|PASS|FAIL"
```
All tests in structuredOutputParser.test.ts must pass. Specifically verify:
1. `passthrough` test case passes (plain text message, no extractedPayload)
2. `structured` test case passes (message with valid extractedPayload.data matching CopilotStructuredOutputSchema)
3. `parse_error` test case passes (message with extractedPayload whose data fails schema validation)
4. Non-throwing test: wrap parseTurn in a try/catch in a test, confirm no exception thrown even with malformed input
</verification>

<success_criteria>
- server/src/parser/structuredOutputParser.ts exports parseTurn() function
- server/src/parser/structuredOutputParser.test.ts covers all three ParsedTurn kinds plus non-throwing contract
- All tests pass: `cd server && npm test` exits 0
- parseTurn never throws (verified by test that passes deliberately malformed input)
- Zod schema validation used for all extraction attempts (no raw duck-typing)
</success_criteria>

<output>
After completion, create `.planning/phases/15-parser-context-builder/15-02-SUMMARY.md`
</output>
