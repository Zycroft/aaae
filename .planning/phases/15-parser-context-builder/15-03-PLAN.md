---
phase: 15-parser-context-builder
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/src/workflow/contextBuilder.ts
  - server/src/workflow/contextBuilder.test.ts
autonomous: true
requirements: [CTX-01, CTX-02, CTX-03]

must_haves:
  truths:
    - "buildContextualQuery() prepends a structured preamble to user messages containing current step, collectedData, and turn number"
    - "The preamble format is configurable via preambleTemplate option — default format used when not provided"
    - "When the full query exceeds maxLength (default 2000 chars), output is truncated to maxLength and returns truncated=true"
    - "When preamble is within maxLength, truncated=false is returned"
    - "buildContextualQuery() is a pure synchronous function — no async, no Redis, no side effects"
  artifacts:
    - path: "server/src/workflow/contextBuilder.ts"
      provides: "buildContextualQuery() function with configurable preamble and max-length truncation"
      exports: ["buildContextualQuery", "ContextBuilderConfig"]
    - path: "server/src/workflow/contextBuilder.test.ts"
      provides: "TDD test suite covering preamble format, custom template, and truncation behavior"
      min_lines: 60
  key_links:
    - from: "server/src/workflow/contextBuilder.ts"
      to: "@copilot-chat/shared"
      via: "import WorkflowState type for parameter typing"
      pattern: "WorkflowState"
    - from: "server/src/workflow/contextBuilder.ts"
      to: "server/src/workflow/contextBuilder.test.ts"
      via: "exported buildContextualQuery() called directly in tests"
      pattern: "buildContextualQuery"
---

<objective>
Implement the context builder via TDD. The context builder enriches outbound Copilot queries by prepending a structured preamble containing current workflow state (step, collectedData, turnCount). The preamble format is configurable and respects a maximum length limit to prevent context window overflow.

Purpose: Separate context injection logic from route handlers into a testable, reusable service. Phase 16 orchestrator calls this before every Copilot request.
Output: server/src/workflow/contextBuilder.ts + test file
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-parser-context-builder/15-RESEARCH.md
@shared/src/schemas/workflowState.ts
</context>

<feature>
  <name>buildContextualQuery — Context Builder</name>
  <files>server/src/workflow/contextBuilder.ts, server/src/workflow/contextBuilder.test.ts</files>
  <behavior>
buildContextualQuery(userMessage: string, workflowState: WorkflowState, config?: ContextBuilderConfig): { query: string; truncated: boolean }

**Test cases:**

**Default preamble format (CTX-01):**
- Input: `userMessage='What is my eligibility?'`, `workflowState={ step: 'intake', collectedData: { name: 'Alice' }, turnCount: 2 }`
- No config provided
- Expected: `query` starts with `[CONTEXT]\nPhase: intake\nCollected data: {"name":"Alice"}\nTurn number: 2\n[/CONTEXT]`
- Expected: `query` ends with `\n\nWhat is my eligibility?`
- Expected: `truncated: false`

**Empty collectedData (CTX-01):**
- Input: `workflowState={ step: 'start', collectedData: undefined, turnCount: 0 }`
- Expected: `Collected data: {}` in preamble (serialize undefined as empty object)

**Custom preamble template (CTX-02):**
- Input: `config={ preambleTemplate: '<ctx>step={step},turn={turnCount}</ctx>\n{userMessage}' }`
- Expected: query = `<ctx>step=intake,turn=2</ctx>\nWhat is my eligibility?`
- Expected: standard `[CONTEXT]` block NOT present (custom template replaces default)

**Truncation at maxLength (CTX-03):**
- Input: large `collectedData` that causes full query to exceed maxLength
- Config: `{ maxLength: 100 }`
- Expected: `query.length === 100` (exactly maxLength)
- Expected: `query` ends with `...`
- Expected: `truncated: true`

**Below maxLength (CTX-03):**
- Input: small workflowState, `config={ maxLength: 5000 }`
- Expected: `truncated: false`
- Expected: full preamble + user message present

**Default maxLength = 2000 (CTX-03):**
- Input: workflowState with `collectedData` containing 500-char serialized JSON
- No config provided
- Query under 2000 chars → `truncated: false`

**Template variable substitution handles special characters (robustness):**
- Input: `workflowState.step = 'step with {curly}'` (brace in step name)
- Expected: does NOT cause infinite replacement loop; step inserted as literal string
- Note: use simple `.replace('{step}', step)` (not regex), which is safe for literal replacement
  </behavior>
  <implementation>
**File: server/src/workflow/contextBuilder.ts**

```typescript
import type { WorkflowState } from '@copilot-chat/shared';

export interface ContextBuilderConfig {
  /** Custom preamble template. Placeholders: {step}, {dataJson}, {turnCount}, {userMessage} */
  preambleTemplate?: string;
  /** Maximum total query length in characters. Excess is truncated with '...' suffix. Default: 2000. */
  maxLength?: number;
}

const DEFAULT_TEMPLATE = `[CONTEXT]
Phase: {step}
Collected data: {dataJson}
Turn number: {turnCount}
[/CONTEXT]

{userMessage}`;

/**
 * Enriches an outbound Copilot query with a workflow state preamble.
 * Format is configurable; respects maxLength to prevent context window overflow.
 *
 * CTX-01, CTX-02, CTX-03
 */
export function buildContextualQuery(
  userMessage: string,
  workflowState: WorkflowState,
  config?: ContextBuilderConfig
): { query: string; truncated: boolean } {
  const template = config?.preambleTemplate ?? DEFAULT_TEMPLATE;
  const maxLength = config?.maxLength ?? 2000;

  const dataJson = JSON.stringify(workflowState.collectedData ?? {});
  let query = template
    .replace('{step}', workflowState.step)
    .replace('{dataJson}', dataJson)
    .replace('{turnCount}', String(workflowState.turnCount))
    .replace('{userMessage}', userMessage);

  if (query.length > maxLength) {
    query = query.slice(0, maxLength - 3).trimEnd() + '...';
    return { query, truncated: true };
  }

  return { query, truncated: false };
}
```

Notes:
- Pure function — no async, no imports beyond WorkflowState type
- Uses `.replace()` string method (not regex) for placeholder substitution — safe for literal values with special characters
- Truncation: slices to `maxLength - 3` then appends `'...'` so final length equals maxLength exactly. Use `.trimEnd()` to avoid trailing whitespace before the ellipsis.
- `collectedData ?? {}` serializes undefined as empty object `{}`

TDD cycle: Write failing tests first, then implement, then verify green.
  </implementation>
</feature>

<verification>
```bash
cd server && npm test -- --reporter=verbose 2>&1 | grep -E "contextBuilder|buildContextual|PASS|FAIL"
```
All contextBuilder tests must pass. Specifically verify:
1. Default preamble format contains `[CONTEXT]`, `Phase:`, `Collected data:`, `Turn number:`
2. Custom template replaces default format entirely
3. `truncated: true` returned when query length exceeds maxLength
4. `query.length <= maxLength` always true (never exceeds limit)
5. `truncated: false` when within limit
</verification>

<success_criteria>
- server/src/workflow/contextBuilder.ts exports buildContextualQuery() and ContextBuilderConfig
- server/src/workflow/contextBuilder.test.ts covers: default format, custom template, truncation, no-truncation, undefined collectedData
- All tests pass: `cd server && npm test` exits 0
- Function is pure synchronous (no async, no external dependencies)
- Default maxLength is 2000, configurable via ContextBuilderConfig
</success_criteria>

<output>
After completion, create `.planning/phases/15-parser-context-builder/15-03-SUMMARY.md`
</output>
