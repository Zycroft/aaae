---
phase: 01-scaffold-schema-server-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.base.json
  - .prettierrc
  - eslint.config.mjs
  - .gitignore
  - client/package.json
  - client/tsconfig.json
  - client/vite.config.ts
  - client/src/main.tsx
  - client/src/App.tsx
  - client/.env.example
  - server/package.json
  - server/tsconfig.json
  - server/.env.example
  - shared/package.json
  - shared/tsconfig.json
  - shared/src/index.ts
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-04
  - INFRA-05
  - INFRA-06

must_haves:
  truths:
    - "Running `npm install` from repo root links all three workspaces without errors"
    - "Running `npm run dev` starts both the Vite client dev server and the Express server concurrently without crashing"
    - "Running `npm test` exits cleanly (even if no tests yet — zero test suites is acceptable)"
    - "Running `npm run lint` passes with no errors across all three workspaces"
    - "`npm ls zod` after install shows Zod in shared/ only (single instance)"
    - "client/.env.example and server/.env.example exist with every required variable and inline comments"
  artifacts:
    - path: "package.json"
      provides: "Root monorepo config with workspaces, overrides.zod, all root scripts"
      contains: "workspaces"
    - path: "client/package.json"
      provides: "Client workspace config referencing @copilot-chat/shared"
    - path: "server/package.json"
      provides: "Server workspace config referencing @copilot-chat/shared"
    - path: "shared/package.json"
      provides: "Shared package with Zod as sole consumer"
      contains: "zod"
    - path: "eslint.config.mjs"
      provides: "ESLint 9 flat config covering all workspaces"
    - path: "client/.env.example"
      provides: "Client env var documentation with VITE_API_URL"
    - path: "server/.env.example"
      provides: "Server env var documentation with COPILOT_ and AUTH vars"
  key_links:
    - from: "client/package.json"
      to: "@copilot-chat/shared"
      via: "npm workspaces symlink"
      pattern: "\"@copilot-chat/shared\""
    - from: "server/package.json"
      to: "@copilot-chat/shared"
      via: "npm workspaces symlink"
      pattern: "\"@copilot-chat/shared\""
    - from: "shared/package.json"
      to: "zod"
      via: "direct dependency"
      pattern: "\"zod\""
---

<objective>
Scaffold the npm workspaces monorepo with client/, server/, and shared/ packages. Configure TypeScript across all three, set up concurrently for the root dev script, configure Vitest (server) and Jest (client) for the test script, and set up ESLint 9 flat config + Prettier.

Purpose: This is the foundation every other plan depends on. Without a working monorepo structure, shared types cannot be consumed and the server cannot run.
Output: A runnable monorepo where `npm run dev`, `npm test`, and `npm run lint` all succeed.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-scaffold-schema-server-foundation/01-RESEARCH.md
@.planning/phases/01-scaffold-schema-server-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Root monorepo scaffold — package.json, TypeScript base, tooling configs</name>
  <files>
    package.json
    tsconfig.base.json
    .prettierrc
    eslint.config.mjs
    .gitignore
  </files>
  <action>
Create the root monorepo package.json with `"private": true`, workspaces array `["client", "server", "shared"]`, all root scripts, overrides for Zod, and root devDependencies.

Root package.json scripts:
- `"dev"`: `concurrently --names "CLIENT,SERVER" --kill-others-on-fail "npm run dev --workspace=client" "npm run dev --workspace=server"`
  (Note: shared/ dev watch runs as part of server dev — see server package.json)
- `"build"`: `npm run build --workspace=shared && npm run build --workspace=client && npm run build --workspace=server`
- `"test"`: `npm run test --workspace=client && npm run test --workspace=server`
- `"lint"`: `eslint .`
- `"format"`: `prettier --write .`
- `"format:check"`: `prettier --check .`

Root package.json overrides:
```json
"overrides": { "zod": "^3.24.0" }
```

Root devDependencies (install these):
- `concurrently@^9.1.2`
- `eslint@^9.0.0`
- `@eslint/js@^9.0.0`
- `@typescript-eslint/eslint-plugin@^8.0.0`
- `@typescript-eslint/parser@^8.0.0`
- `eslint-config-prettier@^10.0.0`
- `prettier@^3.0.0`
- `typescript@^5.7.0`

Create tsconfig.base.json at repo root:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  }
}
```

Create .prettierrc:
```json
{
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 100,
  "semi": true
}
```

Create eslint.config.mjs (ESLint 9 flat config — MUST use .mjs extension):
```javascript
import js from '@eslint/js';
import tsPlugin from '@typescript-eslint/eslint-plugin';
import tsParser from '@typescript-eslint/parser';
import prettierConfig from 'eslint-config-prettier';

export default [
  js.configs.recommended,
  {
    files: ['**/*.ts', '**/*.tsx'],
    languageOptions: { parser: tsParser, parserOptions: { ecmaVersion: 'latest' } },
    plugins: { '@typescript-eslint': tsPlugin },
    rules: {
      ...tsPlugin.configs.recommended.rules,
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
    },
  },
  prettierConfig,
  {
    ignores: [
      '**/dist/**',
      '**/node_modules/**',
      '**/.planning/**',
      'eslint.config.mjs',
    ],
  },
];
```

Create .gitignore including: node_modules/, dist/, .env (not .env.example), *.js.map (in dist/).

Run `npm install` from repo root after creating all package.json files to link workspaces.
  </action>
  <verify>
    `npm install` exits 0.
    `npm run lint` exits 0 (no TypeScript files yet — ESLint runs but finds nothing to error on).
    `npm run format:check` exits 0.
  </verify>
  <done>Root workspace installs and all tooling configs are in place. `npm ls` shows workspace links.</done>
</task>

<task type="auto">
  <name>Task 2: Workspace packages — client, server, shared package.json + tsconfig + minimal entry points</name>
  <files>
    client/package.json
    client/tsconfig.json
    client/vite.config.ts
    client/src/main.tsx
    client/src/App.tsx
    client/index.html
    client/.env.example
    server/package.json
    server/tsconfig.json
    server/src/index.ts
    server/.env.example
    shared/package.json
    shared/tsconfig.json
    shared/src/index.ts
  </files>
  <action>
**shared/package.json** — name: `@copilot-chat/shared`; `"main": "./dist/index.js"`; `"types": "./dist/index.d.ts"`; exports map with CJS + types; scripts: `"build": "tsc --build"`, `"dev": "tsc --build --watch"`; dependencies: `"zod": "^3.24.0"` ONLY. No other dependencies.

**shared/tsconfig.json**:
```json
{
  "extends": "../tsconfig.base.json",
  "compilerOptions": {
    "composite": true,
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
```

**shared/src/index.ts** — placeholder that re-exports everything (will be filled by Plan 02):
```typescript
export const SHARED_VERSION = '0.0.1';
```

**client/package.json** — name: `@copilot-chat/client`; `"private": true`; scripts: `"dev": "vite"`, `"build": "tsc -b && vite build"`, `"test": "jest --passWithNoTests"`, `"preview": "vite preview"`; devDependencies: `vite@^6.0.0`, `@vitejs/plugin-react@^4.x`, `typescript@^5.7.0`, `jest@^29.0.0`, `@types/jest@^29.0.0`, `ts-jest@^29.0.0`, `@types/react@^18.x`, `@types/react-dom@^18.x`; dependencies: `react@^18.x`, `react-dom@^18.x`, `@copilot-chat/shared@*`.

**client/tsconfig.json**:
```json
{
  "extends": "../tsconfig.base.json",
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "jsx": "react-jsx",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "noEmit": true
  },
  "include": ["src/**/*"],
  "references": [{ "path": "../shared" }]
}
```

**client/vite.config.ts**:
```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: process.env.VITE_API_URL || 'http://localhost:3001',
        changeOrigin: true,
      },
    },
  },
});
```

**client/src/App.tsx** — minimal placeholder:
```tsx
export default function App() {
  return <div>Copilot Chat — Phase 1 scaffold</div>;
}
```

**client/src/main.tsx** — standard Vite React entry:
```tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.tsx';
ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode><App /></React.StrictMode>
);
```

**client/index.html** — standard Vite HTML entry with `<div id="root">` and `<script type="module" src="/src/main.tsx">`.

**client/.env.example**:
```
# The URL of the Express server (no trailing slash)
# Development: http://localhost:3001
VITE_API_URL=http://localhost:3001
```

**server/package.json** — name: `@copilot-chat/server`; `"private": true`; `"type": "module"`; scripts: `"dev": "tsx watch src/index.ts"`, `"build": "tsc --build"`, `"start": "node dist/index.js"`, `"test": "vitest run"`; dependencies: `express@^4.21.0`, `cors@^2.8.5`, `dotenv@^16.0.0`, `uuid@^11.0.0`, `lru-cache@^11.0.0`, `@microsoft/agents-copilotstudio-client@^1.1.1`, `@copilot-chat/shared@*`; devDependencies: `typescript@^5.7.0`, `@types/express@^4.x`, `@types/cors@^2.x`, `@types/node@^20.x`, `tsx@^4.x`, `vitest@^3.x`.

**server/tsconfig.json**:
```json
{
  "extends": "../tsconfig.base.json",
  "compilerOptions": {
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"],
  "references": [{ "path": "../shared" }]
}
```

**server/src/index.ts** — minimal placeholder (will be replaced by Plan 03):
```typescript
console.log('Server placeholder — Plan 03 will replace this');
```

**server/.env.example** — include ALL env vars with inline comments explaining each:
```
# --- Copilot Studio Connection ---
# Your Power Platform environment ID — from Power Platform Admin Center > Environments
COPILOT_ENVIRONMENT_ID=your-environment-id-here

# The schema name of your Copilot Studio agent — from Copilot Studio > Agent Settings > Schema Name
COPILOT_AGENT_SCHEMA_NAME=your-agent-schema-name-here

# Your Azure App Registration tenant ID — from Azure Portal > App Registrations > Overview
COPILOT_TENANT_ID=your-tenant-id-here

# Your Azure App Registration client ID — from Azure Portal > App Registrations > Overview
COPILOT_APP_ID=your-app-client-id-here

# Your Azure App Registration client secret — from Azure Portal > App Registrations > Certificates & Secrets
# NEVER commit real secrets — this file is for documentation only
COPILOT_CLIENT_SECRET=your-client-secret-here

# --- Auth Stub (Phase 1) ---
# Set to "false" to bypass auth check for local dev. Default: "true" (fail-closed — never open by accident).
AUTH_REQUIRED=true

# Stub bearer token for local dev when AUTH_REQUIRED=false. Leave blank in production.
COPILOT_STUB_TOKEN=

# --- Server Config ---
# The port the Express server listens on
PORT=3001

# The exact client origin for CORS — no trailing slash (must match Vite dev server URL exactly)
CORS_ORIGIN=http://localhost:5173
```

After creating all package.json files, run `npm install` again from root to install all workspace dependencies.

Build shared/ first so TypeScript declarations exist: `npm run build --workspace=shared`.
  </action>
  <verify>
    `npm run build --workspace=shared` exits 0 and produces `shared/dist/index.js` and `shared/dist/index.d.ts`.
    `npm ls @copilot-chat/shared` shows it linked in both client and server.
    `npm ls zod` shows exactly ONE zod entry (under shared/).
    `npm run dev --workspace=server` starts and prints the placeholder log then stays running (for tsx watch). Kill after confirming.
    `npm run test --workspace=server` exits 0 (no test files yet, vitest --passWithNoTests equivalent or zero suites).
    `npm run test --workspace=client` exits 0 (`jest --passWithNoTests`).
    `npm run lint` exits 0.
  </verify>
  <done>
    All three workspace package.json files created and linked.
    `npm ls zod` shows single instance.
    `shared/dist/` exists with .js and .d.ts files.
    Both test runners pass with zero suites.
    `.env.example` files exist with all variables and inline comments.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `npm install` — clean install from scratch (delete node_modules first to simulate fresh clone), verify it completes without errors
2. `npm run build --workspace=shared` — exits 0, dist/ produced
3. `npm run dev` — both CLIENT and SERVER labels appear in concurrently output; Vite starts on 5173, server placeholder on 3001
4. `npm test` — both workspaces report 0 test suites, exit 0
5. `npm run lint` — 0 errors, 0 warnings
6. `npm ls zod` — exactly ONE entry (in shared/)
7. `cat server/.env.example` — contains all COPILOT_* vars, AUTH_REQUIRED, PORT, CORS_ORIGIN with inline comments
8. `cat client/.env.example` — contains VITE_API_URL with comment
9. `grep -r "COPILOT" client/` — returns no matches (no COPILOT vars in client code)
</verification>

<success_criteria>
- Monorepo structure: client/, server/, shared/ all exist as npm workspaces
- TypeScript configured: tsconfig.base.json + per-workspace tsconfig.json files extending it
- `npm run dev` starts both Vite (port 5173) and server concurrently with labeled output
- `npm test` exits 0 across both workspaces
- `npm run lint` exits 0
- `npm ls zod` shows single instance
- .env.example files exist for both client and server with inline-commented variables
- No COPILOT_ secrets in client/ tree
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold-schema-server-foundation/01-01-SUMMARY.md` using the summary template at @/Users/zycroft/.claude/get-shit-done/templates/summary.md
</output>
