---
phase: 01-scaffold-schema-server-foundation
plan: 04
type: execute
wave: 3
depends_on:
  - "01-02"
  - "01-03"
files_modified:
  - server/src/copilot.ts
  - server/src/routes/chat.ts
  - server/src/app.ts
autonomous: true
requirements:
  - SERV-02

must_haves:
  truths:
    - "`POST /api/chat/start` with valid Authorization header returns `{ conversationId }` where conversationId is a UUID"
    - "`POST /api/chat/start` without Authorization header returns 401 when AUTH_REQUIRED=true"
    - "The conversationId returned by /api/chat/start is stored in ConversationStore and retrievable"
    - "CopilotStudioClient is instantiated once at module level — not per-request"
    - "No COPILOT_ secrets appear in client/ — `grep -r COPILOT client/` returns no matches"
  artifacts:
    - path: "server/src/copilot.ts"
      provides: "Module-level CopilotStudioClient singleton with stub token and TODO for MSAL OBO"
      exports: ["copilotClient", "copilotSettings"]
    - path: "server/src/routes/chat.ts"
      provides: "POST /api/chat/start route handler"
      exports: ["chatRouter"]
  key_links:
    - from: "server/src/app.ts"
      to: "server/src/routes/chat.ts"
      via: "app.use('/api/chat', chatRouter)"
      pattern: "chatRouter"
    - from: "server/src/routes/chat.ts"
      to: "server/src/copilot.ts"
      via: "import copilotClient"
      pattern: "copilotClient"
    - from: "server/src/routes/chat.ts"
      to: "server/src/store/index.ts"
      via: "import conversationStore"
      pattern: "conversationStore"
    - from: "server/src/routes/chat.ts"
      to: "@copilot-chat/shared"
      via: "StartConversationResponseSchema for response shape"
      pattern: "StartConversationResponseSchema"

user_setup:
  - service: "@microsoft/agents-copilotstudio-client"
    why: "Copilot Studio connection requires real environment credentials to make actual API calls"
    env_vars:
      - name: COPILOT_ENVIRONMENT_ID
        source: "Power Platform Admin Center > Environments > select env > copy Environment ID"
      - name: COPILOT_AGENT_SCHEMA_NAME
        source: "Copilot Studio > your agent > Settings > Advanced > Schema name"
      - name: COPILOT_TENANT_ID
        source: "Azure Portal > Azure Active Directory > Overview > Tenant ID"
    dashboard_config:
      - task: "Ensure Copilot Studio agent is published and accessible"
        location: "Copilot Studio > your agent > Publish"
---

<objective>
Implement the CopilotStudioClient singleton and the POST /api/chat/start route. The endpoint calls startConversationStreaming(), collects activities, generates a server-side UUID as the external conversationId, stores it in ConversationStore, and returns it to the client.

Purpose: This is the first real Copilot Studio integration point. It proves the server can reach Copilot Studio and begin a conversation session.
Output: A working POST /api/chat/start endpoint that returns `{ conversationId }`.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-scaffold-schema-server-foundation/01-RESEARCH.md
@.planning/phases/01-scaffold-schema-server-foundation/01-CONTEXT.md
@.planning/phases/01-scaffold-schema-server-foundation/01-02-SUMMARY.md
@.planning/phases/01-scaffold-schema-server-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: CopilotStudioClient singleton (copilot.ts)</name>
  <files>
    server/src/copilot.ts
  </files>
  <action>
Create server/src/copilot.ts — module-level singleton, never imported by client:

```typescript
import {
  CopilotStudioClient,
  ConnectionSettings,
} from '@microsoft/agents-copilotstudio-client';
import { config } from './config.js';

// Build ConnectionSettings explicitly from config.ts values.
// We do NOT use loadCopilotStudioConnectionSettingsFromEnv() because its env var
// names are undocumented — explicit construction is clearer and testable.
export const copilotSettings = new ConnectionSettings({
  environmentId: config.COPILOT_ENVIRONMENT_ID,
  schemaName: config.COPILOT_AGENT_SCHEMA_NAME,
});

// TODO: Replace stub token with real MSAL OBO token flow.
// Real implementation:
//   1. Import ConfidentialClientApplication from @azure/msal-node
//   2. Configure with config.COPILOT_TENANT_ID, config.COPILOT_APP_ID, config.COPILOT_CLIENT_SECRET
//   3. Call acquireTokenOnBehalfOf() with inbound user's Bearer token
//   4. Scope: CopilotStudioClient.scopeFromSettings(copilotSettings)
//   5. Pass the acquired token to new CopilotStudioClient(copilotSettings, acquiredToken)
//   6. For per-request auth (OBO), the client may need to be created per-request (see v2 AUTH-02)
//
// WARNING: With AUTH_REQUIRED=true (default), requests reach this code only with an
// Authorization header — but that header is NOT validated in Phase 1. Real validation is v2.
const STUB_TOKEN = config.COPILOT_STUB_TOKEN;

/**
 * Module-level CopilotStudioClient singleton.
 * Server-side only — NEVER import this in client/ code.
 * Production token acquisition replaces STUB_TOKEN above.
 */
export const copilotClient = new CopilotStudioClient(copilotSettings, STUB_TOKEN);
```

Note: CopilotStudioClient constructor signature: `new CopilotStudioClient(settings: ConnectionSettings, token: string)`. If the SDK version installed does not match this signature, check the installed version's API and adapt accordingly — do not modify the ConnectionSettings fields, only the constructor call pattern if needed.
  </action>
  <verify>
    `cd server && npx tsc --noEmit` exits 0 — copilot.ts type-checks correctly.
    `npm run dev --workspace=server` still starts without errors (copilot.ts is imported at module level).
    `grep -r "agents-copilotstudio-client" client/` — returns no matches (not in client code).
  </verify>
  <done>
    copilot.ts exports copilotClient singleton and copilotSettings.
    TypeScript compiles clean.
    Client code has no reference to Copilot SDK.
  </done>
</task>

<task type="auto">
  <name>Task 2: POST /api/chat/start route + wire into app</name>
  <files>
    server/src/routes/chat.ts
    server/src/app.ts
  </files>
  <action>
**server/src/routes/chat.ts** — The /api/chat/start endpoint:

```typescript
import { Router } from 'express';
import { v4 as uuidv4 } from 'uuid';
import type { Activity } from '@microsoft/agents-activity';
import { copilotClient } from '../copilot.js';
import { conversationStore } from '../store/index.js';

export const chatRouter = Router();

/**
 * POST /api/chat/start
 * Starts a new Copilot Studio conversation.
 * Returns: { conversationId: string } — a server-generated UUID.
 *
 * The Copilot SDK's internal conversation state is captured via the streaming
 * generator and stored in ConversationStore alongside the external UUID.
 */
chatRouter.post('/start', async (_req, res) => {
  try {
    const externalId = uuidv4(); // The conversationId we return to clients
    const collectedActivities: Activity[] = [];

    // startConversationStreaming returns AsyncGenerator<Activity> — NOT a Promise.
    // Must use for-await-of to consume it.
    for await (const activity of copilotClient.startConversationStreaming(true)) {
      collectedActivities.push(activity);
    }

    await conversationStore.set(externalId, {
      externalId,
      sdkConversationRef: collectedActivities, // Store raw activities for Phase 2 normalizer
      history: [], // Message history populated in Phase 2
    });

    res.status(200).json({ conversationId: externalId });
  } catch (err) {
    console.error('[chat/start] Error starting conversation:', err);
    res.status(502).json({ error: 'Failed to start conversation with Copilot Studio' });
  }
});
```

**server/src/app.ts** — Add chatRouter registration (update the existing createApp() to include):

```typescript
// Add after existing middleware setup, before the return:
import { chatRouter } from './routes/chat.js';
// ...
app.use('/api/chat', chatRouter);
```

Make sure the import is at the top of app.ts and `app.use('/api/chat', chatRouter)` is added inside createApp() after the `app.use('/api', authMiddleware)` line.

IMPORTANT: The `/api/chat/start` endpoint will return a 502 error when called without real Copilot Studio credentials — this is expected behavior in Phase 1. The endpoint structure, auth guard, UUID generation, and store write are all testable by mocking `copilotClient.startConversationStreaming`. The actual Copilot connection is validated in the Phase 2 integration test with real credentials.
  </action>
  <verify>
    `npm run dev --workspace=server` — server starts, no errors.
    `curl -X POST -H "Authorization: Bearer stub" -H "Content-Type: application/json" http://localhost:3001/api/chat/start`
    → With real credentials in server/.env: returns 200 `{"conversationId":"<uuid>"}` where uuid matches RFC 4122 format
    → Without real credentials (stub token): returns 502 (expected — Copilot Studio rejects stub token)
    `curl -X POST http://localhost:3001/api/chat/start` → returns 401 (no auth header)
    `grep -r "COPILOT" client/` → returns no matches
    TypeScript: `cd server && npx tsc --noEmit` exits 0
  </verify>
  <done>
    POST /api/chat/start route registered and responds:
    - 401 when no Authorization header and AUTH_REQUIRED=true
    - 200 { conversationId } with real Copilot credentials
    - 502 with stub credentials (expected — Copilot SDK rejects)
    Route is behind authMiddleware via app.use('/api', authMiddleware).
    conversationId is a valid UUID format.
    No Copilot SDK in client code.
  </done>
</task>

</tasks>

<verification>
Final phase verification — all 5 success criteria from ROADMAP.md:

1. `npm run dev` from repo root — both CLIENT (Vite on 5173) and SERVER (Express on 3001) start without errors. ✓
2. `npm test` from repo root — runs Jest in client/ and Vitest in server/, exits cleanly. ✓
3. `npm ls zod` — returns exactly one instance of Zod (in shared/). ✓
4. `POST /api/chat/start`:
   - Without Authorization header → 401 `{"error":"Unauthorized"}` ✓
   - With valid credentials → 200 `{"conversationId":"<uuid>"}` ✓
5. `grep -r "COPILOT" client/` — returns no matches. ✓

Additional checks:
- `curl http://localhost:3001/health` → `{"status":"ok","authRequired":true}`
- TypeScript: `cd server && npx tsc --noEmit` → exits 0
- TypeScript: `cd shared && npx tsc --noEmit` → exits 0
</verification>

<success_criteria>
- POST /api/chat/start is registered on the Express router
- The endpoint is protected by authMiddleware (401 without Authorization header)
- With real Copilot credentials: returns 200 `{ conversationId: "<uuid>" }`
- With stub credentials: returns 502 (expected — Copilot Studio rejects stub token)
- conversationId stored in ConversationStore after successful call
- CopilotStudioClient is a module-level singleton (not instantiated per request)
- `grep -r "COPILOT" client/` returns no matches
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold-schema-server-foundation/01-04-SUMMARY.md` using the summary template at @/Users/zycroft/.claude/get-shit-done/templates/summary.md
</output>
