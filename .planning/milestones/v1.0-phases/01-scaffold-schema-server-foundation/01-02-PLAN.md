---
phase: 01-scaffold-schema-server-foundation
plan: 02
type: tdd
wave: 2
depends_on:
  - "01-01"
files_modified:
  - shared/src/schemas/message.ts
  - shared/src/schemas/api.ts
  - shared/src/index.ts
  - shared/src/__tests__/schemas.test.ts
autonomous: true
requirements:
  - SCHEMA-01
  - SCHEMA-02
  - SCHEMA-03
  - SCHEMA-04

must_haves:
  truths:
    - "NormalizedMessage schema parses valid text messages and rejects messages missing required fields"
    - "NormalizedMessage schema parses valid adaptiveCard messages and rejects messages with wrong kind"
    - "All three API endpoint request/response schemas are importable from @copilot-chat/shared"
    - "TypeScript types inferred via z.infer<> are exported alongside schemas"
    - "`npm ls zod` still shows single instance after schema work (no new Zod dep introduced)"
  artifacts:
    - path: "shared/src/schemas/message.ts"
      provides: "NormalizedMessage Zod schema + TypeScript type"
      exports: ["NormalizedMessageSchema", "NormalizedMessage"]
    - path: "shared/src/schemas/api.ts"
      provides: "API endpoint schemas for start, send, card-action"
      exports:
        - "StartConversationResponseSchema"
        - "SendMessageRequestSchema"
        - "SendMessageResponseSchema"
        - "CardActionRequestSchema"
        - "CardActionResponseSchema"
    - path: "shared/src/__tests__/schemas.test.ts"
      provides: "Vitest tests covering all schema valid/invalid cases"
    - path: "shared/src/index.ts"
      provides: "Barrel export of all schemas and types"
  key_links:
    - from: "shared/src/index.ts"
      to: "shared/src/schemas/message.ts"
      via: "re-export"
      pattern: "export.*from.*schemas/message"
    - from: "shared/src/index.ts"
      to: "shared/src/schemas/api.ts"
      via: "re-export"
      pattern: "export.*from.*schemas/api"
---

<objective>
Implement the shared Zod schemas using TDD: NormalizedMessage schema and all three API endpoint request/response schemas. All types are inferred with z.infer<> and exported from the shared package barrel.

Purpose: The shared schemas are the single source of truth for type safety between client and server. Without them, neither the server response shapes nor client consumption are type-safe.
Output: shared/src/schemas/ with passing tests; shared/dist/ rebuilt with schema exports.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-scaffold-schema-server-foundation/01-RESEARCH.md
@.planning/phases/01-scaffold-schema-server-foundation/01-CONTEXT.md
@.planning/phases/01-scaffold-schema-server-foundation/01-01-SUMMARY.md
</context>

<feature>
  <name>Shared Zod schemas — NormalizedMessage + API endpoint shapes</name>
  <files>shared/src/schemas/message.ts, shared/src/schemas/api.ts, shared/src/index.ts, shared/src/__tests__/schemas.test.ts</files>
  <behavior>
NormalizedMessage (SCHEMA-01):
- id: string UUID — required
- role: "user" | "assistant" — required
- kind: "text" | "adaptiveCard" — required
- text: string — optional (present when kind = "text")
- cardJson: Record&lt;string, unknown&gt; — optional (present when kind = "adaptiveCard")
- cardId: string — optional (present when kind = "adaptiveCard")

Test cases for NormalizedMessage:
- Valid text message: `{ id: "some-uuid", role: "user", kind: "text", text: "hello" }` → parse succeeds
- Valid adaptiveCard message: `{ id: "uuid", role: "assistant", kind: "adaptiveCard", cardJson: {}, cardId: "card-1" }` → parse succeeds
- Missing id → parse throws ZodError
- Missing role → parse throws ZodError
- Invalid role value "system" → parse throws ZodError
- Invalid kind value "image" → parse throws ZodError
- Missing kind → parse throws ZodError

API Schemas (SCHEMA-02):
- POST /api/chat/start response: `{ conversationId: string (UUID) }`
- POST /api/chat/send request: `{ conversationId: string (UUID), text: string (min 1 char) }`
- POST /api/chat/send response: `{ conversationId: string (UUID), messages: NormalizedMessage[] }`
- POST /api/chat/card-action request: `{ conversationId: string (UUID), cardId: string, userSummary: string, submitData: Record&lt;string, unknown&gt; }`
- POST /api/chat/card-action response: `{ conversationId: string (UUID), messages: NormalizedMessage[] }`

Test cases for API schemas:
- Valid StartConversationResponse → parse succeeds
- StartConversationResponse with non-UUID conversationId → parse throws ZodError
- Valid SendMessageRequest → parse succeeds
- SendMessageRequest with empty text string → parse throws ZodError
- Valid CardActionRequest → parse succeeds

TypeScript types (SCHEMA-04):
- `NormalizedMessage` type exported (inferred from schema)
- `StartConversationResponse`, `SendMessageRequest`, `SendMessageResponse`, `CardActionRequest`, `CardActionResponse` types exported

Zod single instance (SCHEMA-03):
- Tests import Zod only via schema files (which import from 'zod' in shared/)
- `npm ls zod` still shows one entry after plan completion
  </behavior>
  <implementation>
RED phase: Write all test cases first in shared/src/__tests__/schemas.test.ts. Run `npm run test --workspace=shared` — tests MUST fail (schemas don't exist yet).

Configure Vitest in shared/package.json: add `"test": "vitest run"` script. Add vitest as devDependency in shared/package.json.

GREEN phase: Implement schemas in shared/src/schemas/message.ts and shared/src/schemas/api.ts. Update shared/src/index.ts to barrel-export all schemas and types. Run `npm run test --workspace=shared` — all tests MUST pass.

REFACTOR phase: Ensure exports are clean, names are clear. Run tests again — MUST still pass.

Rebuild shared/: `npm run build --workspace=shared` to update dist/ with new exports.

CRITICAL:
- Use `z.string().uuid()` for conversationId fields, NOT plain z.string()
- Use `z.string().min(1)` for text in send request
- Use `z.enum(['text', 'adaptiveCard'])` for kind field (SCHEMA-01 exact values)
- Use `z.enum(['user', 'assistant'])` for role field
- Do NOT install Zod in shared/src test files — schemas import from 'zod' naturally
- shared/src/__tests__/schemas.test.ts imports schemas only from '../schemas/message.js' and '../schemas/api.js' (use .js extension for NodeNext resolution)
  </implementation>
</feature>

<verification>
1. `npm run test --workspace=shared` — all tests pass, none skipped
2. `npm run build --workspace=shared` — exits 0, shared/dist/ updated
3. Verify exports from dist: `node -e "const s = require('./shared/dist/index.js'); console.log(Object.keys(s))"` — lists all schema and type names
4. `npm ls zod` — single entry still
5. `grep -r "zod" server/package.json client/package.json` — returns no matches (Zod not in consumer packages)
</verification>

<success_criteria>
- All Zod schema tests pass (valid parses succeed, invalid parses throw ZodError)
- NormalizedMessage type exported and usable in TypeScript: `type M = NormalizedMessage`
- All API request/response types exported
- shared/dist/ rebuilt with all exports visible
- `npm ls zod` — single instance confirmed
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffold-schema-server-foundation/01-02-SUMMARY.md` using the summary template at @/Users/zycroft/.claude/get-shit-done/templates/summary.md
</output>
