# Requirements Archive: v1.2 Entra External ID Authentication

**Archived:** 2026-02-21
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: Agentic Copilot Chat App

**Defined:** 2026-02-20
**Core Value:** Users can interact with a Copilot Studio agent through a polished chat UI that seamlessly mixes text responses and interactive Adaptive Cards — server-side only, secrets protected.

## v1.2 Requirements

Requirements for v1.2 Entra External ID Authentication (MSAL). Each maps to roadmap phases.

### Client Authentication

- [x] **CAUTH-01**: User sees a sign-in page (not the chat UI) when unauthenticated
- [x] **CAUTH-02**: User can sign in via Entra External ID (CIAM) redirect flow
- [x] **CAUTH-03**: After sign-in, chat functions identically to v1.1 (no regression)
- [x] **CAUTH-04**: Token is acquired silently on mount (acquireTokenSilent) with redirect fallback
- [x] **CAUTH-05**: Authorization: Bearer {token} is attached to every API call automatically
- [x] **CAUTH-06**: User can sign out (clears MSAL cache, returns to sign-in page)
- [x] **CAUTH-07**: Token refresh happens silently — user is not logged out mid-conversation

### Server Authentication

- [x] **SAUTH-01**: Server validates JWT signature using JWKS from CIAM discovery endpoint
- [x] **SAUTH-02**: Server rejects tokens with wrong audience (not `api://{server-app-id}`)
- [x] **SAUTH-03**: Server rejects expired tokens
- [x] **SAUTH-04**: Server rejects tokens with invalid issuer
- [x] **SAUTH-05**: Decoded claims are attached to `req.user` for downstream use
- [x] **SAUTH-06**: Invalid/missing tokens return 401 with `WWW-Authenticate` header

### Org Allowlist

- [x] **ORG-01**: Server extracts `tid` (tenant ID) claim from validated JWT
- [x] **ORG-02**: Server checks `tid` against `ALLOWED_TENANT_IDS` environment variable
- [x] **ORG-03**: Disallowed tenants receive 403 with clear error message
- [x] **ORG-04**: Denied access attempts are logged (tenant ID, timestamp)

### Shared Schema

- [x] **SCHEMA-01**: `UserClaims` Zod schema exists in `shared/src/schemas/auth.ts` with fields: sub, tid, email?, name?, oid
- [x] **SCHEMA-02**: TypeScript type exported for server-side `req.user`

### Configuration

- [x] **CFG-01**: Server env vars added: `AZURE_TENANT_NAME`, `AZURE_CLIENT_ID`, `ALLOWED_TENANT_IDS`
- [x] **CFG-02**: Client env vars added: `VITE_AZURE_CLIENT_ID`, `VITE_AZURE_TENANT_NAME`, `VITE_AZURE_REDIRECT_URI`
- [x] **CFG-03**: `.env.example` files updated for both workspaces
- [x] **CFG-04**: Server fails closed (refuses all requests) if `AZURE_CLIENT_ID` is not set when `AUTH_REQUIRED=true`
- [x] **CFG-05**: `AUTH_REQUIRED=false` still works for local dev without Azure AD setup

### Testing

- [x] **TEST-01**: Unit tests for JWT validation middleware (mock JWKS, test expired/invalid/valid tokens)
- [x] **TEST-02**: Unit tests for Org Allowlist middleware (allowed/denied tenants, missing tid)
- [x] **TEST-03**: CI continues to pass with new code

## Future Requirements

### Downstream API Calls (v1.3+)

- **OBO-01**: Server acquires OBO tokens to call downstream APIs as the user
- **OBO-02**: Token cache per user session

### Enhanced Auth UX (v1.3+)

- **UX-01**: User profile display (name, email from claims)
- **UX-02**: Session timeout warning before token expiry

## Out of Scope

| Feature | Reason |
|---------|--------|
| MSAL Node OBO flow | v1.2 server only validates incoming tokens; Copilot Studio uses its own credentials |
| Custom login UI (username/password form) | MSAL handles the login UI via redirect to Entra |
| Multi-factor authentication config | MFA is configured in Entra portal, not in app code |
| Role-based access control (RBAC) | Not needed for v1.2; all authenticated users from allowed tenants have equal access |
| Social identity providers (Google, Facebook) | Can be configured in Entra External ID portal later; no code changes needed |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| SCHEMA-01 | Phase 5 | Complete |
| SCHEMA-02 | Phase 5 | Complete |
| CFG-01 | Phase 5 | Complete |
| CFG-02 | Phase 5 | Complete |
| CFG-03 | Phase 5 | Complete |
| CFG-04 | Phase 5 | Complete |
| CFG-05 | Phase 5 | Complete |
| SAUTH-01 | Phase 6 | Complete |
| SAUTH-02 | Phase 6 | Complete |
| SAUTH-03 | Phase 6 | Complete |
| SAUTH-04 | Phase 6 | Complete |
| SAUTH-05 | Phase 6 | Complete |
| SAUTH-06 | Phase 6 | Complete |
| ORG-01 | Phase 6 | Complete |
| ORG-02 | Phase 6 | Complete |
| ORG-03 | Phase 6 | Complete |
| ORG-04 | Phase 6 | Complete |
| TEST-01 | Phase 6 | Complete |
| TEST-02 | Phase 6 | Complete |
| CAUTH-01 | Phase 7 | Complete |
| CAUTH-02 | Phase 7 | Complete |
| CAUTH-03 | Phase 7 | Complete |
| CAUTH-04 | Phase 7 | Complete |
| CAUTH-05 | Phase 7 | Complete |
| CAUTH-06 | Phase 7 | Complete |
| CAUTH-07 | Phase 7 | Complete |
| TEST-03 | Phase 7 | Complete |

**Coverage:**
- v1.2 requirements: 24 total
- Mapped to phases: 24
- Unmapped: 0 ✓

---
*Requirements defined: 2026-02-20*
*Last updated: 2026-02-20 after roadmap creation (Phases 5–7)*
