---
milestone: v1.4
audited: 2026-02-22
status: gaps_found
scores:
  requirements: 25/26
  phases: 3/3
  integration: 25/26
  flows: 5/5
gaps:
  requirements:
    - id: "RESIL-01"
      status: "unsatisfied"
      phase: "Phase 12"
      claimed_by_plans: ["12-01-PLAN.md"]
      completed_by_plans: ["12-01-SUMMARY.md"]
      verification_status: "passed (phase-level) / broken (integration-level)"
      evidence: "Phase 12 VERIFICATION marks PASS based on 'errors propagate naturally from RedisStore' — but route handlers in chat.ts and orchestrate.ts catch ALL errors as 502 Bad Gateway. No distinction between Redis failures (should be 503) and Copilot Studio failures (502). The core safety property (no silent fallback to InMemory) IS satisfied, but the specific 503 status code required by RESIL-01 is not returned."
  integration:
    - from: "Phase 12 (RedisStore error propagation)"
      to: "Phase 13 (route error handlers)"
      issue: "Route catch blocks return 502 for all errors — Redis errors should return 503 per RESIL-01"
      affected_requirements: ["RESIL-01"]
  flows: []
tech_debt: []
---

# v1.4 Milestone Audit: Persistent State Store (Azure Cache for Redis)

**Audited:** 2026-02-22
**Status:** gaps_found
**Score:** 25/26 requirements satisfied

## Phase Verification Summary

| Phase | Status | Success Criteria | Requirements | Tests |
|-------|--------|-----------------|-------------|-------|
| 11: StoredConversation Schema + Store Abstraction | PASS | 5/5 | 11/11 | 54 pass |
| 12: Redis Implementation + Resilience | PASS | 6/6 | 8/8 | 68 pass |
| 13: Route Integration + Tests | PASS | 5/5 | 7/7 | 75 pass |

All phases passed individual verification. The gap below was found during cross-phase integration checking.

## Requirements Cross-Reference (3-Source)

| REQ-ID | Description | Phase | VERIFICATION | SUMMARY | REQUIREMENTS.md | Final Status |
|--------|-------------|-------|-------------|---------|-----------------|-------------|
| STATE-01 | userId and tenantId fields | 11 | PASS | Listed (11-01) | [ ] | satisfied |
| STATE-02 | createdAt and updatedAt timestamps | 11 | PASS | Listed (11-01) | [ ] | satisfied |
| STATE-03 | status field (active/completed/abandoned) | 11 | PASS | Listed (11-01) | [ ] | satisfied |
| STATE-04 | optional workflow fields | 11 | PASS | Listed (11-01) | [ ] | satisfied |
| STATE-05 | Zod schema in shared/src/schemas/ | 11 | PASS | Listed (11-01) | [ ] | satisfied |
| STATE-06 | backward compatible defaults | 11 | PASS | Listed (11-01) | [ ] | satisfied |
| STORE-01 | Redis persistence when REDIS_URL set | 11 | PASS | Listed (11-02) | [ ] | satisfied |
| STORE-02 | InMemoryStore when REDIS_URL absent | 11 | PASS | Listed (11-02) | [ ] | satisfied |
| STORE-03 | factory selects via REDIS_URL | 11 | PASS | Listed (11-02) | [ ] | satisfied |
| STORE-04 | logs which store backend active | 11 | PASS | Listed (11-02) | [ ] | satisfied |
| STORE-05 | TLS for Azure Cache (rediss://) | 12 | PASS | Listed (12-01) | [ ] | satisfied |
| STORE-06 | configurable TTL (default 24h) | 12 | PASS | Listed (12-01) | [ ] | satisfied |
| STORE-07 | configurable timeout (default 5s) | 12 | PASS | Listed (12-01) | [ ] | satisfied |
| QUERY-01 | listByUser(userId) method | 11 | PASS | Listed (11-02) | [ ] | satisfied |
| QUERY-02 | listByUser sorted, limit 50 | 12 | PASS | Listed (12-01) | [ ] | satisfied |
| QUERY-03 | sorted set secondary index | 12 | PASS | Listed (12-01) | [ ] | satisfied |
| **RESIL-01** | **503 when Redis unreachable** | **12** | **PASS (phase)** | **Listed (12-01)** | **[ ]** | **unsatisfied** |
| RESIL-02 | /health reports Redis status | 12 | PASS | Listed (12-02) | [ ] | satisfied |
| RESIL-03 | retry on transient errors | 12 | PASS | Listed (12-01) | [ ] | satisfied |
| ROUTE-01 | /start sets userId/tenantId from JWT | 13 | PASS | Listed (13-01) | [ ] | satisfied |
| ROUTE-02 | /start sets createdAt and status='active' | 13 | PASS | Prior phases | [ ] | satisfied |
| ROUTE-03 | /send and /card-action update updatedAt | 13 | PASS | Prior phases | [ ] | satisfied |
| ROUTE-04 | placeholder values when auth not deployed | 13 | PASS | Prior phases | [ ] | satisfied |
| TEST-01 | RedisStore unit tests (ioredis-mock) | 13 | PASS | Prior phases | [ ] | satisfied |
| TEST-02 | factory pattern unit tests | 13 | PASS | Listed (13-01) | [ ] | satisfied |
| TEST-03 | .env.example with Redis vars | 13 | PASS | Prior phases | [ ] | satisfied |

## Gap Detail: RESIL-01

**Requirement:** Server returns 503 Service Unavailable when Redis is unreachable

**Root cause:** Route error handlers in `chat.ts` and `orchestrate.ts` catch ALL errors with a single catch block that returns 502 Bad Gateway. There is no distinction between Redis errors (should be 503) and Copilot Studio errors (502).

**Evidence (4 catch blocks, all returning 502):**
- `server/src/routes/chat.ts:73` — `/start` → 502
- `server/src/routes/chat.ts:135` — `/send` → 502
- `server/src/routes/chat.ts:203` — `/card-action` → 502
- `server/src/routes/orchestrate.ts:129` — `/orchestrate` → 502

**Why phase verification missed it:** Phase 12 verified that RedisStore methods do NOT catch errors (correct — they propagate). The verification assumed an Express error middleware would catch them as 503, but the routes' own try/catch blocks intercept first with 502.

**Impact:** Operators cannot distinguish Redis unavailability from Copilot Studio failures in monitoring/alerting. The core safety property (no silent fallback to InMemory) IS satisfied.

**Fix scope:** ~10 lines across 4 route handlers — check error type/message before selecting status code.

## Integration Check Results

Cross-phase wiring verified for 5 E2E flows:

| Flow | Status | Key Path |
|------|--------|----------|
| Store backend selection | PASS | Config → factory → singleton → routes |
| Conversation creation | PASS | JWT → req.user → /start → store.set() with userId/tenantId |
| Message send updates | PASS | /send → store.get() → append → store.set() with updatedAt |
| User conversation listing | PASS | listByUser() → sorted-set (Redis) / userId index (InMemory) |
| Health check + Redis status | PASS | /health → getRedisClient() → ioredis status |

**Cross-phase wiring:** All phase exports are properly imported and consumed. No orphaned exports. shared/ schema flows correctly through store abstraction to route handlers.

## Build & Test

- `npm run build`: All 3 workspaces compile cleanly
- `npm test`: 75 tests pass (6 test files)
- No regressions from prior milestones

---
*Milestone: v1.4 Persistent State Store (Azure Cache for Redis)*
*Audited: 2026-02-22*
