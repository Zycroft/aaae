---
phase: 11-storedconversation-schema-store-abstraction
plan: 02
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - server/src/store/ConversationStore.ts
  - server/src/store/InMemoryStore.ts
  - server/src/store/RedisStore.ts
  - server/src/store/factory.ts
  - server/src/store/index.ts
autonomous: true
requirements:
  - STORE-01
  - STORE-02
  - STORE-03
  - STORE-04
  - QUERY-01

must_haves:
  truths:
    - "ConversationStore interface uses StoredConversation from shared/ and exposes listByUser(userId)"
    - "InMemoryConversationStore implements listByUser() with a secondary userId index and returns conversations sorted most-recent-first"
    - "RedisStore file exists and satisfies the ConversationStore interface (stub — full Redis wiring is Phase 12)"
    - "Factory function selects RedisConversationStore when REDIS_URL is set, InMemoryConversationStore otherwise, and logs the active backend"
    - "store/index.ts exports the singleton store selected by the factory"
  artifacts:
    - path: "server/src/store/ConversationStore.ts"
      provides: "ConversationStore interface with get, set, delete, listByUser"
      exports:
        - ConversationStore
    - path: "server/src/store/InMemoryStore.ts"
      provides: "InMemoryConversationStore with userId secondary index"
      contains: "userIndex"
    - path: "server/src/store/RedisStore.ts"
      provides: "RedisConversationStore implementing ConversationStore (Phase 11 stub)"
      exports:
        - RedisConversationStore
    - path: "server/src/store/factory.ts"
      provides: "createConversationStore() factory with startup logging"
      exports:
        - createConversationStore
    - path: "server/src/store/index.ts"
      provides: "conversationStore singleton created by factory"
      contains: "createConversationStore"
  key_links:
    - from: "server/src/store/ConversationStore.ts"
      to: "shared/src/schemas/storedConversation.ts"
      via: "import type { StoredConversation } from '@copilot-chat/shared'"
      pattern: "StoredConversation.*@copilot-chat/shared"
    - from: "server/src/store/factory.ts"
      to: "server/src/store/RedisStore.ts"
      via: "conditional instantiation on REDIS_URL"
      pattern: "process.env.REDIS_URL"
    - from: "server/src/store/index.ts"
      to: "server/src/store/factory.ts"
      via: "createConversationStore() call at module load"
      pattern: "createConversationStore"
---

<objective>
Extend the server store abstraction: update the ConversationStore interface to use shared/ types and add listByUser(), upgrade InMemoryStore with a secondary userId index, create a RedisStore stub, create the factory, and wire the singleton.

Purpose: Phase 13 (route integration) and Phase 12 (full Redis implementation) both depend on this abstraction being in place. The factory pattern ensures route code has zero if-else for store selection — the environment drives it.

Output:
- server/src/store/ConversationStore.ts (updated — imports StoredConversation from shared/, adds listByUser)
- server/src/store/InMemoryStore.ts (updated — secondary userId index, listByUser implementation)
- server/src/store/RedisStore.ts (new — stub class satisfying ConversationStore; full impl deferred to Phase 12)
- server/src/store/factory.ts (new — factory function with startup logging)
- server/src/store/index.ts (updated — uses factory; removes hard-coded InMemoryConversationStore)
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/store/ConversationStore.ts
@server/src/store/InMemoryStore.ts
@server/src/store/index.ts
@.planning/phases/11-storedconversation-schema-store-abstraction/11-RESEARCH.md
@.planning/phases/11-storedconversation-schema-store-abstraction/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ConversationStore interface + InMemoryStore with listByUser</name>
  <files>
    server/src/store/ConversationStore.ts
    server/src/store/InMemoryStore.ts
  </files>
  <action>
**server/src/store/ConversationStore.ts** — replace entirely:

```typescript
import type { StoredConversation } from '@copilot-chat/shared';

export type { StoredConversation };

/**
 * ConversationStore — persistence abstraction for conversations.
 *
 * Implementations: InMemoryConversationStore (default), RedisConversationStore (REDIS_URL set).
 * Factory in factory.ts selects the implementation at startup.
 *
 * STORE-03, QUERY-01
 */
export interface ConversationStore {
  /** Retrieve conversation by externalId */
  get(id: string): Promise<StoredConversation | undefined>;

  /** Store or update conversation */
  set(id: string, conversation: StoredConversation): Promise<void>;

  /** Delete conversation by externalId */
  delete(id: string): Promise<void>;

  /**
   * List all conversations owned by a user, sorted most-recent-first by updatedAt.
   * Returns an empty array when the user has no conversations.
   * QUERY-01
   */
  listByUser(userId: string): Promise<StoredConversation[]>;
}
```

Note: `StoredConversation` is now imported from `@copilot-chat/shared` (via Plan 01). The interface no longer defines its own StoredConversation — that's shared/'s job. The `export type { StoredConversation }` re-export preserves backward compatibility for any server code that currently imports StoredConversation from './ConversationStore.js'.

---

**server/src/store/InMemoryStore.ts** — replace entirely:

```typescript
import { LRUCache } from 'lru-cache';
import type { ConversationStore, StoredConversation } from './ConversationStore.js';

/** Maximum number of active conversations in memory. LRU evicts oldest when exceeded. */
const MAX_CONVERSATIONS = 100;

/**
 * InMemoryConversationStore — LRU-backed in-process store.
 *
 * Selected by factory when REDIS_URL is not set (local dev, CI).
 * Secondary index (userIndex) enables efficient listByUser() without full-scan.
 *
 * STORE-02, QUERY-01
 */
export class InMemoryConversationStore implements ConversationStore {
  private cache = new LRUCache<string, StoredConversation>({ max: MAX_CONVERSATIONS });

  /** Secondary index: userId → Set<externalId> for listByUser() */
  private userIndex = new Map<string, Set<string>>();

  async get(id: string): Promise<StoredConversation | undefined> {
    return this.cache.get(id);
  }

  async set(id: string, conversation: StoredConversation): Promise<void> {
    const existing = this.cache.get(id);

    // If userId changed (edge case), remove from old user's index
    if (existing && existing.userId !== conversation.userId) {
      this.userIndex.get(existing.userId)?.delete(id);
    }

    // Add to new user's index
    if (!this.userIndex.has(conversation.userId)) {
      this.userIndex.set(conversation.userId, new Set());
    }
    this.userIndex.get(conversation.userId)!.add(id);

    this.cache.set(id, conversation);
  }

  async delete(id: string): Promise<void> {
    const existing = this.cache.get(id);
    if (existing) {
      this.userIndex.get(existing.userId)?.delete(id);
    }
    this.cache.delete(id);
  }

  /**
   * List conversations for a user sorted most-recent-first by updatedAt.
   * Returns empty array when user has no conversations.
   * QUERY-01
   */
  async listByUser(userId: string): Promise<StoredConversation[]> {
    const ids = this.userIndex.get(userId) ?? new Set<string>();
    return Array.from(ids)
      .map(id => this.cache.get(id))
      .filter((c): c is StoredConversation => c !== undefined)
      .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());
  }
}
```

Do NOT add a `private sdkRefs = new Map<string, unknown>()` — the sdkConversationRef is already stored inside the StoredConversation object in memory. The in-memory store serializes nothing; the SDK ref is preserved in the LRU cache object directly.
  </action>
  <verify>
Run: `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1 | grep -E "error|Error" | head -20`
Expected: no TypeScript errors referencing ConversationStore.ts or InMemoryStore.ts.
Also confirm: `grep "listByUser" /Users/zycroft/Documents/PA/aaae/server/src/store/InMemoryStore.ts` shows the implementation exists.
  </verify>
  <done>
ConversationStore.ts imports StoredConversation from @copilot-chat/shared and declares listByUser. InMemoryStore.ts implements listByUser with userIndex secondary index. Both compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RedisStore stub + factory + update store index</name>
  <files>
    server/src/store/RedisStore.ts
    server/src/store/factory.ts
    server/src/store/index.ts
  </files>
  <action>
**server/src/store/RedisStore.ts** — create new file:

This is a Phase 11 stub. The constructor accepts redisUrl but does NOT import ioredis (ioredis is installed in Phase 12). The stub throws a "not implemented" error on all operations so any accidental use in Phase 11 fails loudly rather than silently.

```typescript
import type { ConversationStore, StoredConversation } from './ConversationStore.js';

/**
 * RedisConversationStore — Redis-backed persistent store.
 *
 * Phase 11 STUB: Interface-satisfying placeholder. Full implementation (ioredis,
 * TLS, TTL, sorted-set index) is deferred to Phase 12.
 *
 * STORE-01, QUERY-01
 */
export class RedisConversationStore implements ConversationStore {
  private readonly redisUrl: string;

  constructor(redisUrl: string) {
    this.redisUrl = redisUrl;
  }

  async get(_id: string): Promise<StoredConversation | undefined> {
    throw new Error(`RedisConversationStore.get() not yet implemented (Phase 12). URL: ${this.redisUrl}`);
  }

  async set(_id: string, _conversation: StoredConversation): Promise<void> {
    throw new Error(`RedisConversationStore.set() not yet implemented (Phase 12). URL: ${this.redisUrl}`);
  }

  async delete(_id: string): Promise<void> {
    throw new Error(`RedisConversationStore.delete() not yet implemented (Phase 12). URL: ${this.redisUrl}`);
  }

  async listByUser(_userId: string): Promise<StoredConversation[]> {
    throw new Error(`RedisConversationStore.listByUser() not yet implemented (Phase 12). URL: ${this.redisUrl}`);
  }
}
```

---

**server/src/store/factory.ts** — create new file:

The factory reads REDIS_URL at call time, not at import time, so the selection logic works correctly in tests that set process.env before calling the factory.

```typescript
import { InMemoryConversationStore } from './InMemoryStore.js';
import { RedisConversationStore } from './RedisStore.js';
import type { ConversationStore } from './ConversationStore.js';

/**
 * createConversationStore — selects the active store backend from environment.
 *
 * Selection:
 *   REDIS_URL set   → RedisConversationStore (Azure Cache for Redis, Phase 12 full impl)
 *   REDIS_URL absent → InMemoryConversationStore (LRU, local dev / CI)
 *
 * Never both. Never silent fallback on Redis failure (returns 503 — see Phase 12).
 * Called once at module load time; result exported as singleton from store/index.ts.
 *
 * STORE-03, STORE-04
 */
export function createConversationStore(): ConversationStore {
  const redisUrl = process.env.REDIS_URL;

  if (redisUrl) {
    console.log(
      `[STORE] Redis detected. Initializing RedisConversationStore. URL: ${redisUrl}`
    );
    return new RedisConversationStore(redisUrl);
  }

  console.log('[STORE] REDIS_URL not set. Using InMemoryConversationStore (local LRU).');
  return new InMemoryConversationStore();
}
```

---

**server/src/store/index.ts** — replace entirely:

```typescript
import { createConversationStore } from './factory.js';
import { InMemoryWorkflowStateStore } from './InMemoryWorkflowStateStore.js';

export type { ConversationStore, StoredConversation } from './ConversationStore.js';
export { InMemoryConversationStore } from './InMemoryStore.js';
export { RedisConversationStore } from './RedisStore.js';
export { createConversationStore } from './factory.js';

export type { WorkflowStateStore } from './WorkflowStateStore.js';
export { InMemoryWorkflowStateStore } from './InMemoryWorkflowStateStore.js';

/**
 * Singleton conversation store — backend selected by factory at module load.
 * Phase 11: InMemoryConversationStore (REDIS_URL absent) or RedisConversationStore stub (REDIS_URL set).
 * Phase 12: RedisConversationStore gains full ioredis implementation.
 *
 * STORE-03
 */
export const conversationStore = createConversationStore();

/** Singleton workflow state store — in-memory only (no Redis backing needed for v1.4) */
export const workflowStateStore = new InMemoryWorkflowStateStore();
```

Note: The server codebase uses `console.log()` / `console.warn()` / `console.error()` directly — there is no logger module. factory.ts follows the same pattern.
  </action>
  <verify>
1. Run: `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1 | grep -E "TS[0-9]+|error TS" | head -20` — zero TypeScript errors
2. Run: `cd /Users/zycroft/Documents/PA/aaae/server && npm test 2>&1 | tail -20` — existing tests pass (no regressions)
3. Run: `node -e "process.env.REDIS_URL=''; require('./server/dist/store/index.js')" 2>&1` — should NOT crash (REDIS_URL empty string is falsy enough, or confirm the branch)
4. Confirm factory file: `grep "REDIS_URL" /Users/zycroft/Documents/PA/aaae/server/src/store/factory.ts` — shows the env check
5. Confirm index uses factory: `grep "createConversationStore" /Users/zycroft/Documents/PA/aaae/server/src/store/index.ts` — shows call
6. Confirm [STORE] log output (STORE-04): After rebuilding, run `node -e "const s = require('./server/dist/store/index.js')" 2>&1` from /Users/zycroft/Documents/PA/aaae — should print a line containing "[STORE] REDIS_URL not set. Using InMemoryConversationStore". If REDIS_URL is set in the shell, the line should contain "[STORE] Redis detected." instead.
  </verify>
  <done>
RedisStore.ts satisfies ConversationStore interface (stub throws on all methods). factory.ts creates the correct store based on REDIS_URL and logs the active backend. index.ts exports the factory-created singleton. All compile without errors. Existing server tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/zycroft/Documents/PA/aaae && npm run build` — zero TypeScript errors across all workspaces
2. `cd /Users/zycroft/Documents/PA/aaae/server && npm test` — all existing tests pass
3. Factory log output: confirm `[STORE]` prefix log message is emitted at server startup (visible in `npm run dev` output)
4. `grep -r "StoredConversation" /Users/zycroft/Documents/PA/aaae/server/src/store/ --include="*.ts"` — shows imports from '@copilot-chat/shared' in ConversationStore.ts
5. `grep "listByUser" /Users/zycroft/Documents/PA/aaae/server/src/store/ConversationStore.ts` — shows method in interface
6. `grep "listByUser" /Users/zycroft/Documents/PA/aaae/server/src/store/InMemoryStore.ts` — shows implementation
7. `grep "listByUser" /Users/zycroft/Documents/PA/aaae/server/src/store/RedisStore.ts` — shows stub implementation
</verification>

<success_criteria>
- ConversationStore interface imports StoredConversation from @copilot-chat/shared (not defining its own) — STATE-05 consumption confirmed
- ConversationStore interface has listByUser(userId: string): Promise<StoredConversation[]> — QUERY-01
- InMemoryConversationStore implements listByUser with secondary userIndex Map — QUERY-01
- RedisConversationStore class exists, implements ConversationStore, throws on all methods (stub) — STORE-01 (foundation laid)
- Factory selects InMemoryConversationStore when REDIS_URL absent — STORE-02
- Factory selects RedisConversationStore when REDIS_URL present — STORE-01/STORE-03
- Factory logs "[STORE] Redis detected..." or "[STORE] REDIS_URL not set..." — STORE-04
- store/index.ts exports singleton from factory — STORE-03
- npm run build passes, server tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-storedconversation-schema-store-abstraction/11-02-SUMMARY.md` documenting:
- Files created/modified and key decisions
- Logger import path actually used (may differ from '../logger.js')
- Confirmation that existing tests passed
- RedisStore stub approach and why (deferred to Phase 12)
- Any deviations from the plan
</output>
