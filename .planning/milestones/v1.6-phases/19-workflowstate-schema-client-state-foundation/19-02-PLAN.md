---
phase: 19-workflowstate-schema-client-state-foundation
plan: 02
type: execute
wave: 2
depends_on: [19-01]
files_modified:
  - client/src/api/chatApi.ts
  - client/src/hooks/useChatApi.ts
autonomous: true
requirements: [STATE-01, STATE-02, STATE-03, COMPAT-01, COMPAT-02]

must_haves:
  truths:
    - "useChatApi hook return value includes workflowState (WorkflowState | null) that updates on every send/cardAction response"
    - "useChatApi hook exposes resetConversation() that clears messages, workflowState, and conversationId"
    - "A chat session where the server returns no workflowState renders identically to before — workflowState is null, no component crashes"
    - "No hardcoded phase names, step labels, or step counts appear anywhere in the updated files"
    - "chatApi.ts return types include optional workflowState so useChatApi can extract it"
  artifacts:
    - path: "client/src/api/chatApi.ts"
      provides: "Updated return types including optional workflowState field"
      exports: ["startConversation", "sendMessage", "sendCardAction"]
    - path: "client/src/hooks/useChatApi.ts"
      provides: "useChatApi hook with workflowState and resetConversation exposed"
      exports: ["useChatApi", "TranscriptMessage", "MessageStatus"]
  key_links:
    - from: "client/src/hooks/useChatApi.ts"
      to: "client/src/api/chatApi.ts"
      via: "sendMessage/sendCardAction return type includes workflowState — reducer reads it"
      pattern: "data\\.workflowState"
    - from: "client/src/hooks/useChatApi.ts"
      to: "@copilot-chat/shared"
      via: "WorkflowState type import for State shape and reducer actions"
      pattern: "WorkflowState"
---

<objective>
Update chatApi.ts return types to pass workflowState through from API responses, then extend useChatApi to store workflowState in reducer state, dispatch updates on every response, and expose workflowState + resetConversation() to consumers.

Purpose: Phase 20+ UI components need a reactive workflowState source of truth from the hook. This plan wires the data from API response all the way to the hook's return value.
Output: Updated chatApi.ts + useChatApi.ts — consumers get workflowState and resetConversation(); no regressions when server omits workflowState.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@client/src/api/chatApi.ts
@client/src/hooks/useChatApi.ts
@.planning/phases/19-workflowstate-schema-client-state-foundation/19-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update chatApi.ts return types to include optional workflowState</name>
  <files>client/src/api/chatApi.ts</files>
  <action>
    Import `WorkflowState` from `@copilot-chat/shared` at the top of the file.

    Update the return type of `startConversation` from:
      `Promise<{ conversationId: string }>`
    to:
      `Promise<{ conversationId: string; workflowState?: WorkflowState }>`

    Update the return type of `sendMessage` from:
      `Promise<{ conversationId: string; messages: NormalizedMessage[] }>`
    to:
      `Promise<{ conversationId: string; messages: NormalizedMessage[]; workflowState?: WorkflowState }>`

    Update the return type of `sendCardAction` from:
      `Promise<{ conversationId: string; messages: NormalizedMessage[] }>`
    to:
      `Promise<{ conversationId: string; messages: NormalizedMessage[]; workflowState?: WorkflowState }>`

    The `response.json() as Promise<...>` casts must be updated to match the new return types. No fetch logic changes — only type annotations.

    IMPORTANT: Do NOT hardcode any workflow phase names, step names, or counts. The return type is a passthrough — whatever the server returns comes through.
  </action>
  <verify>cd /Users/zycroft/Documents/PA/aaae && npx tsc --noEmit -p client/tsconfig.json 2>&1 | head -30</verify>
  <done>TypeScript reports 0 errors for client/src/api/chatApi.ts. workflowState field is typed as WorkflowState | undefined in all three return types.</done>
</task>

<task type="auto">
  <name>Task 2: Extend useChatApi reducer to track workflowState and add resetConversation</name>
  <files>client/src/hooks/useChatApi.ts</files>
  <action>
    Make the following changes to useChatApi.ts. Read the current file first (all 341 lines) before editing.

    **1. Add WorkflowState import:**
    Add `WorkflowState` to the existing shared import:
    ```typescript
    import type { NormalizedMessage, WorkflowState } from '@copilot-chat/shared';
    ```

    **2. Extend State type:**
    Add `workflowState: WorkflowState | null;` to the State type definition after `error: string | null`.

    **3. Extend Action union:**
    Add two new action types:
    - `{ type: 'SET_WORKFLOW_STATE'; workflowState: WorkflowState }` — dispatched on every send/cardAction response that includes workflowState
    - `{ type: 'RESET_CONVERSATION' }` — clears all state back to initial

    **4. Update initialState:**
    Add `workflowState: null` to the initialState object.

    **5. Update reducer:**
    Add two new cases in the switch statement:

    `case 'SET_WORKFLOW_STATE':`
    ```typescript
    return { ...state, workflowState: action.workflowState };
    ```

    `case 'RESET_CONVERSATION':`
    ```typescript
    return { ...initialState };
    ```

    **6. Dispatch SET_WORKFLOW_STATE after SEND_SUCCESS:**
    In the `send()` function, after dispatching `SEND_SUCCESS`, check if `data.workflowState` exists and dispatch:
    ```typescript
    if (data.workflowState) {
      dispatch({ type: 'SET_WORKFLOW_STATE', workflowState: data.workflowState });
    }
    ```
    IMPORTANT: Dispatch SEND_SUCCESS first (messages update), then SET_WORKFLOW_STATE — so consumers see message update atomically before workflow state update.

    **7. Dispatch SET_WORKFLOW_STATE after CARD_ACTION_SUCCESS:**
    Same pattern as step 6 — after dispatching `CARD_ACTION_SUCCESS` in the `cardAction()` function.

    **8. Dispatch SET_WORKFLOW_STATE after INIT_CONVERSATION (optional):**
    In the mount effect, after dispatching `INIT_CONVERSATION`, if `data.workflowState` exists, dispatch SET_WORKFLOW_STATE.

    **9. Add resetConversation function:**
    ```typescript
    function resetConversation(): void {
      dispatch({ type: 'RESET_CONVERSATION' });
    }
    ```

    **10. Expose in return value:**
    Add `workflowState: state.workflowState` and `resetConversation` to the returned object from the hook.

    **COMPAT-01 guarantee:** workflowState stays null when server omits it — the `if (data.workflowState)` guard ensures no dispatch when absent. Consumers that ignore workflowState see no behavior change.

    **COMPAT-02 guarantee:** No hardcoded phase names, step labels, or step counts anywhere in this file. The hook is a transparent conduit — it passes through whatever the server returns.
  </action>
  <verify>cd /Users/zycroft/Documents/PA/aaae && npx tsc --noEmit -p client/tsconfig.json 2>&1 | head -30</verify>
  <done>TypeScript reports 0 errors. useChatApi returns { conversationId, messages, isLoading, error, workflowState, sendMessage, cardAction, resetConversation }. workflowState is WorkflowState | null. resetConversation is () => void.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd /Users/zycroft/Documents/PA/aaae && npx tsc --noEmit -p client/tsconfig.json` — exits 0, no errors
2. Check useChatApi return type includes: `workflowState: WorkflowState | null` and `resetConversation: () => void`
3. Confirm no hardcoded phase/step strings in chatApi.ts or useChatApi.ts: `grep -n 'gather_info\|initial\|confirm\|complete\|research' client/src/api/chatApi.ts client/src/hooks/useChatApi.ts` — should return no matches
4. Confirm COMPAT-01 path: when data.workflowState is undefined, SET_WORKFLOW_STATE is NOT dispatched, state.workflowState remains null
5. Run `npm test` from root to confirm no test regressions
</verification>

<success_criteria>
- useChatApi hook exposes workflowState (WorkflowState | null) that is null initially and updated after each send/cardAction that returns workflowState
- useChatApi hook exposes resetConversation() that returns state to initial (null workflowState, empty messages, null conversationId)
- ChatApi return types include optional workflowState field on all three functions
- Zero TypeScript errors in client workspace
- No hardcoded phase/step/count literals in either file (COMPAT-02)
- Chat with no workflowState in response: workflowState stays null, no errors (COMPAT-01)
</success_criteria>

<output>
After completion, create `.planning/phases/19-workflowstate-schema-client-state-foundation/19-02-SUMMARY.md`
</output>
