---
phase: 21-dynamic-input-completion-metadatapane
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - client/src/components/ChatInput.tsx
  - client/src/components/ChatInput.test.tsx
  - client/src/components/chat.css
autonomous: true
requirements: [INPUT-01, INPUT-02, INPUT-03, INPUT-04, INPUT-05, TEST-02]

must_haves:
  truths:
    - "ChatInput renders clickable pill buttons when suggestedInputType is 'choice', each pill sends the choice text via onSend"
    - "ChatInput renders Yes and No buttons when suggestedInputType is 'confirmation', each sends its text via onSend"
    - "ChatInput disables textarea and send button when suggestedInputType is 'none', showing 'Waiting for workflow...' status message"
    - "Free-text textarea remains fully functional as fallback in choice and confirmation modes"
    - "Choice pills show first 6 items with 'Show more' toggle when choices exceed 6; all pills and buttons are keyboard accessible (Tab, Enter, Space)"
    - "All ChatInput dynamic modes pass unit tests covering choice, confirmation, none, overflow, and keyboard interaction"
  artifacts:
    - path: "client/src/components/ChatInput.tsx"
      provides: "ChatInput with dynamic input modes driven by suggestedInputType and choices props"
      exports: ["ChatInput"]
    - path: "client/src/components/ChatInput.test.tsx"
      provides: "Unit tests for all ChatInput dynamic input modes"
      contains: "renders choice pills when suggestedInputType is choice"
    - path: "client/src/components/chat.css"
      provides: "CSS for .choicePillRow, .choicePill, .showMoreToggle, .inputDisabledStatus"
      contains: ".choicePill"
  key_links:
    - from: "client/src/components/ChatInput.tsx"
      to: "client/src/components/ChatShell.tsx"
      via: "ChatShell passes suggestedInputType and choices from workflowState to ChatInput"
      pattern: "suggestedInputType"
    - from: "client/src/components/ChatInput.tsx"
      to: "client/src/components/chat.css"
      via: "CSS class names: choicePillRow, choicePill, showMoreToggle, inputDisabledStatus"
      pattern: "className.*choicePill"
---

<objective>
Build dynamic input modes for ChatInput using TDD — tests first, then implementation. ChatInput adapts its UI based on the workflow's suggestedInputType: 'choice' shows clickable pill buttons, 'confirmation' shows Yes/No buttons, 'none' disables input, and 'text'/undefined keeps the default textarea behavior.

Purpose: Users interact with the workflow via the appropriate input mode — clicking pills for choices, confirming Yes/No, or typing free text — all driven by server-returned workflowState.
Output: Extended ChatInput.tsx with new props, ChatInput.test.tsx, CSS classes in chat.css.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-dynamic-input-completion-metadatapane/21-CONTEXT.md

@client/src/components/ChatInput.tsx
@client/src/components/chat.css
@client/src/hooks/useChatApi.ts
@shared/src/schemas/workflowState.ts
@client/jest.config.cjs
@client/src/components/WorkflowProgress.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — write failing tests for ChatInput dynamic modes</name>
  <files>client/src/components/ChatInput.test.tsx</files>
  <action>
    Create `client/src/components/ChatInput.test.tsx` with Jest tests using `renderToStaticMarkup` from `react-dom/server` (same pattern as WorkflowProgress.test.tsx — no @testing-library/react available).

    Add `/* global describe, test, expect */` at top for ESLint v9 flat config compatibility.

    The ChatInput component currently accepts `{ onSend, disabled }`. This plan extends it with optional props:
    - `suggestedInputType?: 'text' | 'choice' | 'confirmation' | 'none'`
    - `choices?: string[]`

    Test cases (ALL must reference the existing component which does not yet have these props — tests will fail or produce wrong output):

    1. `renders default text input when no suggestedInputType` — renders textarea and send button, no pills. Verify the HTML contains "chatTextarea" and "sendButton" class names, no "choicePill" class.

    2. `renders choice pills when suggestedInputType is choice` — with suggestedInputType='choice' and choices=['Option A', 'Option B', 'Option C'], renders pill buttons with those labels. Verify HTML contains "choicePill" class and text content of each choice.

    3. `renders only first 6 pills and Show more toggle when choices exceed 6` — with 8 choices, verify HTML contains exactly 6 choicePill elements and a "showMoreToggle" button with "Show more" text. (Use string matching on the static HTML — count occurrences of "choicePill" class).

    4. `renders Yes and No buttons for confirmation mode` — with suggestedInputType='confirmation', verify HTML contains two pills: "Yes" and "No", with "Yes" having the primary styling class.

    5. `renders disabled state with status message when suggestedInputType is none` — with suggestedInputType='none', verify textarea has disabled attribute AND HTML contains "inputDisabledStatus" class with "Waiting for workflow..." text.

    6. `keeps textarea visible and enabled in choice mode (free-text fallback)` — with suggestedInputType='choice', verify textarea is present AND NOT disabled. Verify placeholder text contains "Select an option".

    7. `keeps textarea visible and enabled in confirmation mode (free-text fallback)` — with suggestedInputType='confirmation', verify textarea is present AND NOT disabled. Verify placeholder text contains "Confirm".

    For each test, create a mock `onSend` function: `const onSend = () => {}`. Render with `renderToStaticMarkup(<ChatInput onSend={onSend} disabled={false} suggestedInputType={...} choices={...} />)` and assert on the output HTML string.

    IMPORTANT: Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=ChatInput 2>&1`. Expect failures because the current ChatInput does not accept suggestedInputType or choices props, so the pills/confirmation/disabled behavior won't exist in the output.

    Commit: `test(21-01): add failing tests for ChatInput dynamic input modes`.
  </action>
  <verify>Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=ChatInput 2>&1`. Tests should fail — current ChatInput lacks suggestedInputType/choices props and the dynamic rendering logic.</verify>
  <done>ChatInput.test.tsx exists with 7 test cases, most/all failing. Committed with message `test(21-01): add failing tests for ChatInput dynamic input modes`.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — implement ChatInput dynamic modes and CSS</name>
  <files>client/src/components/ChatInput.tsx, client/src/components/chat.css</files>
  <action>
    Extend `client/src/components/ChatInput.tsx`:

    **1. Update the interface:**
    ```tsx
    interface ChatInputProps {
      onSend: (text: string) => void;
      disabled: boolean;
      suggestedInputType?: 'text' | 'choice' | 'confirmation' | 'none';
      choices?: string[];
    }
    ```

    **2. Add state for "Show more" toggle:**
    ```tsx
    const [showAllChoices, setShowAllChoices] = useState(false);
    ```

    **3. Compute input mode state:**
    ```tsx
    const isChoiceMode = suggestedInputType === 'choice' && choices && choices.length > 0;
    const isConfirmationMode = suggestedInputType === 'confirmation';
    const isDisabledMode = suggestedInputType === 'none';
    ```

    **4. Handle pill click:**
    ```tsx
    function handlePillClick(value: string) {
      onSend(value);
    }
    ```

    **5. Adjust disabled state:** When suggestedInputType is 'none', the textarea and send button are disabled. In choice and confirmation modes, textarea stays enabled (free-text fallback per INPUT-04).

    **6. Update placeholder text contextually:**
    - Default: "Type a message..."
    - Choice mode: "Select an option or type a message..."
    - Confirmation mode: "Confirm or type a message..."
    - None mode: "Type a message..." (disabled anyway)

    **7. Render pill/button area ABOVE the textarea row, inside .chatInputArea:**

    For choice mode:
    ```tsx
    {isChoiceMode && (
      <div className="choicePillRow" role="group" aria-label="Available choices">
        {(showAllChoices ? choices : choices.slice(0, 6)).map((choice) => (
          <button
            key={choice}
            type="button"
            className="choicePill"
            onClick={() => handlePillClick(choice)}
          >
            {choice}
          </button>
        ))}
        {choices.length > 6 && !showAllChoices && (
          <button
            type="button"
            className="showMoreToggle"
            onClick={() => setShowAllChoices(true)}
          >
            Show more
          </button>
        )}
      </div>
    )}
    ```

    For confirmation mode:
    ```tsx
    {isConfirmationMode && (
      <div className="choicePillRow" role="group" aria-label="Confirmation">
        <button
          type="button"
          className="choicePill choicePillPrimary"
          onClick={() => handlePillClick('Yes')}
        >
          Yes
        </button>
        <button
          type="button"
          className="choicePill"
          onClick={() => handlePillClick('No')}
        >
          No
        </button>
      </div>
    )}
    ```

    For none/disabled mode, render status message above textarea:
    ```tsx
    {isDisabledMode && (
      <div className="inputDisabledStatus">Waiting for workflow...</div>
    )}
    ```

    **8. Full return structure:**
    ```tsx
    return (
      <div className="chatInputArea">
        {isChoiceMode && ( /* pill row */ )}
        {isConfirmationMode && ( /* confirmation row */ )}
        {isDisabledMode && ( /* status message */ )}
        <div className="inputRow">
          <textarea
            ref={textareaRef}
            className="chatTextarea"
            value={text}
            onChange={handleInput}
            onKeyDown={handleKeyDown}
            disabled={disabled || isDisabledMode}
            placeholder={
              isChoiceMode ? 'Select an option or type a message...'
                : isConfirmationMode ? 'Confirm or type a message...'
                : 'Type a message\u2026'
            }
            rows={1}
            maxLength={MAX_CHARS + 1}
            aria-label="Message input"
            aria-multiline="true"
          />
          <button
            className="sendButton"
            type="button"
            onClick={submit}
            disabled={disabled || isDisabledMode || !text.trim()}
            aria-label="Send message"
          >
            Send
          </button>
        </div>
        {showCounter && ( /* char counter */ )}
      </div>
    );
    ```

    **CSS additions in `client/src/components/chat.css`:**

    Add after the existing Chat Input section, before the charCounter styles:

    ```css
    /* ─────────────────────────────────────────────────────────────────────────
       Choice Pills + Confirmation Buttons (INPUT-01, INPUT-02, INPUT-04, INPUT-05)
       Inline-flex row above textarea. Wraps naturally. Keyboard accessible.
       ───────────────────────────────────────────────────────────────────────── */

    .choicePillRow {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .choicePill {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-3);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      font-size: var(--font-size-sm);
      color: var(--color-text);
      cursor: pointer;
      transition: border-color var(--transition-base);
      white-space: nowrap;
    }

    .choicePill:hover {
      border-color: var(--color-primary);
    }

    .choicePill:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px var(--color-focus-ring);
    }

    /* Primary pill (e.g., "Yes" in confirmation mode) */
    .choicePillPrimary {
      background: var(--color-primary);
      color: var(--color-text-inverse);
      border-color: var(--color-primary);
    }

    .choicePillPrimary:hover {
      background: var(--color-primary-hover);
      border-color: var(--color-primary-hover);
    }

    .showMoreToggle {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-3);
      background: none;
      border: 1px dashed var(--color-border);
      border-radius: 16px;
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      cursor: pointer;
      transition: color var(--transition-base), border-color var(--transition-base);
    }

    .showMoreToggle:hover {
      color: var(--color-primary);
      border-color: var(--color-primary);
    }

    .showMoreToggle:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px var(--color-focus-ring);
    }

    /* ─────────────────────────────────────────────────────────────────────────
       Disabled Input Status (INPUT-03)
       Status message when suggestedInputType is 'none'
       ───────────────────────────────────────────────────────────────────────── */

    .inputDisabledStatus {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      font-style: italic;
      padding: var(--space-1) 0;
      margin-bottom: var(--space-2);
    }
    ```

    After implementing, run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=ChatInput`. All 7 tests must pass. Then run `cd /Users/zycroft/Documents/PA/aaae && npm run build` to confirm no TypeScript errors.

    Commit: `feat(21-01): implement ChatInput dynamic modes — choice pills, confirmation, disabled`.
  </action>
  <verify>Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=ChatInput 2>&1`. All 7 tests pass. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1` to confirm no TypeScript errors.</verify>
  <done>All 7 ChatInput tests pass. TypeScript build clean. Committed `feat(21-01): implement ChatInput dynamic modes — choice pills, confirmation, disabled`.</done>
</task>

</tasks>

<verification>
1. Run `cd /Users/zycroft/Documents/PA/aaae/client && npm test -- --testPathPattern=ChatInput` — all 7 tests pass
2. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build` — no TypeScript errors
3. ChatInput.tsx accepts suggestedInputType and choices props — grep for `suggestedInputType` in component
4. Choice pills render as button elements with .choicePill class — grep for `choicePill` in ChatInput.tsx
5. Show more toggle appears only when choices > 6 — grep for `showMoreToggle` in ChatInput.tsx
6. Confirmation mode renders Yes (primary) and No pills — grep for `choicePillPrimary` in ChatInput.tsx
7. Disabled mode shows .inputDisabledStatus with "Waiting for workflow..." — grep for `inputDisabledStatus` in ChatInput.tsx
8. Textarea placeholder changes contextually — grep for `Select an option` in ChatInput.tsx
9. CSS contains `.choicePill`, `.choicePillPrimary`, `.showMoreToggle`, `.inputDisabledStatus` in chat.css
</verification>

<success_criteria>
- ChatInput.tsx and ChatInput.test.tsx exist in client/src/components/
- 7 unit tests pass covering: default text mode, choice pills, overflow (>6) with show more, confirmation Yes/No, disabled/none state, free-text fallback in choice mode, free-text fallback in confirmation mode
- CSS classes: choicePillRow, choicePill, choicePillPrimary, showMoreToggle, inputDisabledStatus
- Choice pills use var(--color-surface) background with var(--color-border) outline, hover changes to var(--color-primary) border
- "Yes" pill uses var(--color-primary) background (choicePillPrimary class)
- Free-text textarea always visible and enabled in choice and confirmation modes
- Textarea disabled with opacity reduction when suggestedInputType is 'none'
- TypeScript build clean
</success_criteria>

<output>
After completion, create `.planning/phases/21-dynamic-input-completion-metadatapane/21-01-SUMMARY.md`
</output>
