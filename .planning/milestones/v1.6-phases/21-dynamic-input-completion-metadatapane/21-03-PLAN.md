---
phase: 21-dynamic-input-completion-metadatapane
plan: 03
type: execute
wave: 2
depends_on: [21-01, 21-02]
files_modified:
  - client/src/components/MetadataPane.tsx
  - client/src/components/ChatShell.tsx
  - client/src/components/chat.css
autonomous: true
requirements: [META-01, META-02]

must_haves:
  truths:
    - "MetadataPane shows a 'Workflow Data' section above the Activity Log when workflowState has collectedData"
    - "Workflow data key-value pairs render as semantic HTML (dl/dt/dd) with keys in monospace and muted color"
    - "Nested objects up to 3 levels deep displayed inline with dot-notation keys (e.g., 'address.street')"
    - "Deeper nesting (>3 levels) shows a 'View full data' toggle that reveals a <pre> JSON block"
    - "ChatShell conditionally renders WorkflowComplete (replacing transcript + input) when workflowState.status is 'completed'"
    - "ChatShell passes suggestedInputType and choices from workflowState to ChatInput"
  artifacts:
    - path: "client/src/components/MetadataPane.tsx"
      provides: "MetadataPane with Workflow Data section above Activity Log"
      exports: ["MetadataPane"]
    - path: "client/src/components/ChatShell.tsx"
      provides: "ChatShell wiring WorkflowComplete and ChatInput dynamic props"
      exports: ["ChatShell"]
    - path: "client/src/components/chat.css"
      provides: "CSS for .workflowDataSection, .workflowDataList, .workflowDataKey, .workflowDataValue, .viewFullDataToggle"
      contains: ".workflowDataSection"
  key_links:
    - from: "client/src/components/MetadataPane.tsx"
      to: "shared/src/schemas/workflowState.ts"
      via: "import type { WorkflowState } from '@copilot-chat/shared'"
      pattern: "WorkflowState"
    - from: "client/src/components/ChatShell.tsx"
      to: "client/src/components/WorkflowComplete.tsx"
      via: "import { WorkflowComplete } from './WorkflowComplete.js'"
      pattern: "WorkflowComplete"
    - from: "client/src/components/ChatShell.tsx"
      to: "client/src/components/ChatInput.tsx"
      via: "passes suggestedInputType and choices props"
      pattern: "suggestedInputType"
---

<objective>
Wire the MetadataPane with a "Workflow Data" section and integrate WorkflowComplete and ChatInput dynamic props into ChatShell. This plan connects the components built in Wave 1 into the shell layout and adds the metadata workflow data display.

Purpose: Users see accumulated workflow data in the metadata sidebar, the chat shell shows the completion view when a workflow finishes, and the input area receives the correct input mode from the workflow state.
Output: Modified MetadataPane.tsx, ChatShell.tsx, and CSS additions in chat.css.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-dynamic-input-completion-metadatapane/21-CONTEXT.md

@client/src/components/MetadataPane.tsx
@client/src/components/ChatShell.tsx
@client/src/components/ChatInput.tsx
@client/src/components/WorkflowComplete.tsx
@client/src/hooks/useChatApi.ts
@client/src/components/chat.css
@shared/src/schemas/workflowState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Workflow Data section to MetadataPane</name>
  <files>client/src/components/MetadataPane.tsx, client/src/components/chat.css</files>
  <action>
    Extend `client/src/components/MetadataPane.tsx` to accept an optional `workflowState` prop and render a "Workflow Data" section above the existing Activity Log.

    **1. Update interface:**
    ```tsx
    import type { NormalizedMessage, WorkflowState } from '@copilot-chat/shared';

    interface MetadataPaneProps {
      messages: NormalizedMessage[];
      workflowState?: WorkflowState | null;
    }
    ```

    **2. Add a helper function to flatten nested objects into dot-notation keys:**
    ```tsx
    /**
     * Flattens a nested object into dot-notation key-value pairs.
     * Stops at depth 3 and marks deeper values for JSON display.
     */
    function flattenData(
      obj: Record<string, unknown>,
      prefix = '',
      depth = 0
    ): Array<{ key: string; value: string; needsJsonView: boolean }> {
      const result: Array<{ key: string; value: string; needsJsonView: boolean }> = [];

      for (const [k, v] of Object.entries(obj)) {
        const fullKey = prefix ? `${prefix}.${k}` : k;

        if (v !== null && typeof v === 'object' && !Array.isArray(v)) {
          if (depth < 2) {
            // Recurse into nested objects up to 3 levels (depth 0, 1, 2)
            result.push(...flattenData(v as Record<string, unknown>, fullKey, depth + 1));
          } else {
            // Deeper than 3 levels — show as JSON
            result.push({ key: fullKey, value: JSON.stringify(v, null, 2), needsJsonView: true });
          }
        } else {
          result.push({ key: fullKey, value: String(v ?? ''), needsJsonView: false });
        }
      }

      return result;
    }
    ```

    **3. Add state for "View full data" toggle:**
    ```tsx
    import { useState } from 'react';

    // Inside the component:
    const [showFullData, setShowFullData] = useState<Record<string, boolean>>({});
    ```

    **4. Render Workflow Data section ABOVE the Activity Log header:**

    Only render when `workflowState?.collectedData` exists and has entries.

    ```tsx
    const collectedData = workflowState?.collectedData;
    const hasWorkflowData = collectedData && Object.keys(collectedData).length > 0;

    // In the JSX return, BEFORE the metadataPaneHeader:
    {hasWorkflowData && (
      <div className="workflowDataSection">
        <h2 className="metadataPaneTitle">Workflow Data</h2>
        <dl className="workflowDataList">
          {flattenData(collectedData).map(({ key, value, needsJsonView }) => (
            <div key={key} className="workflowDataEntry">
              <dt className="workflowDataKey">{key}</dt>
              {needsJsonView ? (
                <dd className="workflowDataValue">
                  <button
                    type="button"
                    className="viewFullDataToggle"
                    onClick={() => setShowFullData((prev) => ({ ...prev, [key]: !prev[key] }))}
                  >
                    {showFullData[key] ? 'Hide' : 'View full data'}
                  </button>
                  {showFullData[key] && (
                    <pre className="workflowDataJson">{value}</pre>
                  )}
                </dd>
              ) : (
                <dd className="workflowDataValue">{value}</dd>
              )}
            </div>
          ))}
        </dl>
      </div>
    )}
    ```

    **5. Full component structure:**
    ```tsx
    return (
      <aside className="metadataPane" aria-label="Activity log">
        {hasWorkflowData && (
          <div className="workflowDataSection">
            {/* Workflow Data section */}
          </div>
        )}
        <div className="metadataPaneHeader">
          {/* Existing Activity Log header */}
        </div>
        {/* Existing Activity Log content */}
      </aside>
    );
    ```

    **CSS additions in `client/src/components/chat.css`:**

    Add a new section before the existing Metadata Pane header styles:

    ```css
    /* ─────────────────────────────────────────────────────────────────────────
       Workflow Data Section in MetadataPane (META-01, META-02)
       Shows accumulated collectedData above Activity Log.
       ───────────────────────────────────────────────────────────────────────── */

    .workflowDataSection {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--color-border);
    }

    .workflowDataList {
      margin: var(--space-2) 0 0 0;
      padding: 0;
    }

    .workflowDataEntry {
      padding: var(--space-1) 0;
      border-bottom: 1px solid var(--color-border);
    }

    .workflowDataEntry:last-child {
      border-bottom: none;
    }

    .workflowDataKey {
      font-size: var(--font-size-xs);
      font-family: monospace;
      color: var(--color-text-muted);
      margin-bottom: 2px;
    }

    .workflowDataValue {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      margin: 0;
      word-break: break-word;
    }

    .viewFullDataToggle {
      display: inline-block;
      font-size: var(--font-size-xs);
      color: var(--color-primary);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      margin-bottom: var(--space-1);
    }

    .viewFullDataToggle:hover {
      color: var(--color-primary-hover);
    }

    .viewFullDataToggle:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    .workflowDataJson {
      font-size: var(--font-size-xs);
      font-family: monospace;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: var(--space-2);
      margin: var(--space-1) 0 0 0;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    ```

    After changes: run `cd /Users/zycroft/Documents/PA/aaae && npm run build` to verify no TypeScript errors.

    Commit: `feat(21-03): add Workflow Data section to MetadataPane`.
  </action>
  <verify>Run `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1`. Zero TypeScript errors. Grep for `workflowDataSection` in MetadataPane.tsx and chat.css. Grep for `flattenData` in MetadataPane.tsx.</verify>
  <done>MetadataPane renders Workflow Data section above Activity Log with dot-notation flattening and View full data toggle. TypeScript clean. Committed `feat(21-03): add Workflow Data section to MetadataPane`.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ChatShell with WorkflowComplete and ChatInput dynamic props</name>
  <files>client/src/components/ChatShell.tsx</files>
  <action>
    Update `client/src/components/ChatShell.tsx` to:

    **1. Import WorkflowComplete:**
    ```tsx
    import { WorkflowComplete } from './WorkflowComplete.js';
    ```

    **2. Pass workflowState to MetadataPane:**
    ```tsx
    <MetadataPane messages={messages} workflowState={workflowState} />
    ```

    **3. Conditionally render WorkflowComplete vs transcript+input:**

    When `workflowState?.status === 'completed'`, replace the TranscriptView and ChatInput with WorkflowComplete:

    ```tsx
    {workflowState?.status === 'completed' ? (
      <WorkflowComplete workflowState={workflowState} onReset={resetConversation} />
    ) : (
      <>
        <TranscriptView messages={messages} isLoading={isLoading} onCardAction={cardAction} />
        <ChatInput
          onSend={sendMessage}
          disabled={isLoading}
          suggestedInputType={workflowState?.suggestedInputType}
          choices={workflowState?.choices}
        />
      </>
    )}
    ```

    **4. Keep WorkflowProgress visible during active workflows but hidden during completion:**

    WorkflowProgress already returns null when status !== 'active', so no change needed. It will automatically hide when status === 'completed'.

    **5. Full ChatShell render structure:**
    ```tsx
    <div className="chatShell">
      {error && <div className="globalError">{error}</div>}
      {workflowState?.status === 'error' && (
        <div className="workflowError" role="alert">
          {/* existing error banner */}
        </div>
      )}
      <div className="chatHeader">
        <ThemeToggle theme={theme} onToggle={toggle} />
        <button type="button" className="signOutButton" onClick={handleSignOut} aria-label="Sign out">
          Sign out
        </button>
      </div>
      <WorkflowProgress workflowState={workflowState} />
      {workflowState?.status === 'completed' ? (
        <WorkflowComplete workflowState={workflowState} onReset={resetConversation} />
      ) : (
        <>
          <TranscriptView messages={messages} isLoading={isLoading} onCardAction={cardAction} />
          <ChatInput
            onSend={sendMessage}
            disabled={isLoading}
            suggestedInputType={workflowState?.suggestedInputType}
            choices={workflowState?.choices}
          />
        </>
      )}
    </div>
    ```

    After changes: run `cd /Users/zycroft/Documents/PA/aaae && npm run build` to verify no TypeScript errors. Run all tests: `cd /Users/zycroft/Documents/PA/aaae && npm test`.

    Commit: `feat(21-03): wire ChatShell with WorkflowComplete and ChatInput dynamic props`.
  </action>
  <verify>Run `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1`. Zero TypeScript errors. Run `cd /Users/zycroft/Documents/PA/aaae && npm test 2>&1` — all tests pass. Grep for `WorkflowComplete` in ChatShell.tsx. Grep for `suggestedInputType` in ChatShell.tsx. Grep for `workflowState` in MetadataPane usage in ChatShell.tsx.</verify>
  <done>ChatShell conditionally renders WorkflowComplete, passes dynamic input props to ChatInput, and passes workflowState to MetadataPane. TypeScript clean. All tests pass. Committed `feat(21-03): wire ChatShell with WorkflowComplete and ChatInput dynamic props`.</done>
</task>

</tasks>

<verification>
1. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build` — no TypeScript errors
2. Run `cd /Users/zycroft/Documents/PA/aaae && npm test` — all tests pass
3. MetadataPane accepts optional workflowState prop — grep for `workflowState` in MetadataPane.tsx
4. MetadataPane renders "Workflow Data" section when collectedData present — grep for `workflowDataSection` in MetadataPane.tsx
5. Nested objects flattened with dot notation — grep for `flattenData` in MetadataPane.tsx
6. Deep nesting (>3 levels) shows "View full data" toggle — grep for `viewFullDataToggle` in MetadataPane.tsx
7. ChatShell renders WorkflowComplete when status === 'completed' — grep for `WorkflowComplete` in ChatShell.tsx
8. ChatShell passes suggestedInputType and choices to ChatInput — grep for `suggestedInputType` in ChatShell.tsx
9. ChatShell passes workflowState to MetadataPane — grep for `workflowState={workflowState}` usage for MetadataPane
10. CSS contains `.workflowDataSection`, `.workflowDataKey`, `.workflowDataJson`, `.viewFullDataToggle` in chat.css
</verification>

<success_criteria>
- MetadataPane shows "Workflow Data" section above Activity Log when collectedData is present
- Workflow data rendered as dl/dt/dd with monospace keys and muted color
- Nested objects (2-3 levels) displayed inline with dot notation
- Deeper structures show "View full data" toggle with <pre> JSON block
- ChatShell renders WorkflowComplete (replacing transcript + input) when status === 'completed'
- ChatShell passes suggestedInputType and choices from workflowState to ChatInput
- ChatShell passes workflowState to MetadataPane
- All tests pass, TypeScript build clean
- No regression to existing chat functionality (pure chat mode unchanged)
</success_criteria>

<output>
After completion, create `.planning/phases/21-dynamic-input-completion-metadatapane/21-03-SUMMARY.md`
</output>
