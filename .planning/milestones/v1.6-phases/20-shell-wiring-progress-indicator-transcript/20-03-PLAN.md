---
phase: 20-shell-wiring-progress-indicator-transcript
plan: 03
type: execute
wave: 2
depends_on: [20-01, 20-02]
files_modified:
  - client/src/components/ChatShell.tsx
  - client/src/components/chat.css
autonomous: true
requirements: [SHELL-01, SHELL-02]

must_haves:
  truths:
    - "ChatShell passes workflowState to WorkflowProgress, rendering it above the transcript when active"
    - "ChatShell shows a visible error state with a Retry button when workflowState.status is 'error'"
    - "The Retry button calls resetConversation() to clear state and restart"
    - "The generic globalError banner still shows for non-workflow errors (e.g., failed to start conversation)"
    - "WorkflowProgress appears above TranscriptView in the flex column, below the chatHeader"
  artifacts:
    - path: "client/src/components/ChatShell.tsx"
      provides: "Updated ChatShell importing WorkflowProgress, passing workflowState, rendering workflow error state"
      exports: ["ChatShell"]
    - path: "client/src/components/chat.css"
      provides: "CSS for .workflowError, .workflowErrorRetry button"
      contains: ".workflowError"
  key_links:
    - from: "client/src/components/ChatShell.tsx"
      to: "client/src/components/WorkflowProgress.tsx"
      via: "import WorkflowProgress; render <WorkflowProgress workflowState={workflowState} />"
      pattern: "WorkflowProgress"
    - from: "client/src/components/ChatShell.tsx"
      to: "client/src/hooks/useChatApi.ts"
      via: "destructures workflowState and resetConversation from useChatApi"
      pattern: "workflowState.*resetConversation"
---

<objective>
Wire ChatShell to pass workflowState to WorkflowProgress and display a workflow-specific error state with a Retry button when workflowState.status is 'error'. This is the final integration step that makes the progress bar and error state visible in the running app.

Purpose: Users see the progress bar above the transcript during active workflows, and see a clear recovery path when the workflow errors out.
Output: Updated ChatShell.tsx with WorkflowProgress integration and workflow error UI, new CSS classes in chat.css.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@client/src/components/ChatShell.tsx
@client/src/components/chat.css
@client/src/hooks/useChatApi.ts
@.planning/phases/20-shell-wiring-progress-indicator-transcript/20-01-SUMMARY.md
@.planning/phases/20-shell-wiring-progress-indicator-transcript/20-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire WorkflowProgress into ChatShell and add workflow error state</name>
  <files>client/src/components/ChatShell.tsx, client/src/components/chat.css</files>
  <action>
    **In `client/src/components/ChatShell.tsx`:**

    1. Import `WorkflowProgress`:
       ```tsx
       import { WorkflowProgress } from './WorkflowProgress.js';
       ```

    2. Destructure `workflowState` and `resetConversation` from `useChatApi`:
       ```tsx
       const { messages, isLoading, error, sendMessage, cardAction, workflowState, resetConversation } = useChatApi({ getToken });
       ```

    3. Add WorkflowProgress above TranscriptView in the JSX (inside `.chatShell`, after `.chatHeader`, before `<TranscriptView>`):
       ```tsx
       <WorkflowProgress workflowState={workflowState} />
       ```

    4. Add workflow error state below the existing `{error && <div className="globalError">...}` block. This is a separate UI from the global error banner — it's specific to workflowState.status === 'error':
       ```tsx
       {workflowState?.status === 'error' && (
         <div className="workflowError" role="alert">
           <span className="workflowErrorMessage">
             The workflow encountered an error.
           </span>
           <button
             type="button"
             className="workflowErrorRetry"
             onClick={resetConversation}
           >
             Start over
           </button>
         </div>
       )}
       ```
       Place this after the globalError block and before the WorkflowProgress component in the render order.

    The final `.chatShell` flex column ordering (top to bottom):
    1. `{error && <div className="globalError">...}`  ← existing, non-workflow errors
    2. `{workflowState?.status === 'error' && <div className="workflowError">...}` ← new
    3. `<div className="chatHeader">...` ← existing header with theme toggle + sign out
    4. `<WorkflowProgress workflowState={workflowState} />` ← new
    5. `<TranscriptView ...>` ← existing
    6. `<ChatInput ...>` ← existing

    **In `client/src/components/chat.css`** — add workflow error styles after the globalError section:

    ```css
    /* ─────────────────────────────────────────────────────────────────────────
       Workflow Error State (SHELL-02)
       Banner with retry option when workflowState.status is 'error'
       ───────────────────────────────────────────────────────────────────────── */

    .workflowError {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--color-error-bg);
      border-bottom: 1px solid var(--color-error-border);
      flex-shrink: 0;
    }

    .workflowErrorMessage {
      font-size: var(--font-size-sm);
      color: var(--color-error-text);
    }

    .workflowErrorRetry {
      padding: var(--space-1) var(--space-3);
      background: var(--color-error-text);
      color: var(--color-bg);
      border: none;
      border-radius: 4px;
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
      transition: opacity var(--transition-base);
    }

    .workflowErrorRetry:hover {
      opacity: 0.85;
    }

    .workflowErrorRetry:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px var(--color-focus-ring);
    }
    ```

    After all changes: run `cd /Users/zycroft/Documents/PA/aaae && npm run build` to verify no TypeScript errors. Run `npm run lint` to check for lint issues.
  </action>
  <verify>
    Run `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1` — zero TypeScript errors.
    Run `cd /Users/zycroft/Documents/PA/aaae && npm run lint 2>&1` — no new lint errors beyond pre-existing known issues.
    Grep for `WorkflowProgress` in ChatShell.tsx to confirm import and usage.
    Grep for `workflowState?.status === 'error'` in ChatShell.tsx to confirm error state rendering.
    Grep for `resetConversation` in ChatShell.tsx to confirm it is destructured and used in onClick.
    Grep for `.workflowError` in chat.css to confirm error styles exist.
  </verify>
  <done>
    ChatShell imports WorkflowProgress and renders it with workflowState prop.
    Workflow error state renders when workflowState.status === 'error' with a "Start over" button calling resetConversation.
    TypeScript build and lint clean.
    Committed `feat(20-03): wire ChatShell with WorkflowProgress and workflow error state`.
  </done>
</task>

</tasks>

<verification>
1. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build` — no TypeScript errors
2. Run `cd /Users/zycroft/Documents/PA/aaae && npm run lint` — no new errors beyond pre-existing known issues
3. Run `cd /Users/zycroft/Documents/PA/aaae && npm test` — all tests pass (WorkflowProgress tests from Plan 01)
4. ChatShell.tsx contains: `import { WorkflowProgress }`, `<WorkflowProgress workflowState={workflowState} />`, `workflowState?.status === 'error'`, `onClick={resetConversation}`
5. chat.css contains: `.workflowError`, `.workflowErrorMessage`, `.workflowErrorRetry`
</verification>

<success_criteria>
- ChatShell destructures workflowState and resetConversation from useChatApi
- WorkflowProgress renders above TranscriptView in the DOM (flex column order: error banner → workflow error → header → progress → transcript → input)
- Workflow error banner with "Start over" button appears when workflowState.status === 'error'
- All 6 WorkflowProgress unit tests still pass
- TypeScript build clean, no new lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-shell-wiring-progress-indicator-transcript/20-03-SUMMARY.md`
</output>
