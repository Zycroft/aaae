# Requirements Archive: v1.4 Persistent State Store

**Archived:** 2026-02-22
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: Agentic Copilot Chat App

**Defined:** 2026-02-21
**Core Value:** Users can interact with a Copilot Studio agent through a polished chat UI that seamlessly mixes text responses and interactive Adaptive Cards — server-side only, secrets protected, authenticated via Entra External ID.

## v1.4 Requirements

Requirements for Persistent State Store (Azure Cache for Redis). Each maps to roadmap phases.

### Storage Layer

- [x] **STORE-01**: Server persists conversations in Redis when REDIS_URL is set — Phase 11
- [x] **STORE-02**: Server uses InMemoryStore when REDIS_URL is not set (no regression) — Phase 11
- [x] **STORE-03**: Store factory selects Redis or InMemory based on REDIS_URL env var — Phase 11
- [x] **STORE-04**: Server logs which store backend is active on startup — Phase 11
- [x] **STORE-05**: Redis connection uses TLS for Azure Cache (rediss:// protocol, port 6380) — Phase 12
- [x] **STORE-06**: Conversations auto-expire after configurable TTL (default 24 hours) — Phase 12
- [x] **STORE-07**: All Redis operations enforce configurable timeout (default 5 seconds) — Phase 12

### State Model

- [x] **STATE-01**: StoredConversation includes userId and tenantId fields — Phase 11
- [x] **STATE-02**: StoredConversation includes createdAt and updatedAt ISO 8601 timestamps — Phase 11
- [x] **STATE-03**: StoredConversation includes status field (active/completed/abandoned) — Phase 11
- [x] **STATE-04**: StoredConversation includes optional workflow fields (workflowId, currentStep, stepData, metadata) — Phase 11
- [x] **STATE-05**: Zod schema for StoredConversation lives in shared/src/schemas/ — Phase 11
- [x] **STATE-06**: Existing conversations without new fields still load (backward compatible defaults) — Phase 11

### Querying

- [x] **QUERY-01**: ConversationStore interface has listByUser(userId) method — Phase 11
- [x] **QUERY-02**: listByUser returns conversations sorted by most recent, limited to 50 — Phase 12
- [x] **QUERY-03**: Redis implementation uses sorted set secondary index for user lookup — Phase 12

### Resilience

- [x] **RESIL-01**: Server returns 503 Service Unavailable when Redis is unreachable — Phase 14 (gap closure)
- [x] **RESIL-02**: /health endpoint reports Redis connectivity status (connected/disconnected) — Phase 12
- [x] **RESIL-03**: Redis connection retries on transient errors with logging — Phase 12

### Route Integration

- [x] **ROUTE-01**: /api/chat/start sets userId and tenantId from req.user JWT claims — Phase 13
- [x] **ROUTE-02**: /api/chat/start sets createdAt timestamp and status to 'active' — Phase 11
- [x] **ROUTE-03**: /api/chat/send and /card-action update updatedAt timestamp — Phase 11
- [x] **ROUTE-04**: Routes use placeholder values (userId: 'anonymous', tenantId: 'dev') when auth not deployed — Phase 13

### Testing

- [x] **TEST-01**: Unit tests for RedisStore using ioredis-mock — Phase 12
- [x] **TEST-02**: Unit tests for store factory pattern (Redis selected when REDIS_URL set, InMemory otherwise) — Phase 13
- [x] **TEST-03**: Updated .env.example with Redis configuration variables — Phase 12

## Future Requirements

Deferred to future milestones. Tracked but not in current roadmap.

### Workflow Orchestrator (v1.5)

- **WFLOW-01**: Orchestrator uses workflowId/currentStep/stepData from StoredConversation
- **WFLOW-02**: Multi-step workflow progression tracked in conversation state
- **WFLOW-03**: Workflow state transitions validated via state machine

### Scaling (v2+)

- **SCALE-01**: Redis Cluster support for multi-node deployment
- **SCALE-02**: Conversation archival to cold storage after TTL
- **SCALE-03**: Tenant-scoped queries (listByTenant)

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Redis Cluster support | Single-node Azure Cache sufficient for v1.4 scale |
| Data migration from InMemory to Redis | Greenfield — no existing persistent data to migrate |
| Conversation archival to cold storage | Defer to v2+ based on retention requirements |
| Real-time pub/sub notifications | Not needed for state store; future feature |
| Redis Sentinel failover | Azure Cache handles HA internally |
| Silent fallback to InMemory on Redis failure | Explicitly rejected — causes hidden data loss |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| STORE-01 | Phase 11 | Complete |
| STORE-02 | Phase 11 | Complete |
| STORE-03 | Phase 11 | Complete |
| STORE-04 | Phase 11 | Complete |
| STORE-05 | Phase 12 | Complete |
| STORE-06 | Phase 12 | Complete |
| STORE-07 | Phase 12 | Complete |
| STATE-01 | Phase 11 | Complete |
| STATE-02 | Phase 11 | Complete |
| STATE-03 | Phase 11 | Complete |
| STATE-04 | Phase 11 | Complete |
| STATE-05 | Phase 11 | Complete |
| STATE-06 | Phase 11 | Complete |
| QUERY-01 | Phase 11 | Complete |
| QUERY-02 | Phase 12 | Complete |
| QUERY-03 | Phase 12 | Complete |
| RESIL-01 | Phase 14 (gap closure) | Complete |
| RESIL-02 | Phase 12 | Complete |
| RESIL-03 | Phase 12 | Complete |
| ROUTE-01 | Phase 13 | Complete |
| ROUTE-02 | Phase 11 | Complete |
| ROUTE-03 | Phase 11 | Complete |
| ROUTE-04 | Phase 13 | Complete |
| TEST-01 | Phase 12 | Complete |
| TEST-02 | Phase 13 | Complete |
| TEST-03 | Phase 12 | Complete |

**Coverage:**
- v1.4 requirements: 26 total
- Mapped to phases: 26
- Unmapped: 0

---
*Requirements defined: 2026-02-21*
*Last updated: 2026-02-21 after roadmap creation (Phases 11–13)*
