---
phase: 06-server-jwt-validation-org-allowlist
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/package.json
  - server/src/middleware/auth.ts
  - server/src/types/express.d.ts
  - server/src/middleware/auth.test.ts
autonomous: true
requirements: [SAUTH-01, SAUTH-02, SAUTH-03, SAUTH-04, SAUTH-05, SAUTH-06, TEST-01]

must_haves:
  truths:
    - "A request with a valid JWT (correct signature, audience, issuer, unexpired) passes authMiddleware and has req.user populated with sub, tid, oid from claims"
    - "A request with an expired token receives a 401 JSON response with WWW-Authenticate header and error code 'token_expired'"
    - "A request with wrong audience receives 401 with error code 'audience_mismatch'"
    - "A request with wrong issuer receives 401 with error code 'issuer_mismatch'"
    - "A request with no Authorization header receives 401 with error code 'token_missing'"
    - "When AUTH_REQUIRED=false, req.user is populated with the hardcoded stub (sub: 'local-dev-user') and request passes through"
    - "Unit tests cover all the above cases and pass"
  artifacts:
    - path: "server/src/middleware/auth.ts"
      provides: "authMiddleware Express middleware — JWKS validation via jose"
      exports: ["authMiddleware"]
    - path: "server/src/types/express.d.ts"
      provides: "Express Request type augmentation declaring req.user: UserClaims"
      contains: "UserClaims"
    - path: "server/src/middleware/auth.test.ts"
      provides: "Vitest unit tests for authMiddleware"
      min_lines: 60
  key_links:
    - from: "server/src/middleware/auth.ts"
      to: "https://{tenant}.ciamlogin.com/{tenant}.onmicrosoft.com/discovery/v2.0/keys"
      via: "jose createRemoteJWKSet"
      pattern: "createRemoteJWKSet"
    - from: "server/src/middleware/auth.ts"
      to: "shared/src/schemas/auth.ts"
      via: "UserClaimsSchema.parse on decoded payload"
      pattern: "UserClaimsSchema\\.parse"
    - from: "server/src/types/express.d.ts"
      to: "server/src/middleware/auth.ts"
      via: "TypeScript declaration merging — req.user: UserClaims available in routes"
      pattern: "user\\?: UserClaims"
---

<objective>
Replace the Phase 1 auth stub in `server/src/middleware/auth.ts` with real JWT validation using `jose`. The middleware fetches the JWKS from the Entra External ID discovery endpoint, validates the token signature, audience, issuer, and expiry, then populates `req.user` with parsed `UserClaims`. When `AUTH_REQUIRED=false`, it injects a hardcoded stub user and passes through.

Purpose: Authenticated requests can now reach the Copilot proxy with `req.user` guaranteed populated. This is the security gate for Phase 6 — every subsequent API call is authorized.
Output: Replaced auth.ts, new express.d.ts type augmentation, Vitest test file covering all auth scenarios.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-server-jwt-validation-org-allowlist/06-CONTEXT.md
@server/src/middleware/auth.ts
@server/src/config.ts
@server/src/app.ts
@shared/src/schemas/auth.ts
@server/src/allowlist/cardActionAllowlist.test.ts
</context>

<feature>
  <name>JWT Validation Middleware (authMiddleware)</name>
  <files>
    server/src/middleware/auth.ts
    server/src/types/express.d.ts
    server/src/middleware/auth.test.ts
    server/package.json
  </files>
  <behavior>
    authMiddleware(req, res, next): Express middleware

    When AUTH_REQUIRED=false:
      - Inject stub: req.user = { sub: 'local-dev-user', tid: 'local-dev-tenant', oid: 'local-dev-oid', name: 'Local Developer', email: 'dev@localhost' }
      - Log once at startup: '[auth] WARNING: AUTH_REQUIRED=false — all requests bypass JWT validation with stub user'
      - Call next()

    When AUTH_REQUIRED=true:
      - No Authorization header → 401 JSON { error: 'token_missing', message: 'Authorization header required' } + WWW-Authenticate: Bearer header
      - Authorization header present but not 'Bearer xxx' format → 401 JSON { error: 'token_invalid', message: '...' } + WWW-Authenticate: Bearer
      - Token expired (exp claim in past) → 401 JSON { error: 'token_expired', message: '...' } + WWW-Authenticate: Bearer
      - Wrong audience (aud claim !== 'api://{AZURE_CLIENT_ID}') → 401 JSON { error: 'audience_mismatch', message: '...' } + WWW-Authenticate: Bearer
      - Wrong issuer (iss claim !== expected CIAM issuer) → 401 JSON { error: 'issuer_mismatch', message: '...' } + WWW-Authenticate: Bearer
      - Valid token: parse payload through UserClaimsSchema → set req.user → call next()
      - UserClaimsSchema.parse failure (malformed claims) → 401 JSON { error: 'token_invalid', message: '...' } + WWW-Authenticate: Bearer

    JWT validation config:
      - audience: 'api://' + config.AZURE_CLIENT_ID (non-null — startup guard ensures this)
      - issuer: 'https://' + config.AZURE_TENANT_NAME + '.ciamlogin.com/' + config.AZURE_TENANT_NAME + '.onmicrosoft.com/v2.0'
      - JWKS endpoint: 'https://' + config.AZURE_TENANT_NAME + '.ciamlogin.com/' + config.AZURE_TENANT_NAME + '.onmicrosoft.com/discovery/v2.0/keys'
      - Use jose createRemoteJWKSet (handles caching and rotation automatically)
      - Use jose jwtVerify with { audience, issuer, clockTolerance: 30 } (30s tolerance for clock skew)

    Error logging (no PII):
      - JWT failures: console.warn('[auth] Rejected: <reason>') — no token contents, no claims
      - No logging on success (too noisy)

    Test cases (Vitest, mock jose and config):
      - no Authorization header → 401 { error: 'token_missing' } + WWW-Authenticate header present
      - 'NotBearer token' header → 401 { error: 'token_invalid' }
      - expired token (mock jwtVerify throws JWTExpired) → 401 { error: 'token_expired' }
      - wrong audience (mock jwtVerify throws JWTClaimValidationFailed on audience) → 401 { error: 'audience_mismatch' }
      - wrong issuer (mock jwtVerify throws JWTClaimValidationFailed on issuer) → 401 { error: 'issuer_mismatch' }
      - valid token (mock jwtVerify returns payload with sub/tid/oid) → next() called, req.user set
      - AUTH_REQUIRED=false → stub user set, next() called, no jwtVerify call
  </behavior>
  <implementation>
    1. Install jose: `cd /Users/zycroft/Documents/PA/aaae/server && npm install jose`
    2. Create server/src/types/express.d.ts — declare module 'express-serve-static-core' augmenting Request with `user?: UserClaims`
    3. Write RED tests first in server/src/middleware/auth.test.ts — all 7 cases above as failing tests
    4. Run `cd /Users/zycroft/Documents/PA/aaae/server && npm test -- --reporter=verbose 2>&1 | head -60` to confirm RED
    5. Implement server/src/middleware/auth.ts:
       - Import { createRemoteJWKSet, jwtVerify, JWTExpired, JWTClaimValidationFailed } from 'jose'
       - Import { UserClaimsSchema } from '@copilot-chat/shared'
       - Import { config } from '../config.js'
       - Build JWKS URL and expected issuer/audience from config at module load time
       - Use createRemoteJWKSet(new URL(jwksUrl)) — call once at module level (jose caches internally)
       - Implement the stub path (AUTH_REQUIRED=false) — log warning once (use a module-level flag)
       - Implement the JWT validation path with try/catch distinguishing JWTExpired vs JWTClaimValidationFailed vs generic Error
       - For JWTClaimValidationFailed: inspect err.claim to return 'audience_mismatch' vs 'issuer_mismatch'
       - On success: parse payload with UserClaimsSchema.parse(), assign to req.user, call next()
    6. Run `cd /Users/zycroft/Documents/PA/aaae/server && npm test -- --reporter=verbose 2>&1 | head -60` to confirm GREEN
    7. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1` to confirm TypeScript compiles

    IMPORTANT — Use jose (NOT jsonwebtoken + jwks-rsa):
    - Server is "type": "module" (pure ESM) — jose is pure ESM, no CJS wrapper friction
    - jose provides createRemoteJWKSet with built-in JWKS caching and key rotation
    - jose jwtVerify throws typed errors (JWTExpired, JWTClaimValidationFailed) that map cleanly to our error codes
    - jose is the industry standard for ESM JWT validation in Node.js

    IMPORTANT — Express type augmentation pattern:
    - File: server/src/types/express.d.ts
    - Content: declare module 'express-serve-static-core' { interface Request { user?: UserClaims } }
    - Import UserClaims type at top: import type { UserClaims } from '@copilot-chat/shared'
    - Add "typeRoots" or "include" for this file in server/tsconfig.json if needed (check first)

    IMPORTANT — Startup warning log:
    - AUTH_REQUIRED=false warning must be logged ONCE at module initialization, not on every request
    - Use a module-level flag: `let stubWarnLogged = false` and set to true after first log
    - Or log immediately at module load when AUTH_REQUIRED=false (simpler — logs at import time)
  </implementation>
</feature>

<verification>
Run the following after implementation:

```bash
cd /Users/zycroft/Documents/PA/aaae/server && npm test -- --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|auth)"
cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1 | tail -20
```

Expected: All auth.test.ts tests pass (7+ tests). TypeScript build exits 0.
</verification>

<success_criteria>
- `server/src/middleware/auth.test.ts` exists with 7+ Vitest tests, all passing
- `server/src/types/express.d.ts` exists with `user?: UserClaims` on Express Request
- `server/src/middleware/auth.ts` uses `jose` (createRemoteJWKSet + jwtVerify) — NOT the Phase 1 stub
- AUTH_REQUIRED=false path injects the exact stub from CONTEXT.md decisions
- JWT error responses include `WWW-Authenticate: Bearer` header
- Error codes match CONTEXT.md: token_missing, token_invalid, token_expired, audience_mismatch, issuer_mismatch
- `npm run build` exits 0 (TypeScript compiles cleanly)
- No PII logged on auth failures
</success_criteria>

<output>
After completion, create `.planning/phases/06-server-jwt-validation-org-allowlist/06-01-SUMMARY.md`
</output>
