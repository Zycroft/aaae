---
phase: 06-server-jwt-validation-org-allowlist
plan: "02"
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - server/src/middleware/orgAllowlist.ts
  - server/src/middleware/orgAllowlist.test.ts
  - server/src/app.ts
autonomous: true
requirements: [ORG-01, ORG-02, ORG-03, ORG-04, TEST-02]

must_haves:
  truths:
    - "A request from a tenant listed in ALLOWED_TENANT_IDS passes orgAllowlist and reaches the Copilot proxy"
    - "A request from a tenant NOT listed in ALLOWED_TENANT_IDS receives a 403 JSON response with error 'tenant_not_allowed'"
    - "A request where req.user.tid is absent or ALLOWED_TENANT_IDS is empty receives a 403 response"
    - "The 403 denial is logged: '[auth] Rejected: tenant_not_allowed (tid: <tenant-id>)' with no PII beyond tid"
    - "orgAllowlist runs AFTER authMiddleware in app.ts — req.user is always populated when orgAllowlist runs"
    - "Unit tests pass for all org allowlist cases"
  artifacts:
    - path: "server/src/middleware/orgAllowlist.ts"
      provides: "orgAllowlist Express middleware — tid claim check against ALLOWED_TENANT_IDS"
      exports: ["orgAllowlist"]
    - path: "server/src/middleware/orgAllowlist.test.ts"
      provides: "Vitest unit tests for orgAllowlist"
      min_lines: 40
    - path: "server/src/app.ts"
      provides: "orgAllowlist wired on /api routes after authMiddleware"
      contains: "orgAllowlist"
  key_links:
    - from: "server/src/middleware/orgAllowlist.ts"
      to: "server/src/config.ts"
      via: "config.ALLOWED_TENANT_IDS (string[] pre-parsed at startup)"
      pattern: "config\\.ALLOWED_TENANT_IDS"
    - from: "server/src/middleware/orgAllowlist.ts"
      to: "server/src/types/express.d.ts"
      via: "req.user.tid claim from JWT-validated UserClaims"
      pattern: "req\\.user"
    - from: "server/src/app.ts"
      to: "server/src/middleware/orgAllowlist.ts"
      via: "app.use('/api', orgAllowlist) — after authMiddleware line"
      pattern: "orgAllowlist"
---

<objective>
Implement the org allowlist middleware (`orgAllowlist.ts`) that checks the `tid` claim from the already-validated JWT against `config.ALLOWED_TENANT_IDS`. Wire it into `app.ts` after `authMiddleware` so every `/api/*` route enforces both JWT validity AND tenant membership. TDD the middleware logic before writing the implementation.

Purpose: Completes the server-side auth stack. After Phase 6, every request that reaches the Copilot proxy has: (1) a valid JWT signature, (2) correct audience/issuer, (3) an approved tenant.
Output: orgAllowlist middleware, Vitest tests, updated app.ts.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-server-jwt-validation-org-allowlist/06-CONTEXT.md
@.planning/phases/06-server-jwt-validation-org-allowlist/06-01-SUMMARY.md
@server/src/app.ts
@server/src/config.ts
@server/src/middleware/auth.ts
@server/src/allowlist/cardActionAllowlist.ts
</context>

<feature>
  <name>Org Allowlist Middleware (orgAllowlist)</name>
  <files>
    server/src/middleware/orgAllowlist.ts
    server/src/middleware/orgAllowlist.test.ts
    server/src/app.ts
  </files>
  <behavior>
    orgAllowlist(req, res, next): Express middleware

    Precondition: authMiddleware has already run — req.user is populated (or the request was already rejected with 401).

    Logic:
      - Read tid from req.user.tid
      - If req.user is undefined (should not happen after authMiddleware, but defensive): return 403 { error: 'tenant_not_allowed', message: 'No user claims available' }
      - If config.ALLOWED_TENANT_IDS is empty: return 403 { error: 'tenant_not_allowed', message: 'No tenants are authorized' } — log '[auth] Rejected: tenant_not_allowed (tid: none — allowlist empty)'
      - If tid is NOT in config.ALLOWED_TENANT_IDS: return 403 { error: 'tenant_not_allowed', message: 'Your organization is not authorized' } — log '[auth] Rejected: tenant_not_allowed (tid: <tid>)'
      - If tid IS in config.ALLOWED_TENANT_IDS: call next() (no logging — success is not logged)

    Test cases (Vitest, mock config):
      - tid in ALLOWED_TENANT_IDS → next() called, no 403 sent
      - tid NOT in ALLOWED_TENANT_IDS → 403 { error: 'tenant_not_allowed' }, console.warn called with tid
      - ALLOWED_TENANT_IDS is empty → 403 { error: 'tenant_not_allowed' }, logged
      - req.user is undefined (defensive) → 403 { error: 'tenant_not_allowed' }
      - tid matches one of multiple entries in ALLOWED_TENANT_IDS → next() called

    App wiring in server/src/app.ts:
      - Import orgAllowlist from './middleware/orgAllowlist.js'
      - Add `app.use('/api', orgAllowlist)` IMMEDIATELY AFTER `app.use('/api', authMiddleware)` line
      - Order matters: auth validates the token, orgAllowlist enforces tenant membership
      - Do NOT place orgAllowlist before authMiddleware (req.user would not exist yet)

    Error response format (matches CONTEXT.md decisions):
      - 403: { "error": "tenant_not_allowed", "message": "<human-readable>" }
      - NO WWW-Authenticate header on 403 (only 401 uses that per RFC 6750)
      - Log format: '[auth] Rejected: tenant_not_allowed (tid: <tid>)' — tid is NOT PII, it is a tenant identifier
  </behavior>
  <implementation>
    1. Write RED tests in server/src/middleware/orgAllowlist.test.ts — 5 cases above as failing tests
       - Use vi.mock to mock '../config.js' and inject test ALLOWED_TENANT_IDS values
       - Use mock req/res/next objects (same pattern as cardActionAllowlist.test.ts uses for pure functions)
       - For Express middleware: create mock req = { user: { tid: '...', sub: '...', oid: '...' } }, res = { status: vi.fn().mockReturnThis(), json: vi.fn() }, next = vi.fn()
    2. Run `cd /Users/zycroft/Documents/PA/aaae/server && npm test -- --reporter=verbose 2>&1 | head -60` to confirm RED
    3. Implement server/src/middleware/orgAllowlist.ts:
       - Import type { Request, Response, NextFunction } from 'express'
       - Import { config } from '../config.js'
       - Pure middleware function — no external HTTP calls, no async needed
       - Use config.ALLOWED_TENANT_IDS directly (already a string[] from Phase 5)
       - Defensive check for req.user undefined before accessing .tid
    4. Run `cd /Users/zycroft/Documents/PA/aaae/server && npm test -- --reporter=verbose 2>&1 | head -60` to confirm GREEN
    5. Update server/src/app.ts:
       - Add import for orgAllowlist
       - Add `app.use('/api', orgAllowlist)` after the existing `app.use('/api', authMiddleware)` line
       - Confirm /health route is NOT affected (health check is before /api routes)
    6. Run `cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1` to confirm clean TypeScript build
    7. Run `cd /Users/zycroft/Documents/PA/aaae && npm test 2>&1 | tail -30` to confirm all tests pass

    IMPORTANT — Middleware ordering in app.ts:
    - Current app.ts: app.use('/api', authMiddleware) then app.use('/api/chat', chatRouter)
    - After this plan: app.use('/api', authMiddleware) → app.use('/api', orgAllowlist) → app.use('/api/chat', chatRouter)
    - The /health route is registered BEFORE /api routes and is unaffected

    IMPORTANT — config.ALLOWED_TENANT_IDS is already string[]:
    - Phase 5 pre-parsed this at config load time — no splitting needed in the middleware
    - Empty array means fail-closed per CONTEXT.md decisions
    - Do NOT re-parse from process.env in the middleware

    IMPORTANT — No async needed:
    - This is a pure synchronous lookup (Array.includes on an in-memory string[])
    - Do not make the function async — synchronous Express middleware is simpler and correct here
  </implementation>
</feature>

<verification>
Run the following after implementation:

```bash
cd /Users/zycroft/Documents/PA/aaae/server && npm test -- --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|auth|org)"
cd /Users/zycroft/Documents/PA/aaae && npm run build 2>&1 | tail -10
cd /Users/zycroft/Documents/PA/aaae && npm test 2>&1 | tail -20
```

Expected: All orgAllowlist.test.ts tests pass (5+ tests). TypeScript build exits 0. Full test suite passes.
</verification>

<success_criteria>
- `server/src/middleware/orgAllowlist.ts` exists with synchronous Express middleware
- `server/src/middleware/orgAllowlist.test.ts` exists with 5+ Vitest tests, all passing
- `server/src/app.ts` applies orgAllowlist on '/api' AFTER authMiddleware
- Disallowed tenant receives exactly: HTTP 403 JSON { "error": "tenant_not_allowed", "message": "..." }
- Empty ALLOWED_TENANT_IDS blocks all tenants (fail-closed per CONTEXT.md decision)
- Denial logged with tid, no email/name in log output
- `npm test` passes across all workspaces
- `npm run build` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/06-server-jwt-validation-org-allowlist/06-02-SUMMARY.md`
</output>
