---
phase: 07-client-msal-authentication
plan: "02"
type: execute
wave: 2
depends_on:
  - "07-01"
files_modified:
  - client/src/auth/AuthGuard.tsx
  - client/src/auth/SignInPage.tsx
  - client/src/components/chat.css
  - client/src/App.tsx
  - client/src/main.tsx
autonomous: true
requirements:
  - CAUTH-01
  - CAUTH-02
  - CAUTH-03

must_haves:
  truths:
    - "Opening the app without an active session shows a sign-in page (not the chat UI)"
    - "The sign-in page has a centered card with the app name and a sign-in button; it uses existing CSS design tokens and respects dark/light theme"
    - "Clicking sign-in redirects the browser to the Entra External ID login page via MSAL redirect flow"
    - "During initial auth check (MSAL initializing), the existing SkeletonBubble loading pattern is shown"
    - "After successful redirect sign-in, the chat UI renders with a brief 'Welcome, {name}' toast visible for ~1 second"
    - "AuthProvider wraps the entire app and MsalProvider context is available to all components"
  artifacts:
    - path: "client/src/auth/AuthGuard.tsx"
      provides: "Auth state gate — renders skeleton, sign-in page, or children based on MSAL state"
      exports: ["AuthGuard"]
    - path: "client/src/auth/SignInPage.tsx"
      provides: "Centered sign-in card with Microsoft sign-in button"
      exports: ["SignInPage"]
    - path: "client/src/App.tsx"
      provides: "Updated App that wraps ChatShell in AuthGuard"
      contains: "AuthGuard"
    - path: "client/src/main.tsx"
      provides: "Updated entry point wrapping App in AuthProvider"
      contains: "AuthProvider"
  key_links:
    - from: "client/src/main.tsx"
      to: "client/src/auth/AuthProvider.tsx"
      via: "wraps App in AuthProvider"
      pattern: "<AuthProvider>"
    - from: "client/src/App.tsx"
      to: "client/src/auth/AuthGuard.tsx"
      via: "wraps ChatShell in AuthGuard"
      pattern: "<AuthGuard>"
    - from: "client/src/auth/AuthGuard.tsx"
      to: "useMsal hook"
      via: "reads inProgress and accounts"
      pattern: "useMsal|useIsAuthenticated|InteractionStatus"
    - from: "client/src/auth/SignInPage.tsx"
      to: "loginRequest scopes"
      via: "passes to instance.loginRedirect"
      pattern: "loginRedirect.*loginRequest"
---

<objective>
Build the AuthGuard and SignInPage components, wire them into the app, and gate the chat UI behind authentication.

Purpose: Unauthenticated users see a sign-in page; authenticated users see the chat UI unchanged. The auth check uses MSAL's `InteractionStatus` to avoid rendering the sign-in page while a redirect is in progress. A brief welcome toast appears after the first redirect sign-in.

Output: `AuthGuard.tsx` (state machine gating UI), `SignInPage.tsx` (sign-in card), CSS additions for auth UI, updated `App.tsx` and `main.tsx`.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-client-msal-authentication/07-CONTEXT.md
@.planning/phases/07-client-msal-authentication/07-01-SUMMARY.md
@client/src/App.tsx
@client/src/main.tsx
@client/src/components/ChatShell.tsx
@client/src/components/SkeletonBubble.tsx
@client/src/components/chat.css
@client/src/auth/msalConfig.ts
@client/src/auth/AuthProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuthGuard component (auth state machine)</name>
  <files>client/src/auth/AuthGuard.tsx</files>
  <action>
    Create `client/src/auth/AuthGuard.tsx`:

    ```typescript
    import { useEffect, useRef, useState, type ReactNode } from 'react';
    import { useMsal, useIsAuthenticated } from '@azure/msal-react';
    import { InteractionStatus } from '@azure/msal-browser';
    import { SkeletonBubble } from '../components/SkeletonBubble.js';
    import { SignInPage } from './SignInPage.js';

    interface AuthGuardProps {
      children: ReactNode;
    }

    /**
     * Gates the app behind MSAL authentication.
     *
     * State machine:
     * 1. MSAL initializing (inProgress !== None) → show skeleton (same pattern as message loading)
     * 2. Not authenticated + MSAL idle → show SignInPage
     * 3. Authenticated → show welcome toast for ~1 second (first time after redirect), then children
     *
     * CRITICAL: InteractionStatus must be checked before isAuthenticated.
     * During a redirect flow, inProgress is 'handleRedirect' — rendering SignInPage during this
     * window would cause a loop. The skeleton during init avoids this.
     *
     * CAUTH-01, CAUTH-02, CAUTH-03
     */
    export function AuthGuard({ children }: AuthGuardProps) {
      const { inProgress, accounts } = useMsal();
      const isAuthenticated = useIsAuthenticated();
      const [showWelcome, setShowWelcome] = useState(false);
      const welcomeShownRef = useRef(false);

      // Detect first-time sign-in (redirect just completed): accounts went from 0 → >0
      // Show welcome toast for 1200ms, then dismiss
      useEffect(() => {
        if (isAuthenticated && !welcomeShownRef.current) {
          // Only show welcome if MSAL just completed a redirect (handleRedirect → None transition)
          // Check sessionStorage flag set by SignInPage before redirect
          const justSignedIn = sessionStorage.getItem('msal:justSignedIn') === 'true';
          if (justSignedIn) {
            sessionStorage.removeItem('msal:justSignedIn');
            welcomeShownRef.current = true;
            setShowWelcome(true);
            const timer = setTimeout(() => setShowWelcome(false), 1200);
            return () => clearTimeout(timer);
          }
          welcomeShownRef.current = true;
        }
      }, [isAuthenticated]);

      // Phase 1: MSAL still initializing or processing redirect
      if (inProgress !== InteractionStatus.None) {
        return (
          <div className="authCheckLayout" aria-live="polite" aria-label="Checking authentication…">
            <SkeletonBubble />
          </div>
        );
      }

      // Phase 2: Idle, not authenticated
      if (!isAuthenticated) {
        return <SignInPage />;
      }

      // Phase 3: Authenticated — render children with optional welcome toast
      const name = accounts[0]?.name ?? accounts[0]?.username ?? '';

      return (
        <>
          {showWelcome && (
            <div className="welcomeToast" role="status" aria-live="polite">
              {name ? `Welcome, ${name}` : 'Welcome'}
            </div>
          )}
          {children}
        </>
      );
    }
    ```

    Important implementation notes:
    - `InteractionStatus.None` is the stable idle state. Any other value (Startup, Login, HandleRedirect, AcquireToken) means MSAL is mid-flow — do not render SignInPage during this period or it causes redirect loops.
    - `welcomeShownRef.current` prevents the welcome toast from re-appearing on subsequent renders after the first sign-in.
    - `sessionStorage.getItem('msal:justSignedIn')` is set by SignInPage before calling `loginRedirect()` so AuthGuard knows this is a post-redirect state, not just a cached session.
    - The welcome toast is a brief overlay, not a blocking page — it renders alongside children simultaneously.
    - `prefers-reduced-motion` is handled via CSS (no JS needed) — the toast fade-in will be instant when the media query is active.
  </action>
  <verify>Run `cd client && npx tsc --noEmit`. `AuthGuard.tsx` must compile without errors.</verify>
  <done>`client/src/auth/AuthGuard.tsx` exports `AuthGuard` component; TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Create SignInPage component and auth CSS additions</name>
  <files>client/src/auth/SignInPage.tsx, client/src/components/chat.css</files>
  <action>
    **Create `client/src/auth/SignInPage.tsx`:**

    ```typescript
    import { useMsal } from '@azure/msal-react';
    import { loginRequest } from './msalConfig.js';

    /**
     * Sign-in page shown to unauthenticated users.
     * Centered card using existing CSS design tokens — matches app visual identity.
     * No custom branding beyond the app name. Entra handles the actual login UI.
     *
     * Sign-in flow:
     * 1. Set sessionStorage flag so AuthGuard shows welcome toast after redirect
     * 2. Call instance.loginRedirect() — browser navigates to Entra login
     * 3. After user authenticates, Entra redirects back to VITE_AZURE_REDIRECT_URI
     * 4. MSAL processes the redirect hash, sets account in cache, inProgress → None
     * 5. AuthGuard sees isAuthenticated=true → renders children
     *
     * CAUTH-01, CAUTH-02
     */
    export function SignInPage() {
      const { instance } = useMsal();

      async function handleSignIn() {
        sessionStorage.setItem('msal:justSignedIn', 'true');
        await instance.loginRedirect(loginRequest);
      }

      return (
        <div className="signInLayout">
          <div className="signInCard">
            <h1 className="signInTitle">Copilot Chat</h1>
            <p className="signInSubtitle">Sign in to continue</p>
            <button
              type="button"
              className="signInButton"
              onClick={() => void handleSignIn()}
            >
              Sign in with Microsoft
            </button>
          </div>
        </div>
      );
    }
    ```

    **Add to `client/src/components/chat.css`** (append at end of file, do NOT replace existing styles):

    ```css
    /* ─────────────────────────────────────────────────────────────────────────────
       Auth UI — Sign-in page, auth check skeleton, welcome toast
       CAUTH-01, CAUTH-02, CAUTH-03
       ───────────────────────────────────────────────────────────────────────────── */

    /* Auth check layout — shows skeleton during MSAL init/redirect */
    .authCheckLayout {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: var(--color-bg);
    }

    /* Sign-in page — centered card */
    .signInLayout {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: var(--color-bg);
    }

    .signInCard {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: var(--space-5) 40px;
      text-align: center;
      max-width: 360px;
      width: 100%;
    }

    .signInTitle {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--color-text);
      margin: 0 0 var(--space-2) 0;
    }

    .signInSubtitle {
      font-size: var(--font-size-base);
      color: var(--color-text-muted);
      margin: 0 0 var(--space-5) 0;
    }

    .signInButton {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: var(--color-primary);
      color: var(--color-text-inverse);
      border: none;
      border-radius: 4px;
      padding: 10px 24px;
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      transition: background-color var(--transition-base);
    }

    .signInButton:hover {
      background-color: var(--color-primary-hover);
    }

    .signInButton:focus-visible {
      outline: 2px solid var(--color-focus-ring);
      outline-offset: 2px;
    }

    /* Welcome toast — brief notification after sign-in redirect */
    .welcomeToast {
      position: fixed;
      top: var(--space-4);
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: var(--space-2) var(--space-4);
      font-size: var(--font-size-sm);
      color: var(--color-text);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      z-index: 1000;
      animation: welcomeFadeIn 0.2s ease;
    }

    @keyframes welcomeFadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(-4px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* prefers-reduced-motion: disable fade animation per v1.0 accessibility pattern */
    @media (prefers-reduced-motion: reduce) {
      .welcomeToast {
        animation: none;
      }
    }
    ```
  </action>
  <verify>
    1. Run `cd client && npx tsc --noEmit` — must compile clean.
    2. Grep `client/src/components/chat.css` for `.signInLayout` — must exist.
    3. Grep `client/src/components/chat.css` for `.welcomeToast` — must exist.
    4. Grep `client/src/components/chat.css` for `prefers-reduced-motion` — the new rule for `.welcomeToast` must be present.
  </verify>
  <done>`client/src/auth/SignInPage.tsx` exports `SignInPage` with loginRedirect + sessionStorage flag; auth CSS classes added to `chat.css`; TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Wire AuthProvider and AuthGuard into App and main.tsx</name>
  <files>client/src/App.tsx, client/src/main.tsx</files>
  <action>
    **Update `client/src/App.tsx`** — wrap `ChatShell` in `AuthGuard`:

    ```typescript
    import { ChatShell } from './components/ChatShell.js';
    import { AuthGuard } from './auth/AuthGuard.js';

    export default function App() {
      return (
        <AuthGuard>
          <ChatShell />
        </AuthGuard>
      );
    }
    ```

    **Update `client/src/main.tsx`** — wrap `App` in `AuthProvider`:

    ```typescript
    import React from 'react';
    import ReactDOM from 'react-dom/client';
    import App from './App.js';
    import { AuthProvider } from './auth/AuthProvider.js';

    ReactDOM.createRoot(document.getElementById('root')!).render(
      <React.StrictMode>
        <AuthProvider>
          <App />
        </AuthProvider>
      </React.StrictMode>,
    );
    ```

    Component hierarchy after this change:
    ```
    React.StrictMode
    └─ AuthProvider (MsalProvider — binds msalInstance to context)
       └─ App
          └─ AuthGuard (reads MSAL state, renders skeleton/sign-in/children)
             └─ ChatShell (only rendered when authenticated)
    ```

    Important: `AuthProvider` must be the outermost wrapper so that `useMsal` in `AuthGuard` works. Do not place `AuthGuard` outside `AuthProvider`.
  </action>
  <verify>
    1. Run `cd client && npx tsc --noEmit` — must compile clean.
    2. Run `npm run build --workspace=client` — must build without errors.
    3. Grep `client/src/main.tsx` for `AuthProvider` — must be present wrapping App.
    4. Grep `client/src/App.tsx` for `AuthGuard` — must be present wrapping ChatShell.
  </verify>
  <done>`main.tsx` wraps App in `AuthProvider`; `App.tsx` wraps ChatShell in `AuthGuard`; client build succeeds without errors.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd client && npx tsc --noEmit` — full TypeScript check passes
2. `npm run build --workspace=client` — Vite build succeeds
3. Component tree: `AuthProvider > App > AuthGuard > ChatShell`
4. `client/src/auth/` directory contains: `msalConfig.ts`, `AuthProvider.tsx`, `AuthGuard.tsx`, `SignInPage.tsx`
5. `chat.css` contains `.signInLayout`, `.signInCard`, `.signInButton`, `.welcomeToast` classes
6. No MSAL imports exist outside `client/src/auth/` (encapsulated)
</verification>

<success_criteria>
- Unauthenticated state: `AuthGuard` renders `SignInPage` (not `ChatShell`)
- During MSAL init: `AuthGuard` renders `SkeletonBubble` layout (not blank screen or sign-in page)
- After redirect: sessionStorage flag triggers welcome toast for ~1200ms
- Authenticated state: `ChatShell` renders identically to v1.1 (CAUTH-03 no regression)
- `chat.css` respects `prefers-reduced-motion` for the welcome toast animation
- Client builds without errors: `npm run build --workspace=client`
</success_criteria>

<output>
After completion, create `.planning/phases/07-client-msal-authentication/07-02-SUMMARY.md`
</output>
