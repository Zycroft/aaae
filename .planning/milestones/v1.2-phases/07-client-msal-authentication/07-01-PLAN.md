---
phase: 07-client-msal-authentication
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - client/package.json
  - client/src/auth/msalConfig.ts
  - client/src/auth/AuthProvider.tsx
autonomous: true
requirements:
  - CAUTH-02
  - CAUTH-04

must_haves:
  truths:
    - "A PublicClientApplication instance exists and is configured for the CIAM tenant (ciamlogin.com authority)"
    - "VITE_AZURE_CLIENT_ID and VITE_AZURE_TENANT_NAME env vars drive the MSAL configuration"
    - "An AuthProvider component wraps children in MsalProvider, making MSAL hooks available app-wide"
  artifacts:
    - path: "client/src/auth/msalConfig.ts"
      provides: "MSAL PublicClientApplication singleton and scopes constant"
      exports: ["msalInstance", "loginRequest"]
    - path: "client/src/auth/AuthProvider.tsx"
      provides: "MsalProvider wrapper component"
      exports: ["AuthProvider"]
  key_links:
    - from: "client/src/auth/msalConfig.ts"
      to: "import.meta.env.VITE_AZURE_TENANT_NAME"
      via: "authority URL construction"
      pattern: "ciamlogin\\.com"
    - from: "client/src/auth/AuthProvider.tsx"
      to: "client/src/auth/msalConfig.ts"
      via: "imports msalInstance"
      pattern: "import.*msalInstance"
---

<objective>
Install MSAL libraries and create the foundational MSAL configuration and provider wrapper.

Purpose: Every MSAL hook (`useMsal`, `useIsAuthenticated`, `useMsalAuthentication`) requires a `MsalProvider` in the React tree. This plan installs the packages, creates the `PublicClientApplication` configured for Entra External ID (CIAM with `ciamlogin.com` authority), and exports a thin `AuthProvider` wrapper component.

Output: `client/src/auth/msalConfig.ts` (singleton + loginRequest), `client/src/auth/AuthProvider.tsx` (MsalProvider wrapper), `@azure/msal-browser` + `@azure/msal-react` installed.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-client-msal-authentication/07-CONTEXT.md
@client/package.json
@client/src/main.tsx
@client/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MSAL packages in client workspace</name>
  <files>client/package.json</files>
  <action>
    Run from the repo root:
    ```
    npm install --workspace=client @azure/msal-browser @azure/msal-react
    ```
    This adds both packages to `client/package.json` dependencies. `@azure/msal-browser` is the core MSAL library for SPAs (handles token cache, redirect, silent refresh). `@azure/msal-react` provides React hooks and the `MsalProvider` context component.

    Do NOT install these in the root or server workspace — they are browser-only and belong in client/.

    After install, confirm `client/package.json` lists both packages under `"dependencies"`.
  </action>
  <verify>Run `npm ls --workspace=client @azure/msal-browser @azure/msal-react` and confirm both appear without errors.</verify>
  <done>`client/package.json` contains `@azure/msal-browser` and `@azure/msal-react` as dependencies; `npm ls` shows both installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create MSAL configuration and PublicClientApplication singleton</name>
  <files>client/src/auth/msalConfig.ts</files>
  <action>
    Create `client/src/auth/msalConfig.ts` (create the `auth/` directory):

    ```typescript
    import { PublicClientApplication, type Configuration } from '@azure/msal-browser';

    /**
     * MSAL configuration for Entra External ID (CIAM).
     * Authority uses ciamlogin.com — NOT login.microsoftonline.com.
     * See STATE.md decision: CIAM authority URLs use ciamlogin.com.
     *
     * CAUTH-02, CAUTH-04
     */
    const tenantName = import.meta.env.VITE_AZURE_TENANT_NAME as string;
    const clientId = import.meta.env.VITE_AZURE_CLIENT_ID as string;
    const redirectUri = (import.meta.env.VITE_AZURE_REDIRECT_URI as string) || window.location.origin;

    const msalConfig: Configuration = {
      auth: {
        clientId,
        authority: `https://${tenantName}.ciamlogin.com/${tenantName}.onmicrosoft.com`,
        redirectUri,
        postLogoutRedirectUri: redirectUri,
        navigateToLoginRequestUrl: false,
      },
      cache: {
        cacheLocation: 'sessionStorage',
        storeAuthStateInCookie: false,
      },
    };

    /**
     * The API scopes to request. Adjust to match your server app registration's exposed API scope.
     * Format: api://{server-app-client-id}/{scope-name}
     * The token acquired with these scopes is the Bearer token sent to the Express server.
     */
    export const loginRequest = {
      scopes: [`api://${clientId}/access_as_user`],
    };

    /**
     * Singleton PublicClientApplication instance.
     * Created once; shared across the app via MsalProvider context.
     */
    export const msalInstance = new PublicClientApplication(msalConfig);
    ```

    Key decisions:
    - `cacheLocation: 'sessionStorage'` — tokens survive page reload within the tab but are cleared when the tab closes. Safer than localStorage for auth tokens. (Claude's discretion as per CONTEXT.md)
    - `storeAuthStateInCookie: false` — not needed for modern browsers
    - `navigateToLoginRequestUrl: false` — after redirect, go to the app root, not the URL that triggered login
    - Scopes use `api://{clientId}/access_as_user` convention — the server app registration exposes this scope; adjust if needed
    - `window.location.origin` fallback ensures redirectUri works even if env var is missing in development
  </action>
  <verify>Run `cd client && npx tsc --noEmit` and confirm `src/auth/msalConfig.ts` compiles without errors.</verify>
  <done>`client/src/auth/msalConfig.ts` exists, exports `msalInstance` (PublicClientApplication) and `loginRequest` (scopes object), TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Create AuthProvider wrapper component</name>
  <files>client/src/auth/AuthProvider.tsx</files>
  <action>
    Create `client/src/auth/AuthProvider.tsx`:

    ```typescript
    import { MsalProvider } from '@azure/msal-react';
    import { msalInstance } from './msalConfig.js';
    import type { ReactNode } from 'react';

    interface AuthProviderProps {
      children: ReactNode;
    }

    /**
     * Thin wrapper around MsalProvider that binds the singleton msalInstance.
     * Place this at the root of the React tree (wrapping App in main.tsx).
     * All MSAL hooks (useMsal, useIsAuthenticated, useMsalAuthentication) require
     * this provider to be an ancestor in the component tree.
     *
     * CAUTH-02, CAUTH-04
     */
    export function AuthProvider({ children }: AuthProviderProps) {
      return <MsalProvider instance={msalInstance}>{children}</MsalProvider>;
    }
    ```

    This is intentionally minimal — no auth logic here. Auth state management lives in AuthGuard (Plan 02). Separation of concerns: this file only binds the MSAL instance to React context.
  </action>
  <verify>Run `cd client && npx tsc --noEmit`. Both `msalConfig.ts` and `AuthProvider.tsx` must compile without errors.</verify>
  <done>`client/src/auth/AuthProvider.tsx` exists and exports `AuthProvider` component; TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm ls --workspace=client @azure/msal-browser @azure/msal-react` — both packages listed, no errors
2. `cd client && npx tsc --noEmit` — compiles clean
3. `client/src/auth/msalConfig.ts` exists and contains `ciamlogin.com` in the authority URL
4. `client/src/auth/AuthProvider.tsx` exists and exports `AuthProvider`
</verification>

<success_criteria>
- `@azure/msal-browser` and `@azure/msal-react` installed in client workspace
- `client/src/auth/msalConfig.ts` exports `msalInstance` (PublicClientApplication configured for CIAM) and `loginRequest` (scopes)
- `client/src/auth/AuthProvider.tsx` exports `AuthProvider` wrapping `MsalProvider`
- TypeScript compiles without errors across the client workspace
</success_criteria>

<output>
After completion, create `.planning/phases/07-client-msal-authentication/07-01-SUMMARY.md`
</output>
