---
phase: 09-context-injection-multi-turn-validation
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - server/src/routes/chat.ts
autonomous: true
requirements: [CTX-02]

must_haves:
  truths:
    - "When workflowContext is present on the request, the outbound Copilot message text is prefixed with a structured context block"
    - "When workflowContext is absent, the outbound Copilot message text is unchanged (no prefix, no empty prefix)"
    - "The user query appears verbatim after the context prefix — the prefix does not alter or replace the user query"
    - "Existing /api/chat/send behavior is intact for callers that do not supply workflowContext"
  artifacts:
    - path: "server/src/routes/chat.ts"
      provides: "buildContextPrefix helper + context injection in /send route"
      contains: "buildContextPrefix"
  key_links:
    - from: "server/src/routes/chat.ts (send handler)"
      to: "copilotClient.sendActivityStreaming"
      via: "userActivity.text = buildContextPrefix(workflowContext) + text"
      pattern: "buildContextPrefix"
---

<objective>
Implement context injection in the /api/chat/send route: when workflowContext is present in the request body, prepend it as a structured prefix to the outbound Copilot message text.

Purpose: The Copilot agent must receive workflow context (current step, constraints, collected data) alongside the user query so it can tailor its response. The prefix is a structured, human-readable block that the agent can parse.

Output: /api/chat/send reads workflowContext from the validated request and prepends a formatted prefix to the Activity text before calling sendActivityStreaming.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/09-context-injection-multi-turn-validation/09-01-SUMMARY.md
@server/src/routes/chat.ts
@shared/src/schemas/workflowContext.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement buildContextPrefix and inject into /send route</name>
  <files>server/src/routes/chat.ts</files>
  <action>
    Add a pure helper function `buildContextPrefix` immediately above the chatRouter definition in server/src/routes/chat.ts. The function signature:

    ```typescript
    function buildContextPrefix(ctx: WorkflowContext): string
    ```

    Import `WorkflowContext` (type-only) from `@copilot-chat/shared`.

    The prefix format (keep compact — minimizes token overhead):

    ```
    [WORKFLOW_CONTEXT]
    step: {ctx.step}
    constraints: {ctx.constraints?.join(' | ') ?? 'none'}
    data: {JSON.stringify(ctx.collectedData ?? {})}
    [/WORKFLOW_CONTEXT]

    ```

    Note the blank line after `[/WORKFLOW_CONTEXT]` — this visually separates context from the user message.

    In the /send route handler, after destructuring the parsed body, extract `workflowContext`:
    ```typescript
    const { conversationId, text, workflowContext } = parsed.data;
    ```

    Build the outbound text:
    ```typescript
    const outboundText = workflowContext
      ? buildContextPrefix(workflowContext) + text
      : text;
    ```

    Update the `userActivity` object to use `outboundText` instead of `text`:
    ```typescript
    const userActivity: Activity = {
      type: ActivityTypes.Message,
      text: outboundText,
    } as Activity;
    ```

    Do NOT change any other part of the route: conversation lookup, streaming call, normalizer, history update, or response remain identical.

    CONSTRAINT: Do NOT modify /start or /card-action routes — only /send.
  </action>
  <verify>
    1. `npm run build` from repo root completes without TypeScript errors
    2. `npm test` from repo root passes all existing tests
    3. Manual curl test (with AUTH_REQUIRED=false in server/.env for local test):
       - Send request without workflowContext → outboundText equals text (check logs or add temporary console.log)
       - Send request with workflowContext { step: "test" } → outboundText starts with "[WORKFLOW_CONTEXT]"
  </verify>
  <done>
    buildContextPrefix is exported or module-scoped in chat.ts. The /send route uses it when workflowContext is present. npm test passes. No changes to /start or /card-action.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes (TypeScript types from shared rebuild are consumed correctly)
- `npm test` passes all suites
- `buildContextPrefix({ step: "s1" })` produces expected prefix string (verifiable by adding a quick unit test or manual verification)
</verification>

<success_criteria>
The /api/chat/send route injects workflowContext as a structured prefix when provided. Callers without workflowContext are unaffected. All existing tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/09-context-injection-multi-turn-validation/09-02-SUMMARY.md`
</output>
