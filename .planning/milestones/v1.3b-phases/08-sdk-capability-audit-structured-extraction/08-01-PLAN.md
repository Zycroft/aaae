---
phase: 08-sdk-capability-audit-structured-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/schemas/extractedPayload.ts
  - shared/src/index.ts
autonomous: true
requirements:
  - SOUT-04

must_haves:
  truths:
    - "ExtractedPayload Zod schema exists in shared/ and rejects payloads missing required fields"
    - "ExtractedPayload type is exported from @copilot-chat/shared barrel"
    - "NormalizedMessage schema optionally accepts extractedPayload without breaking existing consumers"
  artifacts:
    - path: "shared/src/schemas/extractedPayload.ts"
      provides: "ExtractedPayload Zod schema with confidence enum and payload union"
      contains: "ExtractedPayloadSchema"
    - path: "shared/src/index.ts"
      provides: "Barrel export of ExtractedPayloadSchema and ExtractedPayload type"
      exports: ["ExtractedPayloadSchema", "ExtractedPayload"]
    - path: "shared/src/schemas/message.ts"
      provides: "NormalizedMessage extended with optional extractedPayload field"
      contains: "extractedPayload"
  key_links:
    - from: "shared/src/schemas/extractedPayload.ts"
      to: "shared/src/schemas/message.ts"
      via: "import ExtractedPayloadSchema, added as optional field"
      pattern: "extractedPayload.*optional"
    - from: "shared/src/index.ts"
      to: "shared/src/schemas/extractedPayload.ts"
      via: "barrel re-export"
      pattern: "ExtractedPayload"
---

<objective>
Define the ExtractedPayload Zod schema in shared/ — the single source of truth for structured data extracted from Copilot activity surfaces — and extend NormalizedMessage to carry it optionally.

Purpose: The normalizer (Plan 02) and future orchestrator code both need a typed, validated shape for extracted structured data. Defining it in shared/ first ensures both server and client can consume it without coupling.

Output: ExtractedPayloadSchema Zod schema, ExtractedPayload TypeScript type, NormalizedMessage updated with optional extractedPayload field, shared/ rebuilt and exported.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/src/schemas/message.ts
@shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExtractedPayload schema and extend NormalizedMessage</name>
  <files>
    shared/src/schemas/extractedPayload.ts
    shared/src/schemas/message.ts
    shared/src/index.ts
  </files>
  <action>
Create `shared/src/schemas/extractedPayload.ts` with the following Zod schema design:

```ts
import { z } from 'zod';

// Confidence levels: high = from activity.value (structured), medium = from activity.entities,
// low = parsed from bot text via regex/JSON.parse fallback
export const ExtractionConfidenceSchema = z.enum(['high', 'medium', 'low']);
export type ExtractionConfidence = z.infer<typeof ExtractionConfidenceSchema>;

export const ExtractedPayloadSchema = z.object({
  /** Where the data came from on the Activity */
  source: z.enum(['value', 'entities', 'text']),
  /** Confidence in the extraction: high (activity.value), medium (entities), low (text parse) */
  confidence: ExtractionConfidenceSchema,
  /** The extracted structured data — Record type, requires at least one key */
  data: z.record(z.string(), z.unknown()).refine(
    (d) => Object.keys(d).length > 0,
    { message: 'ExtractedPayload.data must contain at least one field' }
  ),
});

export type ExtractedPayload = z.infer<typeof ExtractedPayloadSchema>;
```

Then update `shared/src/schemas/message.ts`: import `ExtractedPayloadSchema` from `./extractedPayload.js` and add it as an optional field to `NormalizedMessageSchema`:

```ts
extractedPayload: ExtractedPayloadSchema.optional(),
```

Place it after `cardId` in the object. Add a JSDoc comment: `/** Structured data extracted from Copilot activity — present when the normalizer found parseable JSON (SOUT-04, SOUT-05) */`

Then update `shared/src/index.ts` to re-export:
```ts
export {
  ExtractedPayloadSchema,
  ExtractionConfidenceSchema,
  type ExtractedPayload,
  type ExtractionConfidence,
} from './schemas/extractedPayload.js';
```

Place it after the NormalizedMessage export block and before the UserClaims block.

IMPORTANT: shared/ uses Zod as its sole dependency. Do NOT add Zod to server/ or client/.
IMPORTANT: All import paths within shared/src/ use `.js` extensions (NodeNext module resolution).
IMPORTANT: The `data` refine keeps the schema strict — empty objects are invalid, preventing phantom extractions.
  </action>
  <verify>
Run from the repo root:
```bash
cd shared && npm run build
```
Build must succeed with zero TypeScript errors.

Then confirm the exports are present:
```bash
node -e "const s = require('./shared/dist/index.js'); console.log(typeof s.ExtractedPayloadSchema, typeof s.ExtractionConfidenceSchema);"
```
Should print: `object object`

Also confirm NormalizedMessageSchema accepts extractedPayload:
```bash
node -e "
const { NormalizedMessageSchema, ExtractedPayloadSchema } = require('./shared/dist/index.js');
const msg = { id: '00000000-0000-0000-0000-000000000001', role: 'assistant', kind: 'text', text: 'hi',
  extractedPayload: { source: 'value', confidence: 'high', data: { foo: 'bar' } } };
console.log(NormalizedMessageSchema.parse(msg));
"
```
Should parse without throwing.

Confirm rejection of empty data:
```bash
node -e "
const { ExtractedPayloadSchema } = require('./shared/dist/index.js');
try { ExtractedPayloadSchema.parse({ source: 'value', confidence: 'high', data: {} }); } catch(e) { console.log('REJECTED:', e.errors[0].message); }
"
```
Should print: `REJECTED: ExtractedPayload.data must contain at least one field`
  </verify>
  <done>
- shared/src/schemas/extractedPayload.ts exists with ExtractedPayloadSchema and ExtractionConfidenceSchema
- NormalizedMessageSchema has optional extractedPayload field referencing ExtractedPayloadSchema
- ExtractedPayloadSchema, ExtractionConfidenceSchema, ExtractedPayload, ExtractionConfidence all exported from shared/src/index.ts
- `cd shared && npm run build` exits 0
- ExtractedPayload with empty data is rejected at runtime
- NormalizedMessage with valid extractedPayload parses without error
  </done>
</task>

</tasks>

<verification>
After task completion:
1. `cd shared && npm run build` — zero errors
2. `npm test` from repo root — all existing tests pass (shared and server)
3. NormalizedMessageSchema.parse() accepts message with valid extractedPayload
4. ExtractedPayloadSchema.parse() rejects empty data object
</verification>

<success_criteria>
ExtractedPayload Zod schema is in shared/, exported from the barrel, and NormalizedMessage is extended with an optional extractedPayload field. Existing tests continue to pass. No breaking changes to any existing schema consumer.
</success_criteria>

<output>
After completion, create `.planning/phases/08-sdk-capability-audit-structured-extraction/08-01-SUMMARY.md`
</output>
