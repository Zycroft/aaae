---
phase: 08-sdk-capability-audit-structured-extraction
plan: 02
type: tdd
wave: 2
depends_on:
  - "08-01"
files_modified:
  - server/src/normalizer/activityNormalizer.ts
  - server/src/normalizer/activityNormalizer.test.ts
autonomous: true
requirements:
  - SOUT-01
  - SOUT-02
  - SOUT-03
  - SOUT-05
  - SOUT-06

must_haves:
  truths:
    - "When a Copilot activity has a non-null activity.value that is an object, NormalizedMessage.extractedPayload is populated with source='value' and confidence='high'"
    - "When a Copilot activity has activity.entities with structured data, NormalizedMessage.extractedPayload is populated with source='entities' and confidence='medium'"
    - "When bot text contains embedded JSON (wrapped in code fences or bare), the normalizer parses it out and populates extractedPayload with source='text' and confidence='low'"
    - "When none of the above conditions are met, extractedPayload is undefined (no phantom extractions)"
    - "All pre-existing normalizer unit tests (text, card, hybrid) continue to pass after the extension"
  artifacts:
    - path: "server/src/normalizer/activityNormalizer.ts"
      provides: "Extended normalizer with extractStructuredPayload helper extracting from value/entities/text"
      contains: "extractStructuredPayload"
    - path: "server/src/normalizer/activityNormalizer.test.ts"
      provides: "TDD tests covering all three extraction surfaces plus non-extraction cases"
      min_lines: 260
  key_links:
    - from: "server/src/normalizer/activityNormalizer.ts"
      to: "@copilot-chat/shared"
      via: "import ExtractedPayload, ExtractionConfidence types"
      pattern: "ExtractedPayload|ExtractionConfidence"
    - from: "server/src/normalizer/activityNormalizer.ts"
      to: "activity.value"
      via: "extractStructuredPayload checks activity.value first"
      pattern: "activity\\.value"
    - from: "server/src/normalizer/activityNormalizer.ts"
      to: "activity.entities"
      via: "extractStructuredPayload checks activity.entities second"
      pattern: "activity\\.entities"
---

<objective>
Extend activityNormalizer.ts to extract structured JSON payloads from three Copilot activity surfaces (activity.value, activity.entities, bot text) using TDD — RED→GREEN→REFACTOR — and ensure all pre-existing tests continue to pass.

Purpose: This is the core extraction engine for orchestrator readiness. Structured data from Copilot must be reliably extracted and confidence-rated so callers can trust what they receive.

Output: Extended normalizer with extractStructuredPayload helper, new test cases covering all three extraction surfaces, all 15+ existing tests still green.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/normalizer/activityNormalizer.ts
@server/src/normalizer/activityNormalizer.test.ts
@.planning/phases/08-sdk-capability-audit-structured-extraction/08-01-SUMMARY.md
</context>

<feature>
  <name>Structured payload extraction in activityNormalizer</name>
  <files>
    server/src/normalizer/activityNormalizer.ts
    server/src/normalizer/activityNormalizer.test.ts
  </files>
  <behavior>
Extraction priority order (highest confidence first):

1. **activity.value** (SOUT-01, confidence: 'high')
   - If `activity.value` is a non-null plain object (not array, not primitive), extract it
   - Return: `{ source: 'value', confidence: 'high', data: activity.value as Record<string, unknown> }`
   - Skip if activity.value is null, undefined, a string, number, or array

2. **activity.entities** (SOUT-02, confidence: 'medium')
   - If `activity.entities` is a non-empty array, merge all entity objects into one data record
   - For each entity object in the array, spread its enumerable properties into data (omit the `type` key to avoid noise)
   - Only extract if the merged result has at least one key (after omitting `type`)
   - Return: `{ source: 'entities', confidence: 'medium', data: mergedEntityData }`
   - Only checked if activity.value extraction did NOT produce a result

3. **bot text JSON parse** (SOUT-03, confidence: 'low')
   - Only for bot (role='assistant') messages
   - Check if activity.text contains a JSON object or array:
     a. Try stripping markdown code fences: ```json ... ``` or ``` ... ```
     b. Try finding a raw JSON object: first `{` to matching `}` (simple regex: `/\{[\s\S]*\}/`)
   - Attempt `JSON.parse()` on extracted substring
   - If parse succeeds AND result is a non-null object (not array, not primitive), extract it
   - Return: `{ source: 'text', confidence: 'low', data: parsed as Record<string, unknown> }`
   - Only checked if neither value nor entities extraction produced a result
   - Do NOT extract from user messages — only bot (from.role === 'bot')

Cases (input → expected output):
- `activity.value = { step: 'greeting', score: 0.9 }` → extractedPayload with source='value', confidence='high', data has step and score
- `activity.value = null` → no extraction (undefined)
- `activity.value = "string"` → no extraction (not an object)
- `activity.value = [1, 2]` → no extraction (arrays not extracted from value)
- `activity.entities = [{ type: 'clientInfo', locale: 'en-US' }]` → extractedPayload source='entities', confidence='medium', data has locale (type omitted)
- `activity.entities = []` → no extraction
- bot text `"Here is your result:\n```json\n{\"status\":\"ok\"}\n```"` → extractedPayload source='text', confidence='low', data has status
- bot text `"Result: {\"foo\":\"bar\"}"` → extractedPayload source='text', confidence='low'
- bot text `"Just a plain message"` → no extraction
- user text with JSON → no extraction (only bot messages)
- activity.value present + entities present → value wins (high confidence)
  </behavior>
  <implementation>
Add a private `extractStructuredPayload(activity: Activity, role: 'user' | 'assistant'): ExtractedPayload | undefined` helper function above `normalizeActivities`.

Import `type ExtractedPayload` from `@copilot-chat/shared`.

In `normalizeActivities`, call `extractStructuredPayload(activity, role)` once per activity (after determining role), and pass the result into each NormalizedMessage produced from that activity.

Update the `NormalizedMessage` object construction for both text and card messages:
```ts
const textMsg: NormalizedMessage = {
  id: uuidv4(),
  role,
  kind: 'text',
  text: activity.text,
  ...(extractedPayload !== undefined ? { extractedPayload } : {}),
};
```

The extractedPayload (if any) is the same for all messages from a single activity — both the text message and card message produced by a hybrid turn carry it.

Do NOT mutate the Activity — read only.

After implementation, run `npm run build` in server/ to confirm TypeScript compiles.
  </implementation>
</feature>

<verification>
Run the full test suite after RED→GREEN→REFACTOR cycle:

```bash
cd server && npm test
```

All tests must pass — both the 15+ pre-existing tests and the new extraction tests.

Also verify from repo root:
```bash
npm test
```

No regressions across shared/ or client/ (client tests use Jest).
</verification>

<success_criteria>
- `extractStructuredPayload` helper extracts from activity.value (SOUT-01), activity.entities (SOUT-02), and bot text JSON (SOUT-03)
- All three extraction surfaces produce `ExtractedPayload` with correct source and confidence level (SOUT-04 via schema parse in tests)
- `extractedPayload` is set on NormalizedMessage when extraction succeeds (SOUT-05)
- All pre-existing normalizer tests pass without modification (SOUT-06)
- New extraction tests cover happy path + edge cases for all three surfaces
- `cd server && npm test` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/08-sdk-capability-audit-structured-extraction/08-02-SUMMARY.md`
</output>
