---
phase: 24-copilotprovider-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/provider/CopilotProvider.ts
  - server/src/provider/CopilotProvider.test.ts
autonomous: true
requirements: [PROV-02, COMPAT-03]

must_haves:
  truths:
    - "CopilotProvider implements LlmProvider interface with all three methods"
    - "CopilotProvider.startSession calls copilotClient.startConversationStreaming and returns NormalizedMessage[]"
    - "CopilotProvider.sendMessage calls copilotClient.sendActivityStreaming and normalizes response via activityNormalizer"
    - "CopilotProvider.sendCardAction calls copilotClient.sendActivityStreaming with card action activity and normalizes response"
    - "copilot.ts, activityNormalizer.ts, and structuredOutputParser.ts are byte-for-byte unchanged"
    - "All pre-existing server tests pass with zero changes to existing test files"
  artifacts:
    - path: "server/src/provider/CopilotProvider.ts"
      provides: "CopilotProvider class implementing LlmProvider"
      exports: ["CopilotProvider"]
    - path: "server/src/provider/CopilotProvider.test.ts"
      provides: "Unit tests for CopilotProvider"
  key_links:
    - from: "server/src/provider/CopilotProvider.ts"
      to: "server/src/provider/LlmProvider.ts"
      via: "implements LlmProvider"
      pattern: "implements LlmProvider"
    - from: "server/src/provider/CopilotProvider.ts"
      to: "server/src/copilot.ts"
      via: "imports copilotClient singleton"
      pattern: "import.*copilotClient.*copilot"
    - from: "server/src/provider/CopilotProvider.ts"
      to: "server/src/normalizer/activityNormalizer.ts"
      via: "imports normalizeActivities"
      pattern: "import.*normalizeActivities.*activityNormalizer"
---

<objective>
Create `CopilotProvider` class that wraps the existing `CopilotStudioClient` singleton behind the `LlmProvider` interface. This is a pure extraction — all Copilot-specific SDK interaction logic is delegated to existing modules (`copilot.ts`, `activityNormalizer.ts`). Zero behavioral change.

Purpose: Enable the orchestrator (Phase 25) to depend on `LlmProvider` instead of `CopilotStudioClient` directly, making the backend swappable.
Output: `CopilotProvider` class + unit tests in `server/src/provider/`
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/provider/LlmProvider.ts
@server/src/copilot.ts
@server/src/normalizer/activityNormalizer.ts
@server/src/orchestrator/WorkflowOrchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CopilotProvider class implementing LlmProvider</name>
  <files>server/src/provider/CopilotProvider.ts</files>
  <action>
Create `server/src/provider/CopilotProvider.ts` that implements the `LlmProvider` interface from `./LlmProvider.ts`.

**Constructor:** Accept a `CopilotStudioClient` instance as a dependency (constructor injection for testability). Do NOT import the singleton directly — the caller passes it in.

**Method implementations:**

1. `startSession(conversationId: string): Promise<NormalizedMessage[]>`
   - Call `this.client.startConversationStreaming(true)` and collect all Activity objects via `for await`
   - Pass collected activities through `normalizeActivities()` from `../normalizer/activityNormalizer.js`
   - Return the `NormalizedMessage[]`
   - Note: `conversationId` is accepted per the interface but not used by Copilot SDK (SDK manages its own conversation state internally)

2. `sendMessage(conversationId: string, message: string): Promise<NormalizedMessage[]>`
   - Build an Activity: `{ type: ActivityTypes.Message, text: message }`
   - Call `this.client.sendActivityStreaming(activity)` and collect all responses via `for await`
   - Pass collected activities through `normalizeActivities()`
   - Return the `NormalizedMessage[]`

3. `sendCardAction(conversationId: string, actionValue: Record<string, unknown>): Promise<NormalizedMessage[]>`
   - Build an Activity: `{ type: ActivityTypes.Message, text: '', value: actionValue }`
   - Call `this.client.sendActivityStreaming(activity)` and collect all responses via `for await`
   - Pass collected activities through `normalizeActivities()`
   - Return the `NormalizedMessage[]`

**Imports:**
- `Activity`, `ActivityTypes` from `@microsoft/agents-activity`
- `CopilotStudioClient` type from `@microsoft/agents-copilotstudio-client`
- `NormalizedMessage` type from `@copilot-chat/shared`
- `LlmProvider` from `./LlmProvider.js`
- `normalizeActivities` from `../normalizer/activityNormalizer.js`

**CRITICAL CONSTRAINTS:**
- Do NOT modify `copilot.ts` — it stays byte-for-byte unchanged
- Do NOT modify `activityNormalizer.ts` — import and call it as-is
- Do NOT modify `structuredOutputParser.ts` — it is not needed here (parsing is orchestrator-level concern)
- The provider only handles SDK communication + normalization. Context enrichment, state management, and structured parsing remain in the orchestrator.
  </action>
  <verify>
    <automated>cd /Users/zycroft/Documents/PA/aaae && npx tsc --noEmit --project server/tsconfig.json 2>&1 | head -20</automated>
    <manual>Verify CopilotProvider.ts exists in server/src/provider/ and implements all three LlmProvider methods</manual>
  </verify>
  <done>CopilotProvider class exists in server/src/provider/, implements LlmProvider with startSession, sendMessage, and sendCardAction methods that delegate to CopilotStudioClient and normalizeActivities</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for CopilotProvider</name>
  <files>server/src/provider/CopilotProvider.test.ts</files>
  <action>
Create `server/src/provider/CopilotProvider.test.ts` with Vitest unit tests.

**Test setup:**
- Mock `CopilotStudioClient` — create a mock object with `startConversationStreaming` and `sendActivityStreaming` methods that return async iterables
- Use `vi.mock('../normalizer/activityNormalizer.js')` to mock `normalizeActivities` — control what NormalizedMessage[] it returns
- Create helper: `mockAsyncIterable(items: Activity[])` that returns an async generator yielding each item

**Test cases:**

1. `startSession — collects streaming activities and normalizes`
   - Mock `startConversationStreaming` to yield 2 activities
   - Mock `normalizeActivities` to return `[{ id: '1', role: 'assistant', kind: 'text', text: 'Hello' }]`
   - Call `provider.startSession('conv-1')`
   - Assert `startConversationStreaming` called with `true`
   - Assert `normalizeActivities` called with the 2 collected activities
   - Assert return value matches mock output

2. `sendMessage — builds activity and normalizes response`
   - Mock `sendActivityStreaming` to yield 1 activity
   - Mock `normalizeActivities` to return a text message
   - Call `provider.sendMessage('conv-1', 'Hello')`
   - Assert `sendActivityStreaming` called with activity where `type === 'message'` and `text === 'Hello'`
   - Assert return value matches mock output

3. `sendCardAction — builds card action activity and normalizes response`
   - Mock `sendActivityStreaming` to yield 1 activity
   - Mock `normalizeActivities` to return a text message
   - Call `provider.sendCardAction('conv-1', { action: 'submit', data: { key: 'value' } })`
   - Assert `sendActivityStreaming` called with activity where `value` contains the action data
   - Assert return value matches mock output

4. `startSession — returns empty array when no activities`
   - Mock `startConversationStreaming` to yield nothing
   - Mock `normalizeActivities` to return `[]`
   - Assert empty array returned

**After tests pass, verify unchanged files:**
- Run `git diff server/src/copilot.ts` — must show no changes
- Run `git diff server/src/normalizer/activityNormalizer.ts` — must show no changes
- Run `git diff server/src/parser/structuredOutputParser.ts` — must show no changes

**Run full test suite** to confirm zero regressions.
  </action>
  <verify>
    <automated>cd /Users/zycroft/Documents/PA/aaae && npx vitest run server/src/provider/CopilotProvider.test.ts --reporter=verbose 2>&1 | tail -30</automated>
    <manual>All 4 test cases pass. git diff confirms copilot.ts, activityNormalizer.ts, structuredOutputParser.ts are unchanged.</manual>
  </verify>
  <done>CopilotProvider has 4 passing unit tests covering all three interface methods plus empty response edge case. All pre-existing server tests pass. Protected files are byte-for-byte unchanged.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit --project server/tsconfig.json` — TypeScript compiles cleanly
2. `npx vitest run server/src/provider/CopilotProvider.test.ts` — all new tests pass
3. `npx vitest run` (full server suite) — all pre-existing tests pass, zero regressions
4. `git diff server/src/copilot.ts server/src/normalizer/activityNormalizer.ts server/src/parser/structuredOutputParser.ts` — empty (no changes)
5. `CopilotProvider` class exists in `server/src/provider/` and `implements LlmProvider`
</verification>

<success_criteria>
- CopilotProvider class in server/src/provider/CopilotProvider.ts implements LlmProvider
- All three methods (startSession, sendMessage, sendCardAction) delegate to CopilotStudioClient + normalizeActivities
- 4 unit tests pass covering all methods
- All 173+ pre-existing server tests pass unchanged
- copilot.ts, activityNormalizer.ts, structuredOutputParser.ts are byte-for-byte unchanged (verified by git diff)
</success_criteria>

<output>
After completion, create `.planning/phases/24-copilotprovider-extraction/24-01-SUMMARY.md`
</output>
