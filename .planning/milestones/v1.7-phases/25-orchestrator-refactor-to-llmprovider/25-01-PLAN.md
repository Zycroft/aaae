---
phase: 25-orchestrator-refactor-to-llmprovider
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/orchestrator/WorkflowOrchestrator.ts
  - server/src/orchestrator/index.ts
  - server/src/orchestrator/WorkflowOrchestrator.test.ts
  - server/src/orchestrator/WorkflowOrchestrator.integration.test.ts
autonomous: true
requirements: [PROV-03, COMPAT-01]

must_haves:
  truths:
    - "WorkflowOrchestrator.ts has zero imports from @microsoft/agents-copilotstudio-client or @microsoft/agents-activity"
    - "All 151 existing server tests pass without modification to test assertions"
    - "A conversation started with LLM_PROVIDER=copilot produces identical responses to pre-refactor baseline"
  artifacts:
    - path: "server/src/orchestrator/WorkflowOrchestrator.ts"
      provides: "Orchestrator that accepts LlmProvider, not CopilotStudioClient"
      contains: "LlmProvider"
    - path: "server/src/orchestrator/index.ts"
      provides: "Singleton wiring via CopilotProvider(copilotClient)"
      contains: "CopilotProvider"
  key_links:
    - from: "server/src/orchestrator/WorkflowOrchestrator.ts"
      to: "server/src/provider/LlmProvider.ts"
      via: "import type { LlmProvider }"
      pattern: "import.*LlmProvider"
    - from: "server/src/orchestrator/index.ts"
      to: "server/src/provider/CopilotProvider.ts"
      via: "new CopilotProvider(copilotClient)"
      pattern: "new CopilotProvider"
---

<objective>
Refactor WorkflowOrchestrator to depend on LlmProvider interface instead of CopilotStudioClient directly. Replace all Copilot SDK usage (Activity, ActivityTypes, CopilotStudioClient) in the orchestrator with calls to the LlmProvider interface methods. Update the singleton wiring to construct a CopilotProvider and inject it. Update test files to mock LlmProvider instead of CopilotStudioClient.

Purpose: Dependency inversion — the orchestrator becomes backend-agnostic, enabling future providers (OpenAI, etc.) without touching orchestrator code.
Output: WorkflowOrchestrator with zero Copilot SDK imports, wired via CopilotProvider, all tests green.
</objective>

<execution_context>
@/Users/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/Users/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-copilotprovider-extraction/24-01-SUMMARY.md
@server/src/orchestrator/WorkflowOrchestrator.ts
@server/src/orchestrator/index.ts
@server/src/orchestrator/types.ts
@server/src/provider/LlmProvider.ts
@server/src/provider/CopilotProvider.ts
@server/src/copilot.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor WorkflowOrchestrator to use LlmProvider instead of CopilotStudioClient</name>
  <files>server/src/orchestrator/WorkflowOrchestrator.ts, server/src/orchestrator/index.ts</files>
  <action>
  **WorkflowOrchestrator.ts — Replace Copilot SDK with LlmProvider:**

  1. Remove ALL imports from `@microsoft/agents-copilotstudio-client` and `@microsoft/agents-activity` (Activity, ActivityTypes, CopilotStudioClient).

  2. Add import: `import type { LlmProvider } from '../provider/LlmProvider.js';`

  3. Change the constructor dependency from `copilotClient: CopilotStudioClient` to `llmProvider: LlmProvider`. Update the private field accordingly: `private readonly llmProvider: LlmProvider`.

  4. **startSession method** — Replace the manual SDK streaming loop:
     ```typescript
     // OLD: Direct SDK calls with Activity streaming
     const startActivities: Activity[] = [];
     for await (const activity of this.copilotClient.startConversationStreaming(true)) {
       startActivities.push(activity);
     }
     ```
     With a single LlmProvider call:
     ```typescript
     const greetingMessages = await this.llmProvider.startSession(conversationId);
     ```
     Update the conversation record creation to store `greetingMessages` as `sdkConversationRef` (the type is `unknown[]` in the store, so NormalizedMessage[] is compatible).

  5. **processTurn method** — Replace the SDK Activity construction and streaming:
     - Remove Activity construction (`{ type: ActivityTypes.Message, text: query } as Activity`)
     - Remove the streaming loop (`for await (const activity of this.copilotClient.sendActivityStreaming(userActivity))`)
     - Remove the `normalizeActivities(collectedActivities)` call
     - Replace with: `const messages = await this.llmProvider.sendMessage(conversationId, query);`
     - The `parseTurn`, data merging, state update, and progress computation remain unchanged (they operate on `NormalizedMessage[]` which is what LlmProvider returns).

  6. **processCardAction method** — Replace the SDK Activity construction and streaming:
     - Remove the manual `cardActivity` construction with `ActivityTypes.Message` and value spreading
     - Remove the streaming loop and normalizeActivities call
     - The current code builds: `{ type: ActivityTypes.Message, text: userSummary, value: { ...submitData, cardId } }`
     - Replace with: `const messages = await this.llmProvider.sendCardAction(conversationId, { ...submitData, cardId });`
     - NOTE: The `userSummary` field is NOT passed to CopilotProvider.sendCardAction (which takes actionValue only). This matches the existing CopilotProvider behavior where sendCardAction sends `text: ''`. The orchestrator's processCardAction previously set `text: userSummary` on the activity, but the CopilotProvider abstraction uses empty text for card actions. To maintain behavioral compatibility, include the userSummary in the actionValue: `{ ...submitData, cardId, _userSummary: userSummary }` — OR simply pass `{ ...submitData, cardId }` since the CopilotProvider already ignores the text. Use the simpler approach: just pass `{ ...submitData, cardId }`.

  7. Remove the `normalizeActivities` import since the orchestrator no longer normalizes directly.

  8. Keep the `parseTurn` import — the orchestrator still parses NormalizedMessage[] for structured output extraction.

  **orchestrator/index.ts — Wire CopilotProvider:**

  1. Replace `import { copilotClient } from '../copilot.js'` with:
     ```typescript
     import { copilotClient } from '../copilot.js';
     import { CopilotProvider } from '../provider/CopilotProvider.js';
     ```

  2. Create a CopilotProvider instance: `const copilotProvider = new CopilotProvider(copilotClient);`

  3. Change the singleton orchestrator construction from `copilotClient` to `llmProvider: copilotProvider`:
     ```typescript
     export const orchestrator = new WorkflowOrchestrator({
       workflowStore: workflowStateStore,
       conversationStore,
       llmProvider: copilotProvider,
       lock: conversationLock,
       config: { workflowDefinition: DEFAULT_WORKFLOW_DEFINITION },
     });
     ```
  </action>
  <verify>
    <automated>cd /Users/zycroft/Documents/PA/aaae && grep -c "@microsoft/agents" server/src/orchestrator/WorkflowOrchestrator.ts | grep "^0$" && npx --prefix server vitest run --reporter=verbose 2>&1 | tail -5</automated>
    <manual>Confirm WorkflowOrchestrator.ts contains zero imports from @microsoft/agents-*</manual>
  </verify>
  <done>WorkflowOrchestrator.ts has zero Copilot SDK imports. Constructor accepts LlmProvider. All three methods delegate to LlmProvider. Index.ts wires CopilotProvider(copilotClient) as the LlmProvider.</done>
</task>

<task type="auto">
  <name>Task 2: Update test files to mock LlmProvider instead of CopilotStudioClient</name>
  <files>server/src/orchestrator/WorkflowOrchestrator.test.ts, server/src/orchestrator/WorkflowOrchestrator.integration.test.ts</files>
  <action>
  **WorkflowOrchestrator.test.ts:**

  1. Remove imports: `import type { Activity } from '@microsoft/agents-activity'` and `import type { CopilotStudioClient } from '@microsoft/agents-copilotstudio-client'`.

  2. Add import: `import type { LlmProvider } from '../provider/LlmProvider.js'`.

  3. Remove the `botActivity()` helper and `mockStream()` helper — they created raw SDK Activity objects. They are no longer needed since LlmProvider returns NormalizedMessage[] directly.

  4. Create a helper that produces NormalizedMessage[] instead:
     ```typescript
     import type { NormalizedMessage } from '@copilot-chat/shared';
     import { v4 as uuidv4 } from 'uuid';

     function textMessage(text: string, extractedPayload?: Record<string, unknown>): NormalizedMessage {
       return {
         id: uuidv4(),
         role: 'assistant' as const,
         kind: 'text' as const,
         text,
         ...(extractedPayload ? { extractedPayload } : {}),
       };
     }
     ```

  5. Replace `mockCopilotClient` with `mockLlmProvider`:
     ```typescript
     let mockLlmProvider: {
       startSession: ReturnType<typeof vi.fn>;
       sendMessage: ReturnType<typeof vi.fn>;
       sendCardAction: ReturnType<typeof vi.fn>;
     };
     ```

  6. In beforeEach, initialize:
     ```typescript
     mockLlmProvider = {
       startSession: vi.fn().mockResolvedValue([textMessage('Welcome!')]),
       sendMessage: vi.fn().mockResolvedValue([textMessage('Got it.')]),
       sendCardAction: vi.fn().mockResolvedValue([textMessage('Got it.')]),
     };
     ```

  7. Update orchestrator construction: replace `copilotClient: mockCopilotClient as unknown as CopilotStudioClient` with `llmProvider: mockLlmProvider as unknown as LlmProvider`.

  8. Update each test's assertions:
     - Tests checking `mockCopilotClient.sendActivityStreaming` → check `mockLlmProvider.sendMessage` or `mockLlmProvider.sendCardAction`
     - Tests that set return values on `sendActivityStreaming.mockReturnValue(mockStream([botActivity(...)]))` → use `sendMessage.mockResolvedValue([textMessage(...)])`
     - For structured responses with `value` field (e.g., `botActivity('Here you go', { action: 'ask', data: { age: 30 } })`), create messages WITH extractedPayload:
       ```typescript
       textMessage('Here you go', { action: 'ask', data: { age: 30 }, prompt: 'What is your age?' })
       ```
       Note: The `parseTurn` function looks for `extractedPayload` on NormalizedMessage objects. Previously the Activity normalizer would put `activity.value` into `extractedPayload`. Now LlmProvider returns already-normalized messages, so set `extractedPayload` directly on the mock messages.
     - Test 3 (context enrichment): Previously checked `sentActivity.text` on the Activity sent to copilot. Now check that `mockLlmProvider.sendMessage` was called with the enriched query string as the second argument:
       ```typescript
       const sentQuery = mockLlmProvider.sendMessage.mock.calls[0][1] as string;
       expect(sentQuery).toContain('Phase:');
       expect(sentQuery).toContain('"name":"Alice"');
       ```
     - Test 6 (processCardAction): Previously checked Activity value/text. Now check `mockLlmProvider.sendCardAction` was called with `(CONV_ID, { choice: 'A', cardId: 'card-1' })`.
     - Test 7 (rollback): Change `sendActivityStreaming.mockImplementation` to `sendMessage.mockRejectedValue(new Error('Copilot timeout'))`.
     - Test 8 (lock ordering): Change `sendActivityStreaming.mockReturnValue` to `sendMessage.mockResolvedValue([textMessage('OK')])`.

  **WorkflowOrchestrator.integration.test.ts:**

  Apply the same pattern:
  1. Remove `Activity`, `CopilotStudioClient` imports.
  2. Add `LlmProvider` and `NormalizedMessage` imports.
  3. Remove `botActivity` and `mockStream` helpers, add `textMessage` helper.
  4. Replace `mockCopilotClient` with `mockLlmProvider`.
  5. Update orchestrator construction.
  6. Update all mock return values from `mockReturnValue(mockStream([botActivity(...)]))` to `mockResolvedValue([textMessage(...)])`.
  7. For structured responses, set `extractedPayload` on the NormalizedMessage mock.
  8. For preamble verification tests, check `mockLlmProvider.sendMessage.mock.calls[N][1]` instead of `sentActivity.text`.
  </action>
  <verify>
    <automated>cd /Users/zycroft/Documents/PA/aaae && npx --prefix server vitest run --reporter=verbose 2>&1 | tail -20</automated>
  </verify>
  <done>All test files mock LlmProvider instead of CopilotStudioClient. Zero imports from @microsoft/agents-* in any orchestrator file. All 151+ server tests pass.</done>
</task>

</tasks>

<verification>
1. `grep -r "@microsoft/agents" server/src/orchestrator/` returns zero matches — no Copilot SDK references in orchestrator directory
2. `npx --prefix server vitest run` — all existing tests pass (151+ tests)
3. `grep "LlmProvider" server/src/orchestrator/WorkflowOrchestrator.ts` — confirms LlmProvider is the dependency
4. `grep "CopilotProvider" server/src/orchestrator/index.ts` — confirms CopilotProvider wiring
</verification>

<success_criteria>
- WorkflowOrchestrator.ts contains zero imports from @microsoft/agents-copilotstudio-client
- WorkflowOrchestrator.ts contains zero imports from @microsoft/agents-activity
- All 151+ existing server tests pass with zero assertion changes
- orchestrator/index.ts creates CopilotProvider(copilotClient) and passes as LlmProvider
- processTurn delegates to llmProvider.sendMessage()
- processCardAction delegates to llmProvider.sendCardAction()
- startSession delegates to llmProvider.startSession()
- PROV-03 fulfilled: orchestrator depends on interface only
- COMPAT-01 fulfilled: copilot path behavior identical via CopilotProvider adapter
</success_criteria>

<output>
After completion, create `.planning/phases/25-orchestrator-refactor-to-llmprovider/25-01-SUMMARY.md`
</output>
