# v1.3b Milestone — Copilot Studio SDK: Orchestrator Readiness

## Priority: P1 (Architecture gate — unblocks v1.5 Workflow Orchestrator)

## Decision Record

**Channel selection: Copilot Studio SDK (`@microsoft/agents-copilotstudio-client`)**

The v1.3 spike evaluated Direct Line vs the Copilot Studio SDK. The SDK path has been selected. Direct Line is not pursued. Rationale:

- SDK already integrated and proven in v1.0/v1.1
- SDK handles token management internally (no 30-min Direct Line token refresh cycle)
- SDK is the canonical Microsoft-supported path for Copilot Studio agents
- Reduced maintenance burden outweighs lower-level control offered by Direct Line
- Multi-bot support is not a current requirement

This milestone formalizes the SDK-only path and closes all gaps between the current SDK integration and what the v1.5 Workflow Orchestrator requires.

---

## Gap Analysis

### Current SDK Capabilities (v1.1 baseline)

| Capability | Status | Location |
|-----------|--------|----------|
| Start conversation → conversationId | ✓ Exists | `server/src/routes/chat.ts` |
| Send text message → Activity[] | ✓ Exists | `server/src/routes/chat.ts` |
| Activity[] → NormalizedMessage[] (text/card/hybrid) | ✓ Exists | `server/src/normalizer/activityNormalizer.ts` |
| Card action forwarding | ✓ Exists | `server/src/routes/chat.ts` |
| Conversation store (conversationId only) | ✓ Exists | `server/src/store/InMemoryStore.ts` |
| Structured JSON extraction from `activity.value` | ✗ Missing | — |
| Structured JSON extraction from `activity.entities` | ✗ Missing | — |
| Embedded JSON parsing from text responses | ✗ Missing | — |
| Extracted payload Zod schema + validation | ✗ Missing | — |
| Context/constraint injection into outbound messages | ✗ Missing | — |
| Workflow state beyond conversationId | ✗ Missing | — |
| Multi-turn state persistence (step, data, recommendation) | ✗ Missing | — |
| Programmatic conversation control (backend-driven queries) | ✗ Missing | — |
| Latency measurement (start, send, receive) | ✗ Missing | — |
| SDK capabilities document | ✗ Missing | — |

### What v1.5 Workflow Orchestrator Requires

The Node backend must:
1. Send research queries **with structured constraints** to Copilot (context injection)
2. **Parse structured JSON output** from Copilot responses (structured extraction)
3. **Maintain workflow state** (what data collected, what AI recommends next)
4. **Control conversation flow** based on Copilot's structured responses (orchestrator control)

All four capabilities are missing from the current integration.

---

## What to Build

### Phase A: SDK Capability Audit + Structured Output Extraction

**Goal:** Validate what structured data surfaces the SDK exposes and establish reliable extraction patterns.

**Tasks:**
1. Inspect `activity.value`, `activity.entities`, and `activity.channelData` on live Copilot responses
2. Test three extraction strategies:
   - Direct: `activity.value` contains a JSON object
   - Entity: `activity.entities` array contains typed payloads
   - Text-embedded: Bot returns text with a JSON block that can be extracted via regex/parse
3. Define `ExtractedPayload` Zod schema in `shared/src/schemas/orchestrator.ts`:
   ```typescript
   ExtractedPayloadSchema = z.object({
     type: z.enum(['structured', 'text', 'none']),
     data: z.unknown().optional(),     // parsed JSON from activity.value or entities
     raw: z.string().optional(),       // original text if no structured data found
     confidence: z.enum(['high', 'medium', 'low']), // high = activity.value, medium = entities, low = text-parse
   })
   ```
4. Extend `activityNormalizer` to populate `extractedPayload` on each `NormalizedMessage`
5. Measure and record baseline latency:
   - `startConversation()` round-trip (ms)
   - `sendMessage()` → first activity received (ms)
   - Full round-trip: request → response normalized (ms)

**Success criteria:**
- `activity.value`, `activity.entities`, and text-embedded JSON all tested with real Copilot responses (not mocked)
- `ExtractedPayload` schema validates all three surface types
- Latency numbers recorded in `spike/SDK-LATENCY.md`
- `activityNormalizer` extended; existing tests still pass

---

### Phase B: Context Injection + Multi-Turn State

**Goal:** Establish how to inject workflow metadata into outbound messages and verify the SDK handles multi-turn conversation state correctly for orchestrator use cases.

**Tasks:**
1. Implement **context injection pattern** in `server/src/routes/chat.ts`:
   ```typescript
   // WorkflowContext prepended to user message before sending
   interface WorkflowContext {
     step: string;                    // e.g. "collect-financials"
     constraints: Record<string, unknown>; // e.g. { timeRange: "2023-2025", format: "JSON" }
     collectedData?: Record<string, unknown>; // what we already have
   }

   function buildContextualMessage(userQuery: string, ctx: WorkflowContext): string {
     return `[CONTEXT: ${JSON.stringify(ctx)}]\n\n${userQuery}`;
   }
   ```
2. Test: verify injected context does **not** break the Copilot agent (send 3 test queries with context, compare responses to baseline)
3. Test: verify conversation state persists across 3+ turns — the SDK correctly chains conversation context
4. Test: what happens when `WorkflowContext` is large (>500 chars, >1000 chars)? Document limits.
5. Document: any agent-side configuration needed to handle injected context reliably

**Success criteria:**
- Context injection tested across ≥3 multi-turn conversations with real Copilot agent
- Conversation continuity confirmed (SDK chains turns without state loss)
- Context size limits documented
- `POST /api/chat/send` updated to accept optional `workflowContext` field in request body
- Shared schema updated: `SendMessageRequest` includes optional `workflowContext`

---

### Phase C: Orchestrator-Ready Infrastructure + SDK Evaluation

**Goal:** Wire everything together into server infrastructure ready for v1.5, and produce the SDK evaluation document.

**Tasks:**
1. Add `POST /api/chat/orchestrate` endpoint:
   - Accepts: `{ conversationId, query, workflowContext }`
   - Returns: `{ messages: NormalizedMessage[], extractedPayload: ExtractedPayload, latencyMs: number }`
   - This is the endpoint v1.5 will use for programmatic queries
2. Implement `WorkflowStateStore` extending `ConversationStore`:
   ```typescript
   interface WorkflowState {
     conversationId: string;
     currentStep: string;
     collectedData: Record<string, unknown>;
     lastRecommendation?: ExtractedPayload;
     turnCount: number;
   }
   ```
3. Write unit tests for:
   - `ExtractedPayload` extraction logic (all 3 surface types)
   - `buildContextualMessage()` (context format correctness)
   - `/api/chat/orchestrate` endpoint (mocked Copilot client)
4. Write `spike/SDK-EVALUATION.md`:

| Criterion | Result | Evidence |
|-----------|--------|---------|
| Structured output extraction | PASS/PARTIAL/FAIL | Which surfaces work |
| Context injection | PASS/PARTIAL/FAIL | Measured response quality |
| Conversation continuity | PASS/PARTIAL/FAIL | Turn count tested |
| Latency (start) | Xms | Measured in Phase A |
| Latency (send→response) | Xms | Measured in Phase A |
| Max context size | Xchars | Tested in Phase B |
| SDK limitations | List | Documented findings |
| GO recommendation for v1.5 | GO / CONDITIONAL GO | Based on above |

**Success criteria:**
- `/api/chat/orchestrate` endpoint implemented and tested
- `WorkflowStateStore` schema defined (in-memory implementation sufficient)
- `SDK-EVALUATION.md` complete with all rows filled from real measurements
- GO/CONDITIONAL GO recommendation with rationale documented
- All existing tests (normalizer, allowlist) still passing

---

## Requirements Summary

### Structured Output Extraction (SOUT)

- [ ] **SOUT-01**: Server can extract structured JSON from `activity.value` on Copilot responses
- [ ] **SOUT-02**: Server can extract structured JSON from `activity.entities` on Copilot responses
- [ ] **SOUT-03**: Server can parse embedded JSON from bot text responses (regex/JSON.parse fallback)
- [ ] **SOUT-04**: `ExtractedPayload` Zod schema validates all extraction surface types with confidence level
- [ ] **SOUT-05**: `activityNormalizer` populates `extractedPayload` on all NormalizedMessage instances
- [ ] **SOUT-06**: Existing normalizer unit tests continue to pass after extension

### Context Injection (CTX)

- [ ] **CTX-01**: `SendMessageRequest` schema accepts optional `workflowContext` (step, constraints, collectedData)
- [ ] **CTX-02**: Server injects `workflowContext` as structured prefix into outbound Copilot messages
- [ ] **CTX-03**: Context injection tested with live Copilot agent (≥3 turns) without breaking agent responses
- [ ] **CTX-04**: Context size limits documented with tested thresholds

### Orchestrator Infrastructure (ORCH)

- [ ] **ORCH-01**: `WorkflowState` type defined in shared schema (step, collectedData, lastRecommendation, turnCount)
- [ ] **ORCH-02**: `WorkflowStateStore` interface defined extending `ConversationStore`
- [ ] **ORCH-03**: `POST /api/chat/orchestrate` endpoint accepts query + workflowContext, returns messages + extractedPayload + latencyMs
- [ ] **ORCH-04**: Conversation continuity verified across ≥3 SDK turns (state not lost between turns)

### Performance Baseline (PERF)

- [ ] **PERF-01**: `startConversation()` latency measured and documented (≥5 samples, median reported)
- [ ] **PERF-02**: `sendMessage()` → first activity latency measured and documented (≥5 samples, median reported)
- [ ] **PERF-03**: Full round-trip (request → normalized response) latency measured and documented

### Evaluation (EVAL)

- [ ] **EVAL-01**: `spike/SDK-EVALUATION.md` created with all criteria filled from real measurements
- [ ] **EVAL-02**: GO / CONDITIONAL GO recommendation documented with rationale for v1.5 Workflow Orchestrator
- [ ] **EVAL-03**: Any agent-side configuration requirements documented (what Copilot Studio must return for structured output to work)

---

## Proposed Phase Structure

| Phase | Name | Requirements | Description |
|-------|------|-------------|-------------|
| N | SDK Capability Audit + Structured Extraction | SOUT-01–06, PERF-01–03 | ExtractedPayload schema, normalizer extension, latency measurement |
| N+1 | Context Injection + Multi-Turn Validation | CTX-01–04, ORCH-04 | WorkflowContext injection, multi-turn continuity testing |
| N+2 | Orchestrate Endpoint + Evaluation | ORCH-01–03, EVAL-01–03 | /api/chat/orchestrate, WorkflowStateStore, SDK-EVALUATION.md |

*Phase numbers continue from v1.2 (Phases 5–7 → v1.3b starts at Phase 8)*

---

## Constraints

- **Do NOT modify existing routes or normalizer in a breaking way** — v1.1 behavior must remain intact; all additions are additive
- **Do NOT mock Copilot responses** for structured output or context injection tests — must use the real Copilot Studio agent
- **Spike lives in `spike/`** — latency logs and evaluation docs go in `spike/`; production code changes go in `server/src/`
- **Phase budget: 3 phases maximum** — this is still a validation milestone, not full orchestrator implementation
- **All existing tests must continue to pass** — normalizer and allowlist tests must not regress

## Dependencies

- v1.2 (Entra External ID Auth) must be complete before v1.3b executes
- Requires the existing Copilot Studio agent used in dev (same agent as v1.0/v1.1)
- No new Azure infrastructure required (SDK connects directly to Copilot Studio)

## Risks

- **Structured output depends on agent configuration** — if the Copilot Studio agent is not configured to return structured JSON in `activity.value`, this becomes an agent configuration task, not a code task; EVAL-03 must surface this early
- **Context injection may confuse the agent** — if the agent treats the injected context as user input and responds to it conversationally, a different injection strategy (HTTP headers, custom channel data) must be explored
- **SDK version volatility** — `@microsoft/agents-copilotstudio-client` is at v1.1.1; check for updates at phase start, document breaking changes if any

## Success Criteria

1. All 19 requirements (SOUT-01–06, CTX-01–04, ORCH-01–04, PERF-01–03, EVAL-01–03) verified
2. `spike/SDK-EVALUATION.md` completed with real measured latency numbers (not estimates)
3. `ExtractedPayload` schema validated against real Copilot responses (not mocked)
4. `POST /api/chat/orchestrate` implemented, tested, and documented
5. GO / CONDITIONAL GO recommendation provides clear path for v1.5 planning
6. All v1.1 tests still passing

## Output Artifacts

| Artifact | Location | Purpose |
|----------|----------|---------|
| `ExtractedPayload` Zod schema | `shared/src/schemas/orchestrator.ts` | Type-safe structured output |
| Extended normalizer | `server/src/normalizer/activityNormalizer.ts` | Populates extractedPayload |
| Orchestrate endpoint | `server/src/routes/orchestrate.ts` | v1.5 integration point |
| WorkflowState types | `shared/src/schemas/orchestrator.ts` | Orchestrator state shape |
| Latency log | `spike/SDK-LATENCY.md` | Measured performance numbers |
| SDK evaluation | `spike/SDK-EVALUATION.md` | GO/NO-GO for v1.5 |
