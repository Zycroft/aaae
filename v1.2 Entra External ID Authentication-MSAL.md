# v1.2 Milestone Prompt — Entra External ID Authentication (MSAL)

## Priority: P0 (Blocking — all subsequent milestones depend on user identity)

## Context

This is a React + Express monorepo (`client/`, `server/`, `shared/`) that provides a chat UI backed by Microsoft Copilot Studio. The current codebase (v1.1) has **stub authentication only**: the server checks that an `Authorization` header exists but does not validate it. The client sends no auth tokens at all.

The target architecture (`p1.1 flow architecture.md`) requires:
1. Users sign in via **Entra External ID (CIAM)** using MSAL React
2. The client acquires a JWT access token and attaches it to every API call
3. The server validates the JWT (signature, audience, issuer, expiry)
4. The server checks the user's organization/tenant against an **Org Allowlist**
5. Unauthorized or disallowed-org users receive clear 401/403 responses

## What to Build

### Client Authentication (MSAL React)

- Add `@azure/msal-browser` and `@azure/msal-react` to `client/`
- Create `client/src/auth/msalConfig.ts` with CIAM-specific configuration:
  - Authority: `https://{tenant}.ciamlogin.com/{tenant}.onmicrosoft.com`
  - Known authorities for CIAM
  - Redirect URI matching Azure app registration
  - Scopes: `api://{server-app-id}/Chat.ReadWrite` (custom scope exposed by server app reg)
- Wrap `<App>` in `<MsalProvider instance={msalInstance}>`
- Create an `<AuthGuard>` component that:
  - Shows a sign-in button/redirect for unauthenticated users
  - Acquires tokens silently on mount (`acquireTokenSilent`, fallback to `acquireTokenRedirect`)
  - Renders children only when authenticated
  - Handles token refresh transparently
- Update `client/src/api/chatApi.ts` to attach `Authorization: Bearer {token}` on every fetch call
- Add a sign-out button to the UI (clear MSAL cache, redirect)
- Store NO tokens in localStorage manually — let MSAL handle caching

### Server JWT Validation

- Add `jsonwebtoken` and `jwks-rsa` to `server/` (for validating Entra External ID tokens)
- Replace the stub in `server/src/middleware/auth.ts` with real validation:
  - Extract Bearer token from Authorization header
  - Fetch JWKS from `https://{tenant}.ciamlogin.com/{tenant}.onmicrosoft.com/discovery/v2.0/keys`
  - Verify signature, audience (`api://{server-app-id}`), issuer, and expiry
  - Attach decoded claims to `req.user` for downstream use
  - Return 401 with `WWW-Authenticate` header on failure
- Cache JWKS keys with appropriate TTL (jwks-rsa handles this)

### Org Allowlist

- After JWT validation, extract the `tid` (tenant ID) claim from the token
- Check against an allowlist configured via environment variable: `ALLOWED_TENANT_IDS=tid1,tid2,...`
- Return 403 with a clear error message for disallowed tenants
- Log denied access attempts (tenant ID, timestamp) for security auditing
- This is a second middleware step after JWT validation, not a replacement

### Shared Schema Updates

- Add user identity types to `shared/src/schemas/auth.ts`:
  - `UserClaims` schema: `{ sub, tid, email?, name?, oid }`
  - Export TypeScript type for server-side `req.user`
- No Zod added to shared — use existing Zod instance for new schemas

### Environment Configuration

- New server env vars:
  - `AZURE_TENANT_NAME` — CIAM tenant name (e.g., `contoso`)
  - `AZURE_CLIENT_ID` — Server app registration client ID (audience)
  - `ALLOWED_TENANT_IDS` — Comma-separated allowlist
- New client env vars:
  - `VITE_AZURE_CLIENT_ID` — Client app registration client ID
  - `VITE_AZURE_TENANT_NAME` — CIAM tenant name
  - `VITE_AZURE_REDIRECT_URI` — Redirect URI (default: window.location.origin)
- Update `.env.example` files for both workspaces
- Fail-closed: server refuses all requests if `AZURE_CLIENT_ID` is not set (same pattern as existing `config.ts`)

## Constraints

- **Do NOT use `@azure/msal-node` OBO flow yet** — that's for calling downstream APIs as the user. For v1.2, the server only validates the incoming token; it calls Copilot Studio with its own credentials (existing pattern).
- **Do NOT remove the existing `AUTH_REQUIRED` toggle** — keep it for local development without Azure AD. When `AUTH_REQUIRED=false`, skip JWT validation entirely (existing behavior). When `true`, require real JWT validation.
- The existing `COPILOT_STUB_TOKEN` can remain for the Copilot SDK connection — it's separate from user auth.
- All MSAL configuration values must come from environment variables, never hardcoded.
- CI must continue to pass — update security checks if needed.

## Success Criteria

1. Unauthenticated users see a sign-in page, not the chat UI
2. After sign-in, the chat functions identically to v1.1 (no regression)
3. Server rejects requests with expired, invalid-signature, or wrong-audience tokens (401)
4. Server rejects requests from tenants not in the allowlist (403)
5. `AUTH_REQUIRED=false` still works for local dev without Azure AD setup
6. Sign-out clears session and returns to sign-in page
7. Token refresh happens silently — users don't get logged out mid-conversation
8. New env vars documented in `.env.example` files
9. Unit tests for JWT validation middleware (mock JWKS, test expired/invalid/valid tokens)
10. Unit tests for Org Allowlist middleware

## Dependencies

- Azure app registrations (one for client SPA, one for server API) must exist in Entra External ID tenant — this is infrastructure, not code
- No code dependencies on other milestones

## Risks

- Entra External ID CIAM has different authority URLs than standard Entra ID — use `ciamlogin.com`, not `login.microsoftonline.com`
- MSAL React's `InteractionStatus` can cause rendering loops if `<AuthGuard>` is not carefully implemented — test the redirect flow thoroughly
- JWKS key rotation: ensure the key cache has a reasonable TTL (jwks-rsa defaults are fine)
